<!DOCTYPE HTML>

<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <meta name="description" content="The Nature Conservancy's resilient lands mapping tool to assess the resilience of natural landscapes to climate change">

    <!-- TODO  change NOINDEX NOFOLLWO to INDEX FOLLOW on production site!! -->
    <meta name="ROBOTS" content="INDEX, FOLLOW">

    <title>Resilient Land Mapping Tool</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.36/esri/css/esri.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href= "https://js.arcgis.com/3.36/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" media="print" href="css/print.css" />
    <link rel="stylesheet" href="css/app.css">
    <!--[if IE]><html class="ie"><![endif]-->
    <!--[if !IE]> -->
    <link rel="stylesheet" href="css/fileupload.css">
    <!-- <![endif]-->

    <!-- Load d3.js -->
    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/PowerGauge.js" ></script>


    <link rel="shortcut icon" href="assets/favicon.ico" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
	<script src="https://js.arcgis.com/3.36/"></script>
	<script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments);};i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m);
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-52921921-1', 'auto');
            ga('send', 'pageview');
	</script>

    <script>
        var ie;
        var map;
        var graphic;
        var currLocation;
        var watchId;
        var toc;
        var shape; //this is a global variable for the shape returned from Portal

        //use this var as a prefix to any variable you want to make global
        var app = {};
        var updateMessage = "";

        require([
            "esri/config",
            "esri/InfoTemplate",
            "esri/map",
            "esri/dijit/Basemap",
            "esri/dijit/BasemapToggle",
            "esri/dijit/BasemapLayer",
            "esri/dijit/BasemapGallery",
            "esri/dijit/Search",
            "esri/dijit/Print",
            "esri/tasks/PrintTemplate",
            "esri/toolbars/draw",
            "esri/geometry/Extent",
            "esri/graphic",
            "esri/graphicsUtils",
            "esri/layers/ArcGISTiledMapServiceLayer",
            "esri/layers/ArcGISDynamicMapServiceLayer",
            "esri/layers/ArcGISImageServiceLayer",
            "esri/layers/ImageServiceParameters",
            "esri/layers/ImageParameters",
            "esri/request",
            "esri/geometry/scaleUtils",
            "esri/geometry/Point",
            "esri/tasks/Geoprocessor",
            "esri/tasks/FeatureSet",
            "esri/tasks/IdentifyTask",
            "esri/tasks/IdentifyParameters",
            "esri/tasks/LegendLayer",
            "esri/config",
            "esri/layers/FeatureLayer",
            "esri/renderers/SimpleRenderer",
            "esri/symbols/PictureMarkerSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/dijit/LocateButton",
            "esri/dijit/Legend",
            "esri/dijit/Popup",
            "esri/dijit/PopupTemplate",
            "esri/renderers/ClassBreaksRenderer",
            "esri/dijit/Scalebar",
            "dojo/dom",
            "dojo/_base/connect",
            "dojo/json",
            "dojo/on",
            "dojo/parser",
            "dojo/sniff",
            "dojo/_base/array",
            "dojox/charting/Chart",
            "dojox/charting/plot2d/Pie",
            "dojox/charting/themes/PlotKit/green",
            "dojox/charting/action2d/Tooltip",
            "dojox/charting/action2d/MoveSlice",
            "esri/Color",
            "dojo/_base/lang",
            "dijit/registry",
            "dijit/Dialog",
            "dojo/string",
            "dojo/dom-construct",
            "dojo/ready",
            "dojo/text!./geoDicts.json",
            "dojo/text!./reports.json",
            "dijit/layout/BorderContainer",
            "dijit/layout/ContentPane",
            "dijit/layout/AccordionContainer",

            "dojo/fx",
            "dojo/domReady!"
        ],

//Set up and initialize******************************************
        function (esriConfig, InfoTemplate, Map, Basemap, BasemapToggle, BasemapLayer, BasemapGallery, Search, Print, PrintTemplate, Draw, Extent, Graphic, graphicsUtils, ArcGISTiledMapServiceLayer, ArcGISDynamicMapServiceLayer, ArcGISImageServiceLayer,
        ImageServiceParameters, ImageParameters, request, scaleUtils, Point, Geoprocessor, FeatureSet, IdentifyTask, IdentifyParameters, LegendLayer, esriConfig, FeatureLayer,
        SimpleRenderer, PictureMarkerSymbol, SimpleFillSymbol, SimpleLineSymbol, SimpleMarkerSymbol, LocateButton, Legend, Popup, PopupTemplate, ClassBreaksRenderer, Scalebar,
        dom, connect, JSON, on, parser, sniff, arrayUtils, Chart, Pie, theme,  Tooltip, MoveSlice,  Color, lang, registry, Dialog, string, domConstruct, ready, geoDicts, reports, BorderContainer, ContentPane,AccordionContainer, fx, domReady )
        {
            ready(function(){
            parser.parse();
            app.geoDicts = dojo.eval("[" + geoDicts + "]")[0];
            app.reports = dojo.eval("[" + reports + "]")[0];
            app.gp = new esri.tasks.Geoprocessor("https://cumulus.tnc.org/arcgis/rest/services/easterndiv/RL_ResilienceScore_Apr22/GPServer/RL_ResilienceScore");
            app.gpUploadURL = "https://cumulus.tnc.org/arcgis/rest/services/easterndiv/RL_ResilienceScore_Apr22/GPServer/uploads/upload";
            app.gpFS = new esri.tasks.Geoprocessor("https://cumulus.tnc.org/arcgis/rest/services/easterndiv/RL_ResilienceScoreFS_Apr22/GPServer/RL_ResilienceScoreFS");

            app.gp.setUpdateDelay(500); //status check in milliseconds
            app.gpFS.setUpdateDelay(500); //status check in milliseconds
            app.gpFS.setOutputSpatialReference({wkid: 102100});
            app.drawActive = 0;
            app.printIterator = 0;
            app.regionState = "Region";




            //test if running on Google Chrome -- if so, disable geolocate button, since it won't work unless on HTTPS and
            //we can't use HTTPS on an Amazon S3 bucket
            // from http://stackoverflow.com/questions/4565112/javascript-how-to-find-out-if-the-user-browser-is-chrome/13348618#13348618

            var isChromium = window.chrome,
                winNav = window.navigator,
                vendorName = winNav.vendor,
                isOpera = winNav.userAgent.indexOf("OPR") > -1,
                isIEedge = winNav.userAgent.indexOf("Edge") > -1,
                isIOSChrome = winNav.userAgent.match("CriOS");
                // console.log(vendorName);
            if(isIOSChrome){
               // is Google Chrome on IOS
               app.useGeolocate = false;
            } else if(isChromium !== null && isChromium !== undefined && vendorName === "Google Inc." && isOpera === false && isIEedge === false) {
               // is Google Chrome
               app.useGeolocate = false;
            } else {
               // not Google Chrome
               app.useGeolocate = true;
            }

            app.isMobile = false; //initiate as false
            // device detection
            if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
                || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) {
                app.isMobile = true;
            }
            app.splashMobile ="";
            if (app.isMobile === true){
                console.log("Mobile");
                app.splashMobile = "<h3 style='text-align:center'>The Resilient Land Mapping Tool was not designed for use on a mobile device.  You may continue to use the tool but the page may not render properly.</h3>";
            }


      	    app.resultDialog = new Dialog({
      	    	id: "resultDialog",
      	        title: "Area of Interest Summary",
                      class: "noPrint",
      	        style: {
                          width : "760px",
                          height: "800px",
                          maxWidth: "760px",
                          overflow: "auto"
      	        }
      	    });

            var splashDialog = new Dialog({
                id: "splashDialog",
                disableCloseButton: true,
                style: {
                    width : "800px",
                    height : "750px",
                    color : "black",
                    overflow: "auto"
                }
      	    });

            var gpStartDialog = new Dialog({
                title: "Your Analysis Has Begun",
                id: "gpStartDialog",
                disableCloseButton: false,
                style: {
                    width : "250px",
                    height : "175px",
                    color : "black"
                }
      	    });

            var gpIndigenousErrorDialog = new Dialog({
               title: "Indigenous land overlap",
                id: "gpIndigenousErrorDialog",
                disableCloseButton: false,
                style: {
                    width : "250px",
                    height : "175px",
                    color : "black"
                }
            });

            var gpSizeErrorDialog = new Dialog({
               title: "Polygon too large",
                id: "gpSizeErrorDialog",
                disableCloseButton: false,
                style: {
                    width : "250px",
                    height : "175px",
                    color : "black"
                }
            });

            app.showCarbCaveats = true;
            var carbonCaveatDialog = new Dialog({
               title: "Forest Carbon Stock",
                id: "carbonCaveatDialog",
                disableCloseButton: false,
                style: {
                    width : "250px",
                    height : "235px",
                    color : "black"
                }
            });

            //setup expand panels
            var expandPanels = document.getElementsByClassName("collapsible");
            for (i = 0; i < expandPanels.length; i++) {
                expandPanels[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                // console.log(this.nextElementSibling)
                if (content.style.maxHeight){
                  content.style.maxHeight = null;
                } else {
                  content.style.maxHeight = content.scrollHeight + "px";
                }

                if (this.title.includes("carbon")){
                  // console.log(this.title)

                  var conusWarning = "Carbon data is only available for the contiguous 48 states.<br><br>"
                  var carbonCavText = conusWarning + "The estimates of 2050 forest carbon stock and sequestration project forest growth into the future absent major disturbances and do not account for potentially improved management practices nor increases in the frequency and severity of climatic disturbances."
                  var carbonCavButtons =   "<table align=\"center\">" +"<tr align=\"center\">" +"<td align=\"center\" colspan=\"2\">" +"<button data-dojo-type=\"dijit.form.Button\" type=\"button\"" +"data-dojo-props=\"onClick:function(){dijit.byId('carbonCaveatDialog').hide();}\">OK</button>" +"</td>"+"</tr>" +"</table>" ;
                  var carbonCavContent = carbonCavText + "<br><br>" + carbonCavButtons;
                  carbonCaveatDialog.set("content", carbonCavContent)
                  if (app.showCarbCaveats === true){
                    carbonCaveatDialog.show()
                    app.showCarbCaveats = false
                  }
                }

          }, false);
      };

            //hide the JPEG legend that's used for the geophysical settings
            $("#legendJPEG").hide();

            //set up CORS
            esriConfig.defaults.io.corsEnabledServers.push("maspatial.tnc.org");
            esriConfig.defaults.io.corsEnabledServers.push("cumulus.tnc.org");
            esriConfig.defaults.io.corsEnabledServers.push("maps.tnc.org");
            esriConfig.defaults.io.corsEnabledServers.push("localhost");
            esriConfig.defaults.io.corsEnabledServers.push("*.arcgis.com");
            esriConfig.defaults.io.proxyURL="/proxy/";
            var legendDijit;

            var portalUrl = "https://www.arcgis.com";
            var identifyTask, identifyParams, identifyGrid;
            //symbology for sketched parcel
            var polyParcel =new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
              new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                new Color([240,59,32]), 2), new Color([240,59,32, 0.05]));




            var clickMode = "identify";
            var identifyListener;
            var tb;
            var currentScale;
            var statusCallbackIterator = 0; //post an alert on the first status callback

            map = new Map("map", {
                basemap: "topo",
                center: [-82, 50],
                zoom: 4,
                slider: true,
                infoWindow: popup
            });

            //Geolocate
            if (app.useGeolocate === true){
                geoLocate = new LocateButton({
                    map: map
                }, "LocateButton");
                geoLocate.startup();
            }

//            var geocoders = [{
//                url: "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",
//                name: "Esri Geocoder",
//                singleLineFieldName: "Single Line Input",
//            }];
//            var search = new Geocoder({
//                map: map,
//                geocoders: geocoders,
//                arcgisGeocoder: true
//              },"search");
//              search.startup();

            var search = new Search({
                map: map
            }, "search");
            search.startup();


            //Set up the switch to toggle between region data (natioanlly consistent) and state data
            $("#regionSwitch").on('change', function() {
                if ($(this).is(':checked')) {
                    switchStatus = $(this).is(':checked');
                    app.regionState = "State";
                    getResData();
                    // console.log(app.regionState);// To verify
                }
                else {
                   switchStatus = $(this).is(':checked');
                   app.regionState = "Region";
                   getResData();
                   // console.log(app.regionState);// To verify
                }
            });

            //hide the secured lands slider until the layer is turned on
            $('#secTransp').hide();

            //get tiled map layers
            var resTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Resilience_CONUS_Tiles_Apr22/MapServer", {visible: true});
            var resTilesState = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Resilience_State_Tiles_Apr22/MapServer", {visible: false});
            var resTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Resilience_HI_Tiles_Apr22/MapServer", {visible: true});
            var resTilesAK =  new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Resilience_AK_Tiles_Apr22/MapServer", {visible: true});

            var landDivTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_LD_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var landDivTilesState = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_LD_State_Tiles_Apr22/MapServer", {visible: false});
            var landDivTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_LD_HI_Tiles_Apr22/MapServer", {visible: false});
            var landDivTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_LD_AK_Tiles_Apr22/MapServer", {visible: false});


            var localConnTiles =new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_LC_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var localConnTilesState =new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_LC_State_Tiles_Apr22/MapServer", {visible: false});
            var localConnTilesHI =new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_LC_HI_Tiles_Apr22/MapServer", {visible: false});
            var localConnTilesAK =new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_LC_AK_Tiles_Apr22/MapServer", {visible: false});


            var resConnSimpTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ResilientConnectedSimple_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var resConnSimpTilesState = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ResilientConnectedSimple_STATE_Tiles_Apr22/MapServer", {visible: false});
            var resConnSimpTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ResilientConnectedSimple_HI_Tiles_Apr22/MapServer", {visible: false});
            var resConnSimpTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ResilientConnectedSimple_AK_Tiles_Apr22/MapServer", {visible: false});

            var resConnDetTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ResilientConnectedDetailed_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var resConnDetTilesState = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ResilientConnectedDetailed_STATE_Tiles_Apr22/MapServer", {visible: false});
            var resConnDetTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ResilientConnectedDetailed_HI_Tiles_Apr22/MapServer", {visible: false});
            var resConnDetTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ResilientConnectedDetailed_AK_Tiles_Apr22/MapServer", {visible: false});

            var cliFlowTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ClimateFlow_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var cliFlowTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ClimateFlow_HI_Tiles_Apr22/MapServer", {visible: false});
            var cliFlowTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ClimateFlow_AK_Tiles_Apr22/MapServer", {visible: false});

            var cliFlowCatTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ClimateFlowCategorized_Tiles_July20/MapServer", {visible: false});
            var cliFlowCatTilesState = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ClimateFlowCategorized_State_Tiles_Apr22/MapServerr", {visible: false});
            var cliFlowCatTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ClimateFlowCategorized_HI_Tiles_Apr22/MapServer", {visible: false});
            var cliFlowCatTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ClimateFlowCategorized_AK_Tiles_Apr22/MapServer", {visible: false});


            var elevTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Elevation_Tiles_Apr20/MapServer", {visible: false});
            var elevTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Elevation_HI_Tiles_Apr22/MapServer", {visible: false});
            var elevTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Elevation_AK_Tiles_Apr22/MapServer", {visible: false});

            var rbvSingleTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_RBV_Single_Tiles_July20/MapServer", {visible: false});
            var rbvSingleTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_RBV_Single_HI_Tiles_Apr22/MapServer", {visible: false});
            var rbvSingleTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_RBV_Single_AK_Tiles_Apr22/MapServer", {visible: false});


            var rbvCatTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_RBV_4Cat_Tiles_July20/MapServer", {visible: false});
            var rbvCatTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_RBV_4Cat_HI_Tiles_Apr22/MapServer", {visible: false});
            var rbvCatTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_RBV_4Cat_AK_Tiles_Apr22/MapServer", {visible: false});

            var regionTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_StudyRegion_Tiles_Apr21/MapServer", {visible: false});
            var regionTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_StudyRegion_HI_Tiles_Apr22/MapServer", {visible: false});
            var regionTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_StudyRegion_AK_Tiles_Apr22/MapServer", {visible: false});

            var landformTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Landforms_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var landformTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Landforms_HI_Tiles_Apr22/MapServer", {visible: false});
            var landformTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_Landforms_AK_Tiles_Apr22/MapServer", {visible: false});

            var geoTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_GeologySoils_Tiles_July20/MapServer", {visible: false});
            var geoTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_GeoSoils_HI_Tiles_Apr22/MapServer", {visible: false});
            var geoTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_GeoSoils_AK_Tiles_Apr22/MapServer", {visible: false});


            var tidalHabMigTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_TidalHabMig_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var tidalHabMigTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_TidalHabMig_HI_Tiles_Apr22/MapServer", {visible: false});
            var tidalHabMigTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_TidalHabMig_AK_Tiles_Apr22/MapServer", {visible: false});


            //carbon layers
            var nlcdTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_NLCD2019_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var forestCarbon2010Tiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ForestCarbon2010_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var forestCarbon2050Tiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ForestCarbon2050_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var forestCarbonSeqTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ForestCarbonSequestration_CONUS_Tiles_Apr22/MapServer", {visible: false});
            var forestTypeTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_ForestTypes_CONUS_Tiles_Apr22/MapServer", {visible: false});

            var soilCarbonTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_SoilCarbon_CONUS_Tiles_Apr22/MapServer", {visible: false});

            var securedAreasTiles = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_SecuredLand_Apr21/MapServer", {visible: false});
            var securedAreasTilesHI = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_SecuredLand_HI_Tiles_Apr22/MapServer", {visible: false});
            var securedAreasTilesAK = new ArcGISTiledMapServiceLayer("https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_SecuredLand_AK_Tiles_Apr22/MapServer", {visible: false});

            var dynamicGridURL = "https://cumulus.tnc.org/arcgis/rest/services/easterndiv/RL_dynamicGrids_Apr22/MapServer";
//            var dynamicGridURL = "http://maspatial.tnc.org/arcgis/rest/services/Resilience/RL_dynamicGrids_Apr21/MapServer";


            //set Image Parameters to access map service sublayers.  LAYER_OPTION_SHOW only includes the listed layer
            var resGridIPs = new ImageParameters();
            resGridIPs.layerIds = [0];
            resGridIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resGridStateIPs = new ImageParameters();
            resGridStateIPs.layerIds = [16];
            resGridStateIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resGridHIIPs = new ImageParameters();
            resGridHIIPs.layerIds = [44];
            resGridHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resGridAKIPs = new ImageParameters();
            resGridAKIPs.layerIds = [30];
            resGridAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var landDivIPs = new ImageParameters();
            landDivIPs.layerIds = [1];
            landDivIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var landDivStateIPs = new ImageParameters();
            landDivStateIPs.layerIds = [17];
            landDivStateIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var landDivHIIPs = new ImageParameters();
            landDivHIIPs.layerIds = [45];
            landDivHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var landDivAKIPs = new ImageParameters();
            landDivAKIPs.layerIds = [31];
            landDivAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var localConnIPs = new ImageParameters();
            localConnIPs.layerIds = [2];
            localConnIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var localConnStateIPs = new ImageParameters();
            localConnStateIPs.layerIds = [18];
            localConnStateIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var localConnHIIPs = new ImageParameters();
            localConnHIIPs.layerIds = [46];
            localConnHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var localConnAKIPs = new ImageParameters();
            localConnAKIPs.layerIds = [32];
            localConnAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var resConnSimpIPs = new ImageParameters();
            resConnSimpIPs.layerIds = [5];
            resConnSimpIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resConnSimpStateIPs = new ImageParameters();
            resConnSimpStateIPs.layerIds = [20];
            resConnSimpStateIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resConnSimpHIIPs = new ImageParameters();
            resConnSimpHIIPs.layerIds = [49];
            resConnSimpHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resConnSimpAKIPs = new ImageParameters();
            resConnSimpAKIPs.layerIds = [35];
            resConnSimpAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var resConnDetIPs = new ImageParameters();
            resConnDetIPs.layerIds = [25];
            resConnDetIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resConnDetStateIPs = new ImageParameters();
            resConnDetStateIPs.layerIds = [26];
            resConnDetStateIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resConnDetHIIPs = new ImageParameters();
            resConnDetHIIPs.layerIds = [50];
            resConnDetHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var resConnDetAKIPs = new ImageParameters();
            resConnDetAKIPs.layerIds = [36];
            resConnDetAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var geoIPs = new ImageParameters();
            geoIPs.layerIds = [3];
            geoIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var geoHIIPs = new ImageParameters();
            geoHIIPs.layerIds = [47];
            geoHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var geoAKIPs = new ImageParameters();
            geoAKIPs.layerIds = [33];
            geoAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var capnwGeoIPs = new ImageParameters();
            capnwGeoIPs.layerIds = [12];
            capnwGeoIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;


            var landformIPs = new ImageParameters();
            landformIPs.layerIds = [4];
            landformIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var landformHIIPs = new ImageParameters();
            landformHIIPs.layerIds = [48];
            landformHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var landformAKIPs = new ImageParameters();
            landformAKIPs.layerIds = [34];
            landformAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var cliFlowIPs = new ImageParameters();
            cliFlowIPs.layerIds = [9];
            cliFlowIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var cliFlowHIIPs = new ImageParameters();
            cliFlowHIIPs.layerIds = [52];
            cliFlowHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var cliFlowAKIPs = new ImageParameters();
            cliFlowAKIPs.layerIds = [38];
            cliFlowAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var cliFlowCatIPs = new ImageParameters();
            cliFlowCatIPs.layerIds = [10];
            cliFlowCatIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var cliFlowCatStateIPs = new ImageParameters();
            cliFlowCatStateIPs.layerIds = [19];
            cliFlowCatStateIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var cliFlowCatHIIPs = new ImageParameters();
            cliFlowCatHIIPs.layerIds = [53];
            cliFlowCatHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var cliFlowCatAKIPs = new ImageParameters();
            cliFlowCatAKIPs.layerIds = [39];
            cliFlowCatAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;


            var elevIPs = new ImageParameters();
            elevIPs.layerIds = [11];
            elevIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var elevHIIPs = new ImageParameters();
            elevHIIPs.layerIds = [54];
            elevHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var elevAKIPs = new ImageParameters();
            elevAKIPs.layerIds = [40];
            elevAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var tidalHabMigIPs = new ImageParameters();
            tidalHabMigIPs.layerIds = [27];
            tidalHabMigIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var tidalHabMigHIIPs = new ImageParameters();
            tidalHabMigHIIPs.layerIds = [58];
            tidalHabMigHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var tidalHabMigAKIPs = new ImageParameters();
            tidalHabMigAKIPs.layerIds = [59];
            tidalHabMigAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var rbvSingleIPs = new ImageParameters();
            rbvSingleIPs.layerIds = [13];
            rbvSingleIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var rbvSingleHIIPs = new ImageParameters();
            rbvSingleHIIPs.layerIds = [55];
            rbvSingleHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var rbvSingleAKIPs = new ImageParameters();
            rbvSingleAKIPs.layerIds = [41];
            rbvSingleAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var rbvCatIPs = new ImageParameters();
            rbvCatIPs.layerIds = [14];
            rbvCatIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var rbvCatHIIPs = new ImageParameters();
            rbvCatHIIPs.layerIds = [56];
            rbvCatHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var rbvCatAKIPs = new ImageParameters();
            rbvCatAKIPs.layerIds = [42];
            rbvCatAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            // state and ecoregional reference layers
            var ecoregionIPs = new ImageParameters();
            ecoregionIPs.layerIds = [6];
            ecoregionIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var stateIPs = new ImageParameters();
            stateIPs.layerIds = [7];
            stateIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var securedAreaIPs = new ImageParameters();
            securedAreaIPs.layerIds = [8];
            securedAreaIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var securedAreaHIIPs = new ImageParameters();
            securedAreaHIIPs.layerIds = [51];
            securedAreaHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var securedAreaAKIPs = new ImageParameters();
            securedAreaAKIPs.layerIds = [37];
            securedAreaAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var tribalLandIPs = new ImageParameters();
            tribalLandIPs.layerIds = [21];
            tribalLandIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            //carbon layers
            var nlcdIPs = new ImageParameters();
            nlcdIPs.layerIds = [22];
            nlcdIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var forestCarbon2010IPs = new ImageParameters();
            forestCarbon2010IPs.layerIds = [23];
            forestCarbon2010IPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var forestCarbon2050IPs = new ImageParameters();
            forestCarbon2050IPs.layerIds = [28];
            forestCarbon2050IPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var forestCarbonSeqIPs = new ImageParameters();
            forestCarbonSeqIPs.layerIds = [29];
            forestCarbonSeqIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var soilCarbonIPs = new ImageParameters();
            soilCarbonIPs.layerIds = [24];
            soilCarbonIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var forestTypeIPs = new ImageParameters();
            forestTypeIPs.layerIds = [60];
            forestTypeIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;



            var regionIPs = new ImageParameters();
            regionIPs.layerIds = [15];
            regionIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var regionHIIPs = new ImageParameters();
            regionHIIPs.layerIds = [57];
            regionHIIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
            var regionAKIPs = new ImageParameters();
            regionAKIPs.layerIds = [43];
            regionAKIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;

            var ecoregions = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": ecoregionIPs});
            var states = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": stateIPs});
            var securedAreasDyn = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": securedAreaIPs});
            var securedAreasDynHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": securedAreaHIIPs});
            var securedAreasDynAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": securedAreaAKIPs});


            app.tribalLands = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": tribalLandIPs});

            var resGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resGridIPs});
            var resGridState = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resGridStateIPs});
            var resGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resGridHIIPs});
            var resGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resGridAKIPs});

            var landDivGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": landDivIPs});
            var landDivGridState = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": landDivStateIPs});
            var landDivGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": landDivHIIPs});
            var landDivGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": landDivAKIPs});

            var localConnGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": localConnIPs});
            var localConnGridState = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": localConnStateIPs});
            var localConnGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": localConnHIIPs});
            var localConnGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": localConnAKIPs});

            var cliFlowGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": cliFlowIPs});
            var cliFlowGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": cliFlowHIIPs});
            var cliFlowGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": cliFlowAKIPs});

            var cliFlowCatGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": cliFlowCatIPs});
            var cliFlowCatGridState = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": cliFlowCatStateIPs});
            var cliFlowCatGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": cliFlowCatHIIPs});
            var cliFlowCatGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": cliFlowCatAKIPs});

            var resConnSimpGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resConnSimpIPs});
            var resConnSimpGridState = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resConnSimpStateIPs});
            var resConnSimpGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resConnSimpHIIPs});
            var resConnSimpGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resConnSimpAKIPs});

            var resConnDetGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resConnDetIPs});
            var resConnDetGridState = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resConnDetStateIPs});
            var resConnDetGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resConnDetHIIPs});
            var resConnDetGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": resConnDetAKIPs});

            var geoGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": geoIPs});
            var capnwGeoGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": capnwGeoIPs});
            var geoGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": geoHIIPs});
            var geoGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": geoAKIPs});

            var landformGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": landformIPs});
            var landformGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": landformHIIPs});
            var landformGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": landformAKIPs});

            var elevGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": elevIPs});
            var elevGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": elevHIIPs});
            var elevGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": elevAKIPs});

            var rbvSingleGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": rbvSingleIPs});
            var rbvSingleGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": rbvSingleHIIPs});
            var rbvSingleGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": rbvSingleAKIPs});

            var rbvCatGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": rbvCatIPs});
            var rbvCatGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": rbvCatHIIPs});
            var rbvCatGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": rbvCatAKIPs});

            var regionGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": regionIPs});
            var regionGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": regionHIIPs});
            var regionGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": regionAKIPs});

            var tidalHabMigGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": tidalHabMigIPs});
            var tidalHabMigGridHI = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": tidalHabMigHIIPs});
            var tidalHabMigGridAK = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": tidalHabMigAKIPs});

        //carbonLayers
            var nlcdGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": nlcdIPs});
            var forestCarbon2010Grid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": forestCarbon2010IPs});
            var forestCarbon2050Grid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": forestCarbon2050IPs});
            var forestCarbonSeqGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": forestCarbonSeqIPs});
            var forestTypeGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": forestTypeIPs});
            var soilCarbonGrid = new ArcGISDynamicMapServiceLayer(dynamicGridURL, {visible: false, "imageParameters": soilCarbonIPs});

            app.ecoregionsVisible = true;
            app.statesVisible = false;
            app.securedVisible = false;

            //order impacts print legend
            app.mapLayers = [resTiles, resTilesHI, resTilesAK, resGrid, resGridHI, resGridAK, resTilesState, resGridState, landDivTiles, landDivTilesHI, landDivTilesAK, landDivGrid, landDivGridHI, landDivGridAK, landDivTilesState, landDivGridState, localConnTiles, localConnTilesHI, localConnTilesAK, localConnGrid, localConnGridHI, localConnGridAK, localConnTilesState, localConnGridState, geoTiles, geoTilesHI, geoTilesAK, geoGrid, geoGridHI, geoGridAK, capnwGeoGrid, landformTiles, landformTilesHI, landformTilesAK, landformGrid, landformGridHI, landformGridAK, resConnSimpTiles, resConnSimpTilesHI, resConnSimpTilesAK, resConnSimpGrid, resConnSimpGridHI, resConnSimpGridAK, resConnSimpTilesState, resConnSimpGridState, resConnDetTiles, resConnDetTilesHI, resConnDetTilesAK, resConnDetGrid, resConnDetGridHI, resConnDetGridAK, resConnDetTilesState, resConnDetGridState, cliFlowTiles, cliFlowTilesHI, cliFlowTilesAK, cliFlowGrid, cliFlowGridHI, cliFlowGridAK, cliFlowCatTiles, cliFlowCatTilesHI, cliFlowCatTilesAK, cliFlowCatGrid, cliFlowCatGridHI, cliFlowCatGridAK, cliFlowCatTilesState, cliFlowCatGridState, tidalHabMigTiles, tidalHabMigTilesHI, tidalHabMigTilesAK, tidalHabMigGrid, tidalHabMigGridHI, tidalHabMigGridAK, nlcdTiles, nlcdGrid, forestCarbon2010Tiles, forestCarbon2010Grid, forestCarbon2050Tiles, forestCarbon2050Grid, forestCarbonSeqTiles, forestCarbonSeqGrid, soilCarbonTiles, soilCarbonGrid, rbvSingleTiles, rbvSingleTilesHI, rbvSingleTilesAK, rbvSingleGrid, rbvSingleGridHI, rbvSingleGridAK, rbvCatTiles, rbvCatTilesHI, rbvCatTilesAK, rbvCatGrid, rbvCatGridHI, rbvCatGridAK, securedAreasDyn, securedAreasDynHI, securedAreasDynAK, securedAreasTiles, securedAreasTilesHI, securedAreasTilesAK, elevTiles, elevTilesHI, elevTilesAK, elevGrid, elevGridHI, elevGridAK, regionTiles, regionTilesHI, regionTilesAK, regionGrid, regionGridHI, regionGridAK, app.tribalLands, ecoregions, states, forestTypeTiles, forestTypeGrid];

            map.addLayers(app.mapLayers);
            // console.log(map)
            map.on("load", initFunc);
            var popup = new Popup({
                fillSymbol: new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                  new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                    new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.25]))

            }, domConstruct.create("div"));


        function initFunc() {
                //Idenitfy
                activateIdentify();
                identifyRes = new IdentifyTask(dynamicGridURL);
                identifyParams = new IdentifyParameters();
                identifyParams.tolerance = 3;
                identifyParams.returnGeometry = true;
                identifyParams.layerIds = [0];
                identifyParams.layerOption = IdentifyParameters.LAYER_OPTION_ALL;
                identifyParams.width = map.width;
                identifyParams.height = map.height;

                //initialize the draw tool
                tb = new Draw(map);
                dojo.connect(tb, "onDrawEnd", addParcelGraphic);
                app.sketchButton = (dojo.byId("Polygon"));
                dojo.connect(app.sketchButton,"click", function(){
                    if (app.drawActive === 0){
                        // console.log(app.drawActive);
                        tb.activate(esri.toolbars.Draw.POLYGON);
                        app.drawActive = 1;
                        clickMode = "draw";
                        activateIdentify();
                        app.sketchButton.style.background = "#000000";
                        clearUserPolygons();

                    }
                   else if (app.drawActive === 1){
                        tb.deactivate();
                        app.drawActive = 0;
                        map.enableMapNavigation();
                        clickMode = "identify";
                        activateIdentify();
                        app.sketchButton.style.background = "#666666";
                   }
                });

                currentScale = map.getScale();

                //figure out where the map is panned to.  THen won't show layers if not there
                app.mapZones = []
                dojo.connect(map, "onExtentChange", showExtent);
                function showExtent(extent) {
                  // console.log(extent)
                  if (extent.ymax > 6626587 && extent.xmin <-14363824 ){
                    if(app.mapZones.indexOf("AK") == -1){app.mapZones.push("AK")}
                  }
                  else{
                    app.mapZones= app.mapZones.filter(item => item !== "AK")
                  }

                  if (extent.ymin < 2535042 && extent.xmin <-17043745 ){
                    if(app.mapZones.indexOf("HI") == -1){app.mapZones.push("HI")}
                  }
                  else{
                    app.mapZones= app.mapZones.filter(item => item !== "HI")
                  }
                  if (extent.ymax > 280408 && extent.ymin <6922534 && extent.xmin <-6654203 && extent.xmax >-13875235){
                    if(app.mapZones.indexOf("CONUS") == -1){app.mapZones.push("CONUS")}
                  }
                  else{
                    app.mapZones= app.mapZones.filter(item => item !== "CONUS")
                  }
                  // console.log(app.mapZones)
                }


                //Format text for Dialog
                var splashHeader = string.substitute("<h2 align=\"center\">Welcome to the Resilient Land Mapping Tool</h2>");
                var splashImage = '<table align="center"><tr align="center"><td align="center"><a href="http://www.conservationgateway.org/ConservationByGeography/NorthAmerica/UnitedStates/edc/reportsdata/terrestrial/resilience/Pages/Downloads.aspx" target="_blank"><img src="assets/cover.jpg" alt="Terrestrial Resilience" width="300px" border="2" style="border-color:black;"  ></a></td></tr></table>';
                var splashConcepts = '<p>Visit the <a href="coreConcepts.html" target="_blank">Core Concepts</a> page for a quick explanation of the data and results from this project. This mapping application and the data within it were developed with grant funding from the <a href="http://www.ddcf.org/" target="blank">Doris Duke Charitable Foundation</a>. In addition, recent improvements to our landscape connectivity modeling tools (Circuitscape) were funded through grants from NASA’s Ecological Forecasting Program and the Wilburforce Foundation.</p>';
                var splashCaveats = '<p><em>Resilient lands and waters shown on this map may be conserved by a wide range of measures from good land stewardship, to other forms of private land conservation, to outright fee or easement acquisition by various levels of government.</em></p>';
                var splashLegal ='<p id="splashLegal1"><strong>By entering this site, you agree to the terms outlined below and in the <a href="http://www.nature.org/about-us/governance/terms-of-use/index.htm?src=f9" target="_blank">Legal Disclosures</a> and <a href="http://www.nature.org/about-us/governance/privacy-policy.xml?src=f6" target="_blank">Privacy Statement</a>.</strong></p>';
                var splashLegal2 = '<p id="splashLegal2"> This data is designed to be used as a screening-level tool that can be used to help inform conservation decisions. These products are not intended to be a replacement for site-specific knowledge nor a prescription for on-the-ground action. Every commercially reasonable effort has been made to assure the accuracy of the map and data. However, the data being provided herein are intended for informational purposes only. No guarantee is made as to the accuracy of data and they should not be relied upon for any purpose other than general information. <br><br> DISCLAIMERS AND LIMITATION OF LIABILITY. ALL CONTENT ON THE WEBSITE IS PROVIDED TO YOU ON AN "AS IS" "AS AVAILABLE" BASIS WITHOUT WARRANTY OF ANY KIND EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NON-INFRINGEMENT. THE NATURE CONSERVANCY MAKES NO WARRANTY AS TO THE ACCURACY, COMPLETENESS OR RELIABILITY OF ANY CONTENT AVAILABLE THROUGH THE WEBSITE. YOU ARE RESPONSIBLE FOR VERIFYING ANY INFORMATION BEFORE RELYING ON IT. USE OF THE WEBSITE AND THE CONTENT AVAILABLE ON THE WEBSITE IS AT YOUR SOLE RISK.</p>';
                var splashAgree = '<p align="center"><strong>Do you agree to the terms and restrictions described above?</strong></p>';
                var splashTribalPassword = '<h3>Indigenous Lands</h3><p>This analysis was conducted throughout the continental United States and southern Canada using publicly available data and quantitative analysis. However, the results have not yet been reviewed by members of the sovereign indigenous nations of the area. While we solicit review, we have greyed-out the indigenous lands (<a href="coreConcepts_indigenous.html" target="_blank">US Census Bureau 2017, Government of Canada 2017</a>) on the resilience datasets.  Please enter the password to access results on indigenous lands:' +
                        '</p><table align="center"><tr align="center"><td align="center"><input type="text" placeholder="Indigenous Land Password" id="tribalPassword" onkeyup="if (event.keyCode ===13){console.log(event); document.getElementById(\'enterBtn\').click();}"></td></tr></table>' +
                        '<p>For more information or to request access to the data on these lands please contact <a href="mailto:crcs@tnc.org">crcs@tnc.org</a>.</p>';

                var splashButtons =   "<div><table align=\"center\">" +
                                    "<tr align=\"center\">" +
                                "<td align=\"center\" colspan=\"2\">" +
                                    "<button id='enterBtn' data-dojo-type=\"dijit.form.Button\" type=\"button\"" +
                                        "data-dojo-props=\"onClick:function(){\n\
                                            if (document.getElementById('tribalPassword').value === 'nature'){\n\
                                                app.loggedIn = true;\n\
                                                app.tribalLands.setVisibility(false)\n\
                                            } \n\
                                            else{\n\
                                                app.loggedIn = false;\n\
                                                app.tribalLands.setVisibility(true)\n\
                                            }\n\
                                            dijit.byId('splashDialog').hide();\n\
                                        }\">Enter</button>" +
                                    "<button data-dojo-type=\"dijit.form.Button\" type=\"button\" "+
                                        "data-dojo-props=\"onClick:function(){window.open('http://www.nature.org', '_self');}\">Decline</button>" +
                                "</td>"+
                            "</tr>" +
                        "</table></div>" ;

                var content = splashHeader + app.splashMobile + splashImage + splashConcepts + splashCaveats +"<hr>" + splashTribalPassword + "<hr>" + splashLegal + splashLegal2 + splashButtons;

                splashDialog.set("content", content);
                splashDialog.show();
                var pword = document.getElementById("tribalPassword");
                pword.type = "password";

                dojo.style(dijit.byId("splashDialog").closeButtonNode,"display","none");


                //set up GP warning Dialog
                var gpStartText = "It will take 30-90 seconds to run, depending on your inputs.  You may continue to use the map in the meantime. Thanks for your patience.";
                var gpStartButtons =   "<table align=\"center\">" +"<tr align=\"center\">" +"<td align=\"center\" colspan=\"2\">" +"<button data-dojo-type=\"dijit.form.Button\" type=\"button\"" +"data-dojo-props=\"onClick:function(){dijit.byId('gpStartDialog').hide();}\">OK</button>" +"</td>"+"</tr>" +"</table>" ;
                var gpStartContent = gpStartText + "<br><br>" + gpStartButtons;
                gpStartDialog.set("content", gpStartContent);

                //set up indigenous lands gp error dialog
                var gpErrorText = "The polygon entered overlaps indigenous lands. Pending a review of these data with tribal representatives, the areas assessed in an analysis must not overlap with indigenous lands unless you are logged in.  Please contact <a href='mailto:crcs@tnc.org'>crcs@tnc.org</a> for more information or to request access or enter a new polygon.";
                var gpErrorButtons =   "<table align=\"center\">" +"<tr align=\"center\">" +"<td align=\"center\" colspan=\"2\">" +"<button data-dojo-type=\"dijit.form.Button\" type=\"button\"" +"data-dojo-props=\"onClick:function(){dijit.byId('gpIndigenousErrorDialog').hide();}\">OK</button>" +"</td>"+"</tr>" +"</table>" ;
                var gpErrorContent = gpErrorText + "<br><br>" + gpErrorButtons;
                gpIndigenousErrorDialog.set("content", gpErrorContent);

                //set up size gp error dialog
                var gpSizeErrorText = "The polygon entered is too large. Please enter a new polygon that is less than 10,000 square miles.";
                var gpSizeErrorButtons =   "<table align=\"center\">" +"<tr align=\"center\">" +"<td align=\"center\" colspan=\"2\">" +"<button data-dojo-type=\"dijit.form.Button\" type=\"button\"" +"data-dojo-props=\"onClick:function(){dijit.byId('gpSizeErrorDialog').hide();}\">OK</button>" +"</td>"+"</tr>" +"</table>" ;
                var gpSizeErrorContent = gpSizeErrorText + "<br><br>" + gpSizeErrorButtons;
                gpSizeErrorDialog.set("content", gpSizeErrorContent);



                //Set up legend
                map.on("layers-add-result", function (evt) {
                    var layerInfo = arrayUtils.map(evt.layers, function (layer, index) {
//                        console.log(layer.layer.name)
                       if (layer.layer.name === "Indigenous lands"){
                            return {layer:layer.layer, title:" "};
                       }
                       else{
                            return {layer:layer.layer, title:" "};
                       }
                    });
                    if (layerInfo.length > 0) {
                    legendDijit = new Legend({
                        map: map,
                        layerInfos: layerInfo
                    }, "legendDiv");
                    legendDijit.startup();
                    }
                });

                //Get scale -- if resGridTiled is turned on & zoomed in beyond tile scale range, switch to resgrid (dyn)
                map.on("extent-change", function(evt){
                    getResData();
                });

            }


//Helper functions*******************************
            function numberWithCommas(x) {
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            function isInt(n) {
               return n % 1 === 0;
            }


            //round floats to 2 decimals
            function roundNumber(val, dec){
                let nVal
                if(isNaN(val) === false){
                    if (dec >0){
                      if (dec == 1){var rNum = 10}
                      else if (dec == 2){rNum = 100}
                      else if (dec == 3){rNum = 1000}
                      else if (dec == 4){rNum = 10000}
                      else{rNum = 10}
                      nVal = parseFloat(val);
                      nVal=Math.round((nVal + 0.0000001)*rNum)/rNum;
                    }
                    else{
                      nVal = parseFloat(val);
                      nVal=Math.round(nVal);
                    }
                    return nVal;
                }
            }

            //when it's visible (after GP service) show result dialog if button clicked
            window.showResultDialog = function(){
                app.resultDialog.show();
            };

            window.clearUserPolygons = function(){
                clearUserPolygons();
            };

            // window popup for SD definition
            window.windowPopup = function(mylink, windowname){
                if (! window.focus)return true;
                    var href;
                if (typeof(mylink) === 'string')
                    href=mylink;
                else
                    href=mylink.href;
                    winPop = window.open(href, windowname, 'width=1000,height=500,scrollbars=yes');
                    winPop.moveTo(400, 200);
                    return false;
            };

            function clearUserPolygons(){
                map.graphics.clear();
                if (shape){map.removeLayer(shape);} //this is an uploaded shp
            }

            //bin scores into categories
            function binScores(value){
                if (value >0){aboveBelow = "above";}
                else{aboveBelow = "below";}
                if (value < -2.000){var categ = "Far Below Average";}
                else if (value >= -2.000 && value <-1.000)  {var categ = "Below Average";}
                else if (value >= -1.000 && value <-0.500)  {var categ = "Slightly Below Average";}
                else if (value >= -0.500 && value <0.500)  {var categ = "Average";}
                else if (value >= 0.500 && value <1.000)  {var categ = "Slightly Above Average";}
                else if (value >= 1.000 && value <2.000)  {var categ = "Above Average";}
                else if (value >= 2.000)  {var categ = "Far Above Average";}
                return categ;
            }
            function binScoresCAPNW(value){
                if (value >0){aboveBelow = "above";}
                else{aboveBelow = "below";}
                if (value <-0.840)  {var categ = "Less ";}
                else if (value >= -0.840 && value <-0.255)  {var categ = "Slightly Less";}
                else if (value >= -0.255 && value <0.255)  {var categ = "Moderate";}
                else if (value >= 0.255 && value <0.840)  {var categ = "Slightly More";}
                else if (value >= 0.840)  {var categ = "More";}
                return categ;
            }

            function compareValues(key, order='asc'){
              return function innerSort(a, b) {
                if (!a.hasOwnProperty(key) || !b.hasOwnProperty(key)) {
                  // property doesn't exist on either object
                  return 0;
                }

                const varA = (typeof a[key] === 'string')
                  ? a[key].toUpperCase() : a[key];
                const varB = (typeof b[key] === 'string')
                  ? b[key].toUpperCase() : b[key];

                let comparison = 0;
                if (varA > varB) {
                  comparison = 1;
                } else if (varA < varB) {
                  comparison = -1;
                }
                return (
                  (order === 'desc') ? (comparison * -1) : comparison
                );
              };
            }

            function addSort(k){
                if (k === "Far Above Average"){var n = 1;}
                if (k === "Above Average"){var n = 2;}
                if (k === "Slightly Above Average"){var n = 3;}
                if (k === "Average"){var n = 4;}
                if (k === "Slightly Below Average"){var n = 5;}
                if (k === "Below Average"){var n = 6;}
                if (k === "Far Below Average"){var n = 7;}
                if (k === "Developed"){var n = 8;}
                if (k === "Far Above Average Flow"){var n = 1;}
                if (k === "Above Average Flow"){var n = 2;}
                if (k === "Slightly Above Average Flow"){var n = 3;}
                if (k === "Average Flow"){var n = 4;}
                if (k === "Slightly Below Average Flow"){var n = 5;}
                if (k === "Below Average Flow"){var n = 6;}
                if (k === "Far Below Average Flow"){var n = 7;}
                if (k === "Glacier"){var n = 8;}
                if (k === "Pioneer Lava"){var n = 8;}
                if (k === "Developed"){var n = 9;}
                return n
            }




//End helper functions*******************************

//User map service functions**************************************

            document.getElementById('addMapServButton').onclick = function() {
                if (app.userMapLayer){map.removeLayer(app.userMapLayer);}
                var userURL = document.getElementById("userMapServ").value;
                userLayer = userURL.substr(userURL.lastIndexOf('/') + 1);
                // console.log(userLayer);
                // console.log(userURL);
                //if (userLayer === parseInt(userLayer, 10)){
                if (isNaN(userLayer) === false){
                    // console.log("User entered layer " + userLayer);
                    var userIPs = new ImageParameters();
                    userIPs.layerIds = [userLayer];
                    userIPs.layerOption = ImageParameters.LAYER_OPTION_SHOW;
                    shortUserURL = userURL.substring(0,userURL.lastIndexOf("/"));
                    if (userURL.indexOf("FeatureServer") !== -1){
                            // console.log("FeatureServer");
                            app.userMapLayer = new FeatureLayer(userURL);
                            map.addLayer(app.userMapLayer);
                    }

                    else{
                        app.userMapLayer = new ArcGISDynamicMapServiceLayer(shortUserURL, {visible: true, "imageParameters": userIPs});
                        map.addLayer(app.userMapLayer);
                    }
                }
                else if (userURL.indexOf("ImageServer") !== -1){
                  // console.log("ImageServer");
                  var params = new ImageServiceParameters();
                  app.userMapLayer = new ArcGISImageServiceLayer(userURL, {
                    imageServiceParameters: params,
                    opacity: 0.75
                  });
                  map.addLayer(app.userMapLayer);
                }
                else if (userURL.indexOf("tiles") !== -1){
                  // console.log("TileServer");
                  var params = new ImageServiceParameters();
                  app.userMapLayer = new ArcGISTiledMapServiceLayer(userURL);
                  map.addLayer(app.userMapLayer);
                }
                else{
                    console.log(userURL);
                    app.userMapLayer = new FeatureLayer(userURL);
                    map.addLayer(app.userMapLayer);
                }

            };

            document.getElementById('removeMapServButton').onclick = function() {
                map.removeLayer(app.userMapLayer);
                document.getElementById("userMapServ").value = "";
            };

//Endser map service functions**************************************

//Map functions**************************************

            //set up handler for radio buttons
            document.getElementById('r1_resil').checked=true;
            document.getElementById('r1_LD').onclick = getResData;
            document.getElementById('r1_LC').onclick = getResData;
            document.getElementById('r1_resil').onclick = getResData;
            document.getElementById('r1_geo').onclick = getResData;
            document.getElementById('r1_base').onclick = getResData;
            document.getElementById('r1_landforms').onclick = getResData;
            document.getElementById('r1_resConnSimp').onclick = getResData;
            document.getElementById('r1_resConnDet').onclick = getResData;
            document.getElementById('r1_cliFlow').onclick = getResData;
            document.getElementById('r1_cliFlowCat').onclick = getResData;
            document.getElementById('r1_elev').onclick = getResData;
            document.getElementById('r1_rbvSingle').onclick = getResData;
            document.getElementById('r1_rbvCat').onclick = getResData;
            document.getElementById('r1_region').onclick = getResData;
            document.getElementById('r1_forestCarbon2010').onclick = getResData;
            document.getElementById('r1_forestCarbon2050').onclick = getResData;
            document.getElementById('r1_forestCarbonSeq').onclick = getResData;
            document.getElementById('r1_forestType').onclick = getResData;
            document.getElementById('r1_soilCarbon').onclick = getResData;
            document.getElementById('r1_nlcd').onclick = getResData;
            document.getElementById('r1_tidalHabMig').onclick = getResData;

            function getResData() {
                currentScale = map.getScale();


                // console.log('Scale: ' + currentScale);
                if (currentScale >=4622324.434309){
                    if (basemapGallery.getSelected() === landformsBasemap){
                        // console.log("landforms zoomed out");
                    }
                }

                if (document.getElementById('r1_resil').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    if(app.loggedIn === true){app.tribalLands.setVisibility(false); $("#indigLink").hide()}
                    else{app.tribalLands.setVisibility(true);}
                    app.legendLayer = "res";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){resTilesHI.setVisibility(true); app.legendLayerID = "layer1";}
                        else{resGridHI.setVisibility(true); app.legendLayerID = "layer4";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){resTilesAK.setVisibility(true); app.legendLayerID = "layer2";}
                        else{resGridAK.setVisibility(true); app.legendLayerID = "layer5";}
                      }
                      if (zone == "CONUS"){
                        if (app.regionState === "Region"){
                            if (currentScale >= 288895.277144){resTiles.setVisibility(true);app.legendLayerID = "layer0";}
                            else{resGrid.setVisibility(true); app.legendLayerID = "layer3";}
                        }
                        if (app.regionState === "State"){
                            if (currentScale >= 288895.277144){resTilesState.setVisibility(true); app.legendLayerID = "layer6";}
                            else{resGridState.setVisibility(true); app.legendLayerID = "layer7";}
                        }
                      }
                    });
                    updatePrintTitle();

                }

               else if (document.getElementById('r1_LD').checked){
               	    $("#legendDiv").show();
                    $("#legendJPEG").hide();

                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "landDiv";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){landDivTilesHI.setVisibility(true); app.legendLayerID = "layer9";}
                        else{landDivGridHI.setVisibility(true); app.legendLayerID = "layer12";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){landDivTilesAK.setVisibility(true); app.legendLayerID = "layer10";}
                        else{landDivGridAK.setVisibility(true); app.legendLayerID = "layer13";}
                      }
                      if (zone == "CONUS"){
                        if (app.regionState === "Region"){
                            if (currentScale >= 288895.277144){landDivTiles.setVisibility(true); app.legendLayerID = "layer8";}
                            else{landDivGrid.setVisibility(true); app.legendLayerID = "layer11";}
                        }
                        if (app.regionState === "State"){
                            if (currentScale >= 288895.277144){landDivTilesState.setVisibility(true); app.legendLayerID = "layer14";}
                            else{landDivGridState.setVisibility(true); app.legendLayerID = "layer15";}
                        }
                      }
                    });
                    updatePrintTitle();
                }


                else if (document.getElementById('r1_LC').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "localConn";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){localConnTilesHI.setVisibility(true); app.legendLayerID = "layer17";}
                        else{localConnGridHI.setVisibility(true); app.legendLayerID = "layer20";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){localConnTilesAK.setVisibility(true); app.legendLayerID = "layer18";}
                        else{localConnGridAK.setVisibility(true); app.legendLayerID = "layer21";}
                      }
                      if (zone == "CONUS"){
                        if (app.regionState === "Region"){
                            if (currentScale >= 288895.277144){localConnTiles.setVisibility(true); app.legendLayerID = "layer16";}
                            else{localConnGrid.setVisibility(true); app.legendLayerID = "layer19";}
                        }
                        if (app.regionState === "State"){
                            if (currentScale >= 288895.277144){localConnTilesState.setVisibility(true); app.legendLayerID = "layer22";}
                            else{localConnGridState.setVisibility(true); app.legendLayerID = "layer23";}
                        }
                      }
                    });
                    updatePrintTitle();

                }


                else if (document.getElementById('r1_geo').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
//                    $("#legendJPEG").css("display", "block");
//                    $("#legendJPEG").css("margin", "0 auto");
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "geo";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){geoTilesHI.setVisibility(true); app.legendLayerID = "layer25";}
                        else{geoGridHI.setVisibility(true); app.legendLayerID = "layer28";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){geoTilesAK.setVisibility(true); app.legendLayerID = "layer26";}
                        else{geoGridAK.setVisibility(true); app.legendLayerID = "layer29";}
                      }
                      if (zone == "CONUS"){
                        if (currentScale >= 288895.277144){geoTiles.setVisibility(true); app.legendLayerID = "layer24";}
                        else{
                            geoGrid.setVisibility(true);
                            app.legendLayerID = "layer27";
                            //also CA & PNW
                            capnwGeoGrid.setVisibility(true);
                        }
                      }
                    });
                    updatePrintTitle();

                }


                else if (document.getElementById('r1_landforms').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "landforms";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){landformTilesHI.setVisibility(true); app.legendLayerID = "layer32";}
                        else{landformGridHI.setVisibility(true); app.legendLayerID = "layer35";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){landformTilesAK.setVisibility(true); app.legendLayerID = "layer33";}
                        else{landformGridAK.setVisibility(true); app.legendLayerID = "layer36";}
                      }
                      if (zone == "CONUS"){
                        if (currentScale >= 288895.277144){landformTiles.setVisibility(true); app.legendLayerID = "layer31";}
                        else{landformGrid.setVisibility(true); app.legendLayerID = "layer34";}
                      }
                    });
                    updatePrintTitle();

                }

                else if (document.getElementById('r1_tidalHabMig').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "tidalHab";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){tidalHabMigTilesHI.setVisibility(true); app.legendLayerID = "layer68";}
                        else{tidalHabMigGridHI.setVisibility(true); app.legendLayerID = "layer71";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){tidalHabMigTilesAK.setVisibility(true); app.legendLayerID = "layer69";}
                        else{tidalHabMigGridAK.setVisibility(true); app.legendLayerID = "layer72";}
                      }
                      if (zone == "CONUS"){
                        if (currentScale >= 288895.277144){tidalHabMigTiles.setVisibility(true); app.legendLayerID = "layer67";}
                        else{tidalHabMigGrid.setVisibility(true); app.legendLayerID = "layer70";}
                      }
                    });
                    updatePrintTitle();

                }


                else if (document.getElementById('r1_resConnSimp').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    if(app.loggedIn === true){app.tribalLands.setVisibility(false);}
                    else{app.tribalLands.setVisibility(true);}
                    app.legendLayer = "resConnSimp";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        console.log(zone)
                        if (currentScale >= 288895.277144){resConnSimpTilesHI.setVisibility(true); app.legendLayerID = "layer38";}
                        else{resConnSimpGridHI.setVisibility(true); app.legendLayerID = "layer41";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){resConnSimpTilesAK.setVisibility(true); app.legendLayerID = "layer39";}
                        else{resConnSimpGridAK.setVisibility(true); app.legendLayerID = "layer42";}
                      }
                      if (zone == "CONUS"){
                        if (app.regionState === "Region"){
                            if (currentScale >= 288895.277144){resConnSimpTiles.setVisibility(true); app.legendLayerID = "layer37";}
                            else{resConnSimpGrid.setVisibility(true); app.legendLayerID = "layer40";}
                        }
                        if (app.regionState === "State"){
                            if (currentScale >= 288895.277144){resConnSimpTilesState.setVisibility(true); app.legendLayerID = "layer43";}
                            else{resConnSimpGridState.setVisibility(true); app.legendLayerID = "layer44";}
                        }
                      }
                    });
                    updatePrintTitle();

                }

                else if (document.getElementById('r1_resConnDet').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    if(app.loggedIn === true){app.tribalLands.setVisibility(false);}
                    else{app.tribalLands.setVisibility(true);}
                    app.legendLayer = "resConnDet";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){resConnDetTilesHI.setVisibility(true); app.legendLayerID = "layer46";}
                        else{resConnDetGridHI.setVisibility(true); app.legendLayerID = "layer49";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){resConnDetTilesAK.setVisibility(true); app.legendLayerID = "layer47";}
                        else{resConnDetGridAK.setVisibility(true); app.legendLayerID = "layer50";}
                      }
                      if (zone == "CONUS"){
                        if (app.regionState === "Region"){
                            if (currentScale >= 288895.277144){resConnDetTiles.setVisibility(true); app.legendLayerID = "layer45";}
                            else{resConnDetGrid.setVisibility(true); app.legendLayerID = "layer48";}
                        }
                        if (app.regionState === "State"){
                            if (currentScale >= 288895.277144){resConnDetTilesState.setVisibility(true); app.legendLayerID = "layer51";}
                            else{resConnDetGridState.setVisibility(true); app.legendLayerID = "layer52";}
                        }
                      }
                    });
                    updatePrintTitle();
                }

                 else if (document.getElementById('r1_cliFlow').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "cliFlow";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){cliFlowTilesHI.setVisibility(true); app.legendLayerID = "layer54";}
                        else{cliFlowGridHI.setVisibility(true); app.legendLayerID = "layer57";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){cliFlowTilesAK.setVisibility(true); app.legendLayerID = "layer55";}
                        else{cliFlowGridAK.setVisibility(true); app.legendLayerID = "layer58";}
                      }
                      if (zone == "CONUS"){
                        if (app.regionState === "Region"){
                            if (currentScale >= 288895.277144){cliFlowTiles.setVisibility(true); app.legendLayerID = "layer53";}
                            else{cliFlowGrid.setVisibility(true); app.legendLayerID = "layer56";}
                        }
                        if (app.regionState === "State"){
                            if (currentScale >= 288895.277144){cliFlowTiles.setVisibility(true); app.legendLayerID = "layer53";}
                            else{cliFlowGrid.setVisibility(true); app.legendLayerID = "layer56";}
                        }
                      }
                    });
                    updatePrintTitle();
                }

                else if (document.getElementById('r1_cliFlowCat').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "cliFlow";


                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){cliFlowCatTilesHI.setVisibility(true); app.legendLayerID = "layer60";}
                        else{cliFlowCatGridHI.setVisibility(true); app.legendLayerID = "layer63";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){cliFlowCatTilesAK.setVisibility(true); app.legendLayerID = "layer61";}
                        else{cliFlowCatGridAK.setVisibility(true); app.legendLayerID = "layer64";}
                      }
                      if (zone == "CONUS"){
                        if (app.regionState === "Region"){
                            if (currentScale >= 288895.277144){cliFlowCatTiles.setVisibility(true); app.legendLayerID = "layer59";}
                            else{cliFlowCatGrid.setVisibility(true); app.legendLayerID = "layer62";}
                        }
                        if (app.regionState === "State"){
                            if (currentScale >= 288895.277144){cliFlowCatTilesState.setVisibility(true); app.legendLayerID = "layer65";}
                            else{cliFlowCatGridState.setVisibility(true); app.legendLayerID = "layer66";}
                        }
                      }
                    });
                    updatePrintTitle();
                }

               else if (document.getElementById('r1_elev').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "elev";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){elevTilesHI.setVisibility(true); app.legendLayerID = "layer102";}
                        else{elevGridHI.setVisibility(true); app.legendLayerID = "layer105";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){elevTilesAK.setVisibility(true); app.legendLayerID = "layer103";}
                        else{elevGridAK.setVisibility(true); app.legendLayerID = "layer106";}
                      }
                      if (zone == "CONUS"){
                        if (currentScale >= 288895.277144){elevTiles.setVisibility(true); app.legendLayerID = "layer101";}
                        else{elevGrid.setVisibility(true); app.legendLayerID = "layer104";}
                      }
                    });
                    updatePrintTitle();
                }

                else if (document.getElementById('r1_rbvSingle').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "rbvSingle";
                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){rbvSingleTilesHI.setVisibility(true); app.legendLayerID = "layer84";}
                        else{rbvSingleGridHI.setVisibility(true); app.legendLayerID = "layer87";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){rbvSingleTilesAK.setVisibility(true); app.legendLayerID = "layer85";}
                        else{rbvSingleGridAK.setVisibility(true); app.legendLayerID = "layer88";}
                      }
                      if (zone == "CONUS"){
                        if (currentScale >= 288895.277144){rbvSingleTiles.setVisibility(true); app.legendLayerID = "layer83";}
                        else{rbvSingleGrid.setVisibility(true); app.legendLayerID = "layer86";}
                      }
                    });
                    updatePrintTitle();
                }

                else if (document.getElementById('r1_rbvCat').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "rbvCat";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){rbvCatTilesHI.setVisibility(true); app.legendLayerID = "layer90";}
                        else{rbvCatGridHI.setVisibility(true); app.legendLayerID = "layer93";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){rbvCatTilesAK.setVisibility(true); app.legendLayerID = "layer91";}
                        else{rbvCatGridAK.setVisibility(true); app.legendLayerID = "layer94";}
                      }
                      if (zone == "CONUS"){
                        if (currentScale >= 288895.277144){rbvCatTiles.setVisibility(true); app.legendLayerID = "layer89";}
                        else{rbvCatGrid.setVisibility(true); app.legendLayerID = "layer92";}
                      }
                    });
                    updatePrintTitle();
                }

                else if (document.getElementById('r1_region').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }

                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "region";

                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){regionTilesHI.setVisibility(true); app.legendLayerID = "layer108";}
                        else{regionGridHI.setVisibility(true); app.legendLayerID = "layer111";}
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){regionTilesAK.setVisibility(true); app.legendLayerID = "layer109";}
                        else{regionGridAK.setVisibility(true); app.legendLayerID = "layer112";}
                      }
                      if (zone == "CONUS"){
                        if (currentScale >= 288895.277144){regionTiles.setVisibility(true); app.legendLayerID = "layer107";}
                        else{regionGrid.setVisibility(true); app.legendLayerID = "layer110";}
                      }
                    });
                    updatePrintTitle();
                }


                else if (document.getElementById('r1_nlcd').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    if (currentScale >= 288895.277144){nlcdTiles.setVisibility(true); app.legendLayerID = "layer73";}
                    else{nlcdGrid.setVisibility(true); app.legendLayerID = "layer74";}
                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "nlcd";
                    updatePrintTitle();
                }

                else if (document.getElementById('r1_forestCarbon2010').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    if (currentScale >= 288895.277144){forestCarbon2010Tiles.setVisibility(true); app.legendLayerID = "layer75";}
                    else{forestCarbon2010Grid.setVisibility(true); app.legendLayerID = "layer76";}
                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "forCarb2010";
                    updatePrintTitle();
                }
                else if (document.getElementById('r1_forestCarbon2050').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    if (currentScale >= 288895.277144){forestCarbon2050Tiles.setVisibility(true); app.legendLayerID = "layer77";}
                    else{forestCarbon2050Grid.setVisibility(true); app.legendLayerID = "layer78";}
                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "forestCarb2050";
                    updatePrintTitle();
                }
                else if (document.getElementById('r1_forestCarbonSeq').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    if (currentScale >= 288895.277144){forestCarbonSeqTiles.setVisibility(true); app.legendLayerID = "layer79";}
                    else{forestCarbonSeqGrid.setVisibility(true); app.legendLayerID = "layer80";}
                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "forestCarbSeq";
                    updatePrintTitle();
                }
                else if (document.getElementById('r1_forestType').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    if (currentScale >= 288895.277144){forestTypeTiles.setVisibility(true); app.legendLayerID = "layer79";}
                    else{forestTypeGrid.setVisibility(true); app.legendLayerID = "layer80";}
                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "forestType";
                    updatePrintTitle();
                }
                else if (document.getElementById('r1_soilCarbon').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    if (currentScale >= 288895.277144){soilCarbonTiles.setVisibility(true); app.legendLayerID = "layer81";}
                    else{soilCarbonGrid.setVisibility(true); app.legendLayerID = "layer82";}
                    app.tribalLands.setVisibility(false);
                    app.legendLayer = "soilCarbon";
                    updatePrintTitle();
                }

                else if (document.getElementById('r1_base').checked){
                    $("#legendDiv").show();
                    $("#legendJPEG").hide();
                    for (var i = 0; i < app.mapLayers.length; i++){
                        app.mapLayers[i].setVisibility(false);
                    }
                    app.legendLayer = "base";
                    updatePrintTitle();
                }

                if (currentScale <=577790.554289){
                    document.getElementById("securedCheck").disabled = false;
                    $("#securedCheckLink").css("color", "#336699");
                }
                else{
                    document.getElementById("securedCheck").disabled = false;
//                    $("#securedCheckLink").css("color", "gray");
                }
                refreshReferenceLayers();

            }


            var slider = document.getElementById('transp');
            slider.oninput = function(){
                var val = (this.value)/100;
                for (var i = 0; i < app.mapLayers.length; i++){

                    app.mapLayers[i].setOpacity(val);
                    $('#legendImg').css('opacity', val);
                };
                ecoregions.setOpacity(1);
                app.tribalLands.setOpacity(1);
                states.setOpacity(1);
                securedAreasDyn.setOpacity(document.getElementById('secTransp').value);
                securedAreasTiles.setOpacity(document.getElementById('secTransp').value);
//                legendDijit.refresh();
            };

            slider.onchange = function(){
               var val = (this.value)/100;
               for (var i = 0; i < app.mapLayers.length; i++){
                    app.mapLayers[i].setOpacity(val);
               };
               ecoregions.setOpacity(1);
               app.tribalLands.setOpacity(1);
               states.setOpacity(1);
               securedAreasDyn.setOpacity(document.getElementById('secTransp').value);
               securedAreasTiles.setOpacity(document.getElementById('secTransp').value);
               legendDijit.refresh();
            };

            //user layer transp
            var userSlider = document.getElementById('userLayerTransp');
            userSlider.oninput = function(){
                var val = (this.value)/100;
                app.userMapLayer.setOpacity(val);
            };

            userSlider.onchange = function(){
              var val = (this.value)/100;
              app.userMapLayer.setOpacity(val);
            };






            var securedSlider = document.getElementById('secTransp');
            securedSlider.oninput = function(){
                var val = (this.value)/100;


                app.mapZones.forEach((zone, i) => {
                  if (zone == "HI"){
                    securedAreasDynHI.setOpacity(val);
                    securedAreasTilesHI.setOpacity(val);
                  }
                  if (zone == "AK"){
                    securedAreasDynAK.setOpacity(val);
                    securedAreasTilesAK.setOpacity(val);
                  }
                  if (zone == "CONUS"){
                    securedAreasDyn.setOpacity(val);
                    securedAreasTiles.setOpacity(val);
                  }
                });
            };
            securedSlider.onchange = function(){
                var val = (this.value)/100;
                app.mapZones.forEach((zone, i) => {
                  if (zone == "HI"){
                    securedAreasDynHI.setOpacity(val);
                    securedAreasTilesHI.setOpacity(val);
                  }
                  if (zone == "AK"){
                    securedAreasDynAK.setOpacity(val);
                    securedAreasTilesAK.setOpacity(val);
                  }
                  if (zone == "CONUS"){
                    securedAreasDyn.setOpacity(val);
                    securedAreasTiles.setOpacity(val);
                  }
                });
            };

            var scalebar = new Scalebar({
                map: map,
                // "dual" displays both miles and kilometers
                // "english" is the default, which displays miles
                // use "metric" for kilometers
                scalebarUnit: "dual"
              });

            var toggle = new BasemapToggle({
                    map: map,
                    basemap: "satellite" //basemap: "terrain"
                  }, "BasemapToggle");
            toggle.startup();

            var usgsTopoLayer = new BasemapLayer({url:"https://services.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer"});
            var worldTopoLayer = new BasemapLayer({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer"});
            var imageryLayer = new BasemapLayer({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"});
            var lightGrayBaselayer = new BasemapLayer({url:"https://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer"});
            var landformsBaselayer = new BasemapLayer({url:"https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/TR_landformsBasemap/MapServer"});
            var protectedBaselayer = new BasemapLayer({url: "https://tiles.arcgis.com/tiles/F7DSX1DSNSiWmOqh/arcgis/rest/services/RL_protectedBasemap/MapServer"});

            var usgsTopoBasemap = new Basemap({
                layers:[usgsTopoLayer],
                title:"USGS Topo",
                thumbnailUrl:"assets/usgsTopoThumb.JPG"
            });

            var worldTopoBasemap = new Basemap({
                layers:[worldTopoLayer],
                title:"Topographic",
                thumbnailUrl:"assets/worldTopoThumb.JPG"
            });

            var imageryBasemap = new Basemap({
                layers:[imageryLayer],
                title:"Imagery",
                thumbnailUrl:"assets/imageryThumb.JPG"
            });

            var lightGrayBasemap = new Basemap({
                layers:[lightGrayBaselayer],
                title:"Light Gray",
                thumbnailUrl:"assets/light_gray_canvas.jpg"
            });

            var landformsBasemap = new Basemap({
                layers:[landformsBaselayer],
                title:"Landforms",
                thumbnailUrl:"assets/landformsThumb.jpg"
            });

            var protectedBasemap = new Basemap({
                layers:[protectedBaselayer],
                title:"Protected Lands",
                thumbnailUrl:"assets/protectedThumb.jpg"
            });

//             var gMapLayer = new Basemap({
//                     layers: [new BasemapLayer({
//                     type: "WebTiledLayer",
//                     // url : "https://mts1.google.com/vt/lyrs=s@186112443&hl=x-local&src=app&x={col}&y={row}&z={level}&s=Galile&basemap=terrain",
//                     url : "https://mts1.google.com/vt/lyrs=s@186112443&hl=x-local&src=app&x={col}&y={row}&z={level}&s=Galile",
//                     copyright: "Google Maps"})],
//                     title: "Google Imagery",
//                     thumbnailUrl:"assets/GoogleThumb.png"
//             });

            var basemapGallery = new BasemapGallery({
                showArcGISBasemaps: false,
                map: map
            }, "basemapGallery");
            basemapGallery.add(usgsTopoBasemap);
            basemapGallery.add(worldTopoBasemap);
            basemapGallery.add(imageryBasemap);
            basemapGallery.add(lightGrayBasemap);
//            basemapGallery.add(landformsBasemap);
//            basemapGallery.add(protectedBasemap);
//            basemapGallery.add(gMapLayer);
            basemapGallery.startup();



            //show reference layers if checked
            $('#ecoregionsCheck').change(
                function(){
                    if ($('#ecoregionsCheck').is(':checked')) {
                        // console.log("check eco");
                        app.ecoregionsVisible = true;
                        refreshReferenceLayers();
                    }
                    else{app.ecoregionsVisible = false; refreshReferenceLayers();}
                });
            $('#statesCheck').change(
                function(){
                    if ($('#statesCheck').is(':checked')) {
                        // console.log("check state");
                        app.statesVisible = true;
                        refreshReferenceLayers();
                    }
                    else{app.statesVisible = false; refreshReferenceLayers();}
            });
            $('#securedCheck').change(
                function(){
                    if ($('#securedCheck').is(':checked')) {
                        // console.log("check secured");
                        app.securedVisible = true;
                        var securedSlider = document.getElementById('secTransp');
                        // console.log(securedSlider.value)

                        app.mapZones.forEach((zone, i) => {
                          if (zone == "HI"){
                            securedAreasDynHI.setOpacity(securedSlider.value/100);
                            securedAreasTilesHI.setOpacity(securedSlider.value/100);
                          }
                          if (zone == "AK"){
                            securedAreasDynAK.setOpacity(securedSlider.value/100);
                            securedAreasTilesAK.setOpacity(securedSlider.value/100);
                          }
                          if (zone == "CONUS"){
                            securedAreasDyn.setOpacity(securedSlider.value/100);
                            securedAreasTiles.setOpacity(securedSlider.value/100);
                          }
                        });


                        refreshReferenceLayers();
                    }
                    else{app.securedVisible = false; refreshReferenceLayers();}
            });

            function refreshReferenceLayers(){
                if (app.ecoregionsVisible === true){ecoregions.setVisibility(true);}
                else{ecoregions.setVisibility(false);}
                if (app.statesVisible === true){states.setVisibility(true);}
                else{states.setVisibility(false);}
                if (app.securedVisible === true){
                    $('#secTransp').show();
                    app.mapZones.forEach((zone, i) => {
                      if (zone == "HI"){
                        if (currentScale >= 288895.277144){
                            securedAreasTilesHI.setVisibility(true);
                            securedAreasDynHI.setVisibility(false);
                        }
                        else{
                            securedAreasTilesHI.setVisibility(false);
                            securedAreasDynHI.setVisibility(true);
                        }
                      }
                      if (zone == "AK"){
                        if (currentScale >= 288895.277144){
                            securedAreasTilesAK.setVisibility(true);
                            securedAreasDynAK.setVisibility(false);
                        }
                        else{
                            securedAreasTilesAK.setVisibility(false);
                            securedAreasDynAK.setVisibility(true);
                        }
                      }
                      if (zone == "CONUS"){
                        if (currentScale >= 288895.277144){
                            securedAreasTiles.setVisibility(true);
                            securedAreasDyn.setVisibility(false);
                        }
                        else{
                            securedAreasTiles.setVisibility(false);
                            securedAreasDyn.setVisibility(true);
                        }
                      }
                    });
                }
                else{
                    $('#secTransp').hide();
                    securedAreasTiles.setVisibility(false);
                    securedAreasDyn.setVisibility(false);}
            }
            $("#transp").trigger("input");
//End Map functions**************************************

//Print functions ***************************************

            document.getElementById("myPrintTitle").addEventListener("keyup", updatePrintTitle);
            updatePrintTitle();
            //wrap the wghole Print template functionality in the update function so that title updates on print
            function updatePrintTitle(){
                app.printIterator ++;
                if (app.printIterator > 1){
                    //if don't destroy, two instances of the Print widget can occur
                    app.printer.destroy();
                }
                app.printTitle = document.getElementById("myPrintTitle").value;
                var legendLayer = new LegendLayer();
                if (app.legendLayer === "res"){  var layerName = "Resilience";}
                else if (app.legendLayer === "geo"){ var layerName = "Geology and Soil Texture";}
                else if (app.legendLayer === "landDiv"){var layerName = "Landscape Diversity";}
                else if (app.legendLayer === "localConn"){var layerName = "Local Connectivity";}
                else if (app.legendLayer === "landforms"){var layerName = "Landforms";}
                else if (app.legendLayer === "resConnSimp"){var layerName = "Resilient and Connected Network (Simple)";}
                else if (app.legendLayer === "resConnDet"){var layerName = "Resilient and Connected Network (Detail)";}
                else if (app.legendLayer === "cliFlow"){var layerName = "Connectivity and Climate Flow";}
                else if (app.legendLayer === "cliFlowCat"){var layerName = "Connectivity and Climate Flow Description";}
                else if (app.legendLayer === "rbvCat"){var layerName = "Recognized Biodiversity Value - Categories";}
                else if (app.legendLayer === "rbvSingle"){var layerName = "Recognized Biodiversity Value";}
                else if (app.legendLayer === "region"){var layerName = "Study Regions";}
                else if (app.legendLayer === "nlcd"){var layerName = "Landcover (NLCD 2019)";}
                else if (app.legendLayer === "forestCarb2010"){var layerName = "Forest Ecosystem Carbon (2010)";}
                else if (app.legendLayer === "forestCarb2050"){var layerName = "Forest Ecosystem Carbon (2050)";}
                else if (app.legendLayer === "forestCarbSeq"){var layerName = "Potential Forest Carbon Sequestration (2010-2050)";}
                else if (app.legendLayer === "soilCarbon"){var layerName = "Soil Carbon";}
                else if (app.legendLayer === "base"){var layerName = "";}
//                legendLayer.subLayerIds = [0];
                // console.log(app.legendLayerID);
                legendLayer.layerId = app.legendLayerID; //"layer0";
                app.printTitle = app.printTitle + " - " + layerName;
                app.printer = new Print({
                    map: map,
                    templates : [
                        {
                            label: "Portrait - PDF",
                            format: "PDF",
                            layout: "Letter ANSI A Portrait",
                            layoutOptions: {
                              titleText: app.printTitle,
                              copyrightText: "(c) The Nature Conservancy",
                              scalebarUnit: "Miles",
                              legendLayers : [legendLayer]
                            },
                            exportOptions:{
                                dpi:150
                            }
                        },
                        {
                            label: "Landscape - PDF",
                            format: "PDF",
                            layout: "Letter ANSI A Landscape",
                            layoutOptions: {
                              titleText: app.printTitle,
                              copyrightText: "(c) The Nature Conservancy",
                              scalebarUnit: "Miles",
                              legendLayers : [legendLayer]
                            },
                            exportOptions:{
                                  dpi:150
                            }
                         }
                    ],
//                    url: "http://cumulus-web-adapter-1827610810.us-west-1.elb.amazonaws.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
                    url: "https://cumulus.tnc.org/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
//                     url: "http://maspatial.tnc.org/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
//                        url: "https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
                    }, dom.byId("printButton"));
                app.printer.startup();
            }

//End print functions *************************



//Sketch a parcel*******************************
            function addParcelGraphic(parcelGraphic) {
                //deactivate the toolbar and clear existing graphics
                clearUserPolygons();

                tb.deactivate();
                map.enableMapNavigation();
                app.sketchButton.style.background = "#666666";

                map.graphics.add(new Graphic(parcelGraphic, polyParcel));
                clickMode = "identify";
                activateIdentify();

                parcelGraphic.attributes ={"OBJECTID": 1,
                    "Shape_Length": 9999,
                    "Shape_Area": 9999
                };


                var parcelFeature = [];
                parcelFeature.push(parcelGraphic);
                var featureSetParcel = new FeatureSet();
                featureSetParcel.fields=[
                    {
                        "name": "OBJECTID",
                        "type": "esriFieldTypeOID",
                        "alias": "OBJECTID"
                    },
                    {
                        "name": "Shape_Length",
                        "type": "esriFieldTypeDouble",
                        "alias": "Shape_Length"
                    },
                    {
                        "name": "Shape_Area",
                        "type": "esriFieldTypeDouble",
                        "alias": "Shape_Area"
                    }
                ];
                featureSetParcel.displayFieldName = "";
                featureSetParcel.geometryType = "esriGeometryPolygon";
                featureSetParcel.features = parcelFeature;
                featureSetParcel.features.attributes ={"OBJECTID": 1,
                    "Shape_Length": 9999,
                    "Shape_Area": 9999
                };

                var parcelJSON = JSON.stringify(featureSetParcel);

//                //old versions of arcgis JavaSCript API required modifying the JSON differently
//                parcelJSON = parcelJSON.replace('\"type\":\"polygon\",' , "\"attributes\":{\"OBJECTID\":1,\"Shape_Length\":9999,\"Shape_Area\":9999},\"geometry\":{");
//                parcelJSON = parcelJSON.replace("],\"_ring\":0", "]},\"_ring\":0");

                //new versions of arcgis JavaSCript API 3.x required modifying the JSON differently
                parcelJSON = parcelJSON.replace('"rings":', '"geometry":{"rings":');
                parcelJSON = parcelJSON.replace('"_ring":', '}, "_ring":');
//                console.log(parcelJSON);
//                console.log(featureSetParcel);

 		            app.useCarbon =$("#carbonCheck").is(":checked");
                app.nationalState = $("#nationalStateCheck").is(":checked");
                app.showCarbonResults = app.useCarbon;
                var fsInParams = {"Parcel_as_FeatureSet" : parcelJSON, 'loggedIn':app.loggedIn, 'useCarbon':app.useCarbon, 'nationalState':app.nationalState};
                app.gpFS.submitJob(fsInParams, completeFSCallback, statusCallback, function(error){
                    alert("There was a problem with your analysis.  Please double check your inputs and try again. " + error);
                });

                if (app.resultDialog){
                    app.resultDialog.destroy();
                    app.resultDialog = new Dialog({
                    id: "resultDialog",
                        title: "Resilient Land Summary",
                        style: {
                            width : "750px",
                            height: "800px",
                            maxWidth: "750px",
                            overflow: "auto"
                        }
                    });

                }

                //analytics event tracking
                 ga('send', 'event', {
                    eventCategory:"Resilient Land",
                    eventAction: "Sketch a polygon",
                    eventLabel: "Sketch a polygon"
                 });
            }
//End sketch a Parcel*********************

//Identify task functions*************************************
            function activateIdentify(){
                if (clickMode !== "draw"){
                    identifyListener = dojo.connect(map, "onClick", executeIdentifyTask);
                }
                else{
                    dojo.disconnect(identifyListener);
                }
             }

             function getClickMapZone(point){
               let clickZone
               if (point.y > 6626587 && point.y <11530487 && point.x < -14450397 && point.x >-20883337){clickZone = "AK"}
               if (point.y >2129369 && point.y <2549210 && point.x < -17221300 && point.x >-17852976){clickZone = "HI"}
               if (point.y > 2809312 && point.y <6928760 && point.x <-6654203 && point.x >-13875235){clickZone = "CONUS"}
               return clickZone
             }

            function executeIdentifyTask (event) {
              	// console.log(clickMode);
                // console.log(event)
                let clickZone = getClickMapZone(event.mapPoint)


                var qLayers = []
                if (clickMode !== "draw"){

                    //this is all set up for raster identify
                    identifyParams.geometry = event.mapPoint;
                    identifyParams.mapExtent = map.extent;
                    identifyParams.tolerance = 0;

                    //set the  layer being identified to correspond to the selected layer
                    if (document.getElementById('r1_resil').checked){
                        if (app.loggedIn === false){qLayers.push(21);}
                        if (clickZone === "CONUS"){
                          if (app.regionState === "Region"){qLayers.push(0);}
                          else{qLayers.push(16);}
                        }
                        if (clickZone === "HI"){qLayers.push(44);}
                        if (clickZone === "AK"){qLayers.push(30);}
                    }
                    else if (document.getElementById('r1_LD').checked){
                        if (clickZone === "CONUS"){
                          if (app.regionState === "Region"){qLayers.push(1);}
                          else{qLayers.push(17);}
                        }
                        if (clickZone === "HI"){qLayers.push(45);}
                        if (clickZone === "AK"){qLayers.push(31);}
                    }

                    else if (document.getElementById('r1_LC').checked){
                        if (clickZone === "CONUS"){
                          if (app.regionState === "Region"){qLayers.push(2);}
                          else{qLayers.push(18);}
                        }
                        if (clickZone === "HI"){qLayers.push(46);}
                        if (clickZone === "AK"){qLayers.push(32);}
                    }

                    else if (document.getElementById('r1_geo').checked){
                        if (clickZone === "CONUS"){qLayers.push(3);}
                        if (clickZone === "HI"){qLayers.push(47);}
                        if (clickZone === "AK"){qLayers.push(33);}
                    }

                    else if (document.getElementById('r1_landforms').checked){
                        if (clickZone === "CONUS"){qLayers.push(4);}
                        if (clickZone === "HI"){qLayers.push(48);}
                        if (clickZone === "AK"){qLayers.push(34);}
                    }
                    else if (document.getElementById('r1_tidalHabMig').checked){
                        if (clickZone === "CONUS"){qLayers.push(27);}
                        if (clickZone === "HI"){qLayers.push(58);}
                        if (clickZone === "AK"){qLayers.push(59);}
                    }

                    else if (document.getElementById('r1_resConnSimp').checked){
                        if (app.loggedIn === false){qLayers.push(21);}
                        if (clickZone === "CONUS"){
                          if (app.regionState === "Region"){qLayers.push(5);}
                          else{qLayers.push(20);}
                        }
                        if (clickZone === "HI"){qLayers.push(49);}
                        if (clickZone === "AK"){qLayers.push(35);}
                    }

                    else if (document.getElementById('r1_resConnDet').checked){
                        if (app.loggedIn === false){qLayers.push(21);}
                        if (clickZone === "CONUS"){
                          if (app.regionState === "Region"){qLayers.push(25);}
                          else{qLayers.push(26);}
                        }
                        if (clickZone === "HI"){qLayers.push(50);}
                        if (clickZone === "AK"){qLayers.push(36);}
                    }

	                  else if (document.getElementById('r1_cliFlow').checked){
                        if (clickZone === "CONUS"){
                          if (app.regionState === "Region"){qLayers.push(9);}
                          else{qLayers.push(9);}
                        }
                        if (clickZone === "HI"){qLayers.push(52);}
                        if (clickZone === "AK"){qLayers.push(38);}
                    }

                    else if (document.getElementById('r1_cliFlowCat').checked){
                        if (clickZone === "CONUS"){
                          if (app.regionState === "Region"){qLayers.push(10);}
                          else{qLayers.push(19);}
                        }
                        if (clickZone === "HI"){qLayers.push(53);}
                        if (clickZone === "AK"){qLayers.push(39);}
                    }
                    else if (document.getElementById('r1_elev').checked){
                        if (clickZone === "CONUS"){qLayers.push(11);}
                        if (clickZone === "HI"){qLayers.push(54);}
                        if (clickZone === "AK"){qLayers.push(40);}
                    }
                    else if (document.getElementById('r1_rbvSingle').checked){
                        if (clickZone === "CONUS"){qLayers.push(13);}
                        if (clickZone === "HI"){qLayers.push(55);}
                        if (clickZone === "AK"){qLayers.push(41);}
                    }
                    else if (document.getElementById('r1_rbvCat').checked){
                        if (clickZone === "CONUS"){qLayers.push(14);}
                        if (clickZone === "HI"){qLayers.push(56);}
                        if (clickZone === "AK"){qLayers.push(42);}
                    }
                    else if (document.getElementById('r1_region').checked){
                        if (clickZone === "CONUS"){qLayers.push(15);}
                        if (clickZone === "HI"){qLayers.push(57);}
                        if (clickZone === "AK"){qLayers.push(43);}
                    }
                    else if (document.getElementById('r1_forestCarbon2010').checked){
                        qLayers.push(23);
                    }
                    else if (document.getElementById('r1_forestCarbon2050').checked){
                        qLayers.push(28);
                    }
                    else if (document.getElementById('r1_forestCarbonSeq').checked){
                        qLayers.push(29);
                    }
                    else if (document.getElementById('r1_forestType').checked){
                        qLayers.push(60);
                    }
                    else if (document.getElementById('r1_soilCarbon').checked){
                        qLayers.push(24);
                    }
                    else if (document.getElementById('r1_nlcd').checked){
                        qLayers.push(22);
                    }
                    if (document.getElementById('securedCheck').checked){
                      if(app.mapZones.indexOf("CONUS") != -1){qLayers.push(8);}
                      if(app.mapZones.indexOf("HI") != -1){qLayers.push(51);}
                      if(app.mapZones.indexOf("AK") != -1){qLayers.push(37);}
                    }
                    identifyParams.layerIds = qLayers;
                    var deferred = identifyRes
                        .execute(identifyParams)
                        .addCallback(function (response) {
                            return arrayUtils.map(response, function (idResult) {
                            var feature = idResult.feature;
                            // console.log(idResult);
                            // console.log(response);
                            var indigenousBlock = 0;
                            for (var i = 0; i < response.length; i++){
                                if (response[i].layerId === 21 && app.loggedIn === false){
                                    indigenousBlock = 1;
                                }
                            }
                            if (indigenousBlock === 1 && idResult.layerId !== 8){
                                if (idResult.value !== undefined){
                                    var tribalTemplate = new InfoTemplate("Indigenous  Lands", "<tr><strong>Indigenous Lands</strong>: This analysis was conducted throughout the continental United States and southern Canada using publicly available data and quantitative analysis. However, the results have not yet been reviewed by members of the sovereign indigenous nations of the area. While we solicit review, we have greyed-out the indigenous lands (<a href='coreConcepts_indigenous.html' onClick='return windowPopup(this, \"notes\")'>US Census Bureau 2017, Government of Canada 2017</a>) on the resilience datasets. This location is part of the <strong>" + idResult.value + "</strong>.  For more information or to request access to the data on these lands please contact <a href='mailto:crcs@tnc.org'>crcs@tnc.org</a>. </tr>");
                                }
                                else{
                                    var tribalTemplate = new InfoTemplate("Resilience Data", "For more information or to request access to the data on indigenous lands please contact us at <a href='mailto:crcs@tnc.org'>crcs@tnc.org</a>.");
                                }
                                feature.setInfoTemplate(tribalTemplate);
                                ga('send', 'event', {
                                   eventCategory:"Resilient Land",
                                   eventAction: "Identify click - tribal",
                                   eventLabel: idResult.value
                                });
                                // console.log(feature);
                                return feature;
                            }
                            if (idResult.layerId === 8 || idResult.layerId === 37 || idResult.layerId === 51){
                                var securedTemplate = new InfoTemplate("Conservation  Lands", "<strong>" + idResult.value + "</strong></br>GAP Status: " + feature.attributes.GAP_STATUS + "</br>Acres: " + numberWithCommas(roundNumber(parseFloat(feature.attributes.GIS_ACRES), 2)));
                                feature.setInfoTemplate(securedTemplate);
                                return feature;
                            }
                            if (indigenousBlock === 0){
                                if (document.getElementById('r1_resil').checked){
                                    var idRegion = feature.attributes['ECS_region'];
                                    var pixelVal = feature.attributes['Resilience'];
                                    // console.log(pixelVal);
                                    // console.log(idRegion);
                                    var pixelAnalysis = feature.attributes['type_des'];
                                    if (pixelAnalysis === "Marsh Migration Space"){
                                        pixelAnalysis = "Migration Space For Tidal Habitat";
                                    }
                                    if (pixelAnalysis === "Tidal Complex"){
                                        pixelAnalysis = "Tidal Habitat";
                                    }
    //                                if (pixelVal >= -3500 && pixelVal <-2000){var pixelCat = "Far Below Average";}
    //                                else if (pixelVal >= -2000 && pixelVal <-1000)  {var pixelCat = "Below Average";}
    //                                else if (pixelVal >= -1000 && pixelVal <-500)  {var pixelCat = "Slightly Below Average";}
    //                                else if (pixelVal >= -500 && pixelVal <500)  {var pixelCat = "Average";}
    //                                else if (pixelVal >= 500 && pixelVal <1000)  {var pixelCat = "Slightly Above Average";}
    //                                else if (pixelVal >= 1000 && pixelVal <2000)  {var pixelCat = "Above Average";}
    //                                else if (pixelVal >= 2000)  {var pixelCat = "Far Above Average";}
    //                                else if (pixelVal === -3501) {var pixelCat ="Developed Lands";}
    //                                else if (pixelVal === -3502) {var pixelCat ="Sea Level Rise Area";}
    //                                else if (pixelVal === -3503) {var pixelCat ="Tribal Land Excluded (pending review)";}
                                    var pixelCat = feature.attributes['CONUS_popup2'];
                                    pixelCat = pixelCat.replace(" Marsh Migration Space", "");
                                    // console.log(pixelCat)
                                    var pixelLegend = feature.attributes['CONUS_Legend'].substring(3);

                                  if (pixelVal > -3501){	 //not developed
                                      if (["CA", "PNW"].includes(idRegion) === false){
                                          var pixelValLink = "(" + roundNumber(pixelVal/1000, 2) + " <a href='sd.html' onClick='return windowPopup(this, \"SDnotes\")'>SD</a>)";
                                      }
                                      else{var pixelValLink = ""; }
                                      if ((pixelAnalysis.indexOf("errestrial") >-1) || (pixelAnalysis.indexOf("errestial") >-1)){
                                          var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelLegend + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: estimates the climate-resilience of an area of land (e.g. a “site”) based on its landscape diversity (estimated microclimates) and local connectedness (lack of fragmentation). Each site is scored relative to all other sites in its ecoregion that have the same geophysical setting based on soils, bedrock geology, and elevation zone. The results identify land where high microclimatic diversity and low levels of human modification provide species with connected, diverse climatic conditions they will need to persist and adapt to changing regional climates. This area has <strong>" + pixelCat + "</strong> resilience relative to all sites with the same geophysical setting in its ecoregion.</tr>");
                                      }
                                      else if (pixelAnalysis.indexOf("Migration") >-1){
                                          if (pixelAnalysis === "Additional Marsh Migration Space" && (["CA", "PNW"].includes(idRegion) === false)){
                                              var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Additional marsh migration space includes future marsh areas that were not spatially linked with current tidal marshes or with the migration space of current tidal marshes. The separation could be due to roads, waterbodies, waterways, oil and gas fields, etc. Depending on local factors and context, the degree to which these features will prevent marshes from accessing the additional migration space areas in the future is unknown and likely varies.</p><p>We assigned resilience scores to the additional migration space areas using several approaches. First, we spatially allocated resilience scores based on Euclidean distance from tidal marshes or migration space units. While this approach was a good starting point, there were migration space areas whose score assignments had to be done manually or by taking the highest of two equidistant nearby scores. The manual assignment included straightforward cases, but often it was unclear how marshes might move into a migration space area. As a result, please interpret the scores of the additional migration space with caution and use local expertise and knowledge as you see fit. Lastly, there were thousands of small and disconnected additional migration space areas, often individual pixels, typically found in urban settings, remote upstream riverine areas, or far from any migration space units or tidal marshes. We did not consider these isolated occurrences as additional migration space because they are unlikely to be important future marsh areas. For more information see the <a href='coreConcepts_coastalMig.html' onClick='return windowPopup(this, \"notes\")'>resilient coastal sites core concepts</a>.</p> </tr>");
                                          }
                                          else if(pixelAnalysis === "Additional Marsh Migration Space" && (["CA", "PNW"].includes(idRegion) === true)){
                                              var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, the tidal complex associated with this migration space has <strong>" + pixelCat + "</strong> resilience for the most extreme sea level rise scenario (e.g. 5-ft. or higher). </tr>");
                                          }

                                          else{
                                              var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, the tidal complex associated with this migration space has <strong>" + pixelCat + "</strong> resilience for the most extreme sea level rise scenario (e.g. 5-ft. or higher). </tr>");
                                          }

                                      }

                                      else if (pixelAnalysis.indexOf("Tidal") >-1){
                                          if (pixelVal <500){//Tidal only uses 2 classes
                                              pixelCat = "Below Average";
                                              var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, this tidal complex scores “Average” resilience or lower for the most extreme sea level rise scenario (5-ft. or higher). (i.e., scores either “Average,” “Slightly Below Average,” “Below Average,” or “Far Below Average”).</tr>");
                                          }
                                          if (pixelVal >=500) {
                                              pixelCat = "Above Average";
                                              var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, this tidal complex scores greater than “Average” resilience for the most extreme sea level rise scenario (5-ft. or higher). (i.e., scores either “Slightly Above Average,” “Above Average,” or “Far Above Average”).</tr>");
                                          }
                                      }
                                  }
                                 else if (pixelVal === '-3501'){	 // developed
                                      var resTemplate = new InfoTemplate("Resilience", "<tr><strong>Developed Lands</strong>: Low, Medium, High Density Developed Lands and Roads were not included in the analysis.");
                                 }
                                 else if (pixelVal === '-3502'){	 //sea levl rise area -- unassessed coastal area
                                      pixelCat = "Sea Level Rise Area";
  //                                    var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat +  "</b>" + "<br><br><tr>We assessed all interconnected tidal and estuarine habitats that had at least two acres of contiguous estuarine emergent wetland (salt marsh) as mapped in the 2010 Coastal-Change Analysis Program (C-CAP) land cover data (<a target='_blank' href='https://coast.noaa.gov/digitalcoast/tools/lca'>NOAA 2010</a>). Due to errors in how unconsolidated shoreline was mapped, we did not include any sites that consisted solely of unconsolidated shoreline. </tr>");
                                      var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat +  "</b>" + "<br><br><tr>This location is at risk of inundation under a 6-foot sea level rise scenario.</tr>");

                                  }
                                  else if (pixelVal === '-3503'){	 //sea levl rise area -- unassessed coastal area
                                    //TODO if in AK -3503 is glacier, not triabl land

                                    if (clickZone =="AK"){
                                      pixelCat = "Glacier";
                                      var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat +  "</b>" + "<br><br><tr>Glaciers were not assessed for resilience.</tr>");
                                    }
                                    else{
                                      pixelCat = "Tribal land (excluded pending review)";
                                      var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat +  "</b>" + "<br><br><tr>Tribal lands are excluded from the results pending a review with tribal representatives. </tr>");
                                    }


                                  }
                                  else if (pixelVal === '-3504'){	 //sea levl rise area -- unassessed coastal area
                                        pixelCat = "Pioneer Lava";
                                        var resTemplate = new InfoTemplate("Resilience", "<tr><strong>Pioneer Lava</strong>: This area is composed of recent lava flows and was not assessed for resilience.");

                                  }
                                  else if (pixelVal === '-4000' && pixelAnalysis.indexOf("Tidal") >-1){	 // handful of cell are below average coastal
                                        pixelCat = "Below Average";
                                        var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " Resilience " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, this tidal complex scores greater than <strong>" + pixelCat + "</strong> resilience or lower for the 6-ft. sea level rise scenario.</tr>");
                                  }
                                  else if (pixelVal === '-4000' && pixelAnalysis.indexOf("Migration") >-1){	 // handful of cell are below average coastal
                                        pixelCat = "Far Below Average";
                                        var resTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " Resilience " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, the tidal complex associated with this migration space has <strong>" + pixelCat + "</strong> resilience for the 6-ft. sea level rise scenario. </tr>");
                                  }

                                   idLayer = "ID Resilience";
                                   feature.setInfoTemplate(resTemplate);
                                }


                                if (document.getElementById('r1_LD').checked){
                                    var pixelVal = feature.attributes['LD_Value'];
                                    var idRegion = feature.attributes['Region'];
                                    // console.log(pixelVal)
    //                                if (pixelVal >= -3500 && pixelVal <-2000){var pixelCat = "Far Below Average";}
    //                                else if (pixelVal >= -2000 && pixelVal <-1000)  {var pixelCat = "Below Average";}
    //                                else if (pixelVal >= -1000 && pixelVal <-500)  {var pixelCat = "Slightly Below Average";}
    //                                else if (pixelVal >= -500 && pixelVal <500)  {var pixelCat = "Average";}
    //                                else if (pixelVal >= 500 && pixelVal <1000)  {var pixelCat = "Slightly Above Average";}
    //                                else if (pixelVal >= 1000 && pixelVal <2000)  {var pixelCat = "Above Average";}
    //                                else if (pixelVal >= 2000)  {var pixelCat = "Far Above Average";}
    //                                else if (pixelVal === -3501) {var pixelCat ="Developed Lands";}
                                    var pixelCat = feature.attributes['LD_Pop_up'];
                                    var pixelLegend = feature.attributes['LD_Legend'].substring(2);
                                    console.log(pixelCat)
                                    console.log(pixelLegend)
                                    console.log(pixelVal)
                                    if (pixelVal > -3501){	 //not developed
                                        if (["CA", "PNW"].includes(idRegion) === false){
                                            var pixelValLink = "(" + roundNumber(pixelVal/1000, 2)  + " <a href='sd.html' onClick='return windowPopup(this, \"SDnotes\")'>SD</a>)";
                                        }
                                        else{var pixelValLink = ""}
                                        var LDTemplate = new InfoTemplate("Landscape Diversity", "<b>" + pixelLegend + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Landscape Diversity</strong>: estimates the number of microclimates within and around a site based on its topographic diversity, density of wetlands, and elevation range. Microclimates buffer the site from the effects of climate change because they provide plants and animals with many temperature and moisture options in their local neighborhood, buffering them from the regional climate and facilitating persistence. This site has <strong>" + pixelCat + "</strong> relative to other sites in the ecoregion with the same geophysical setting..</tr>");
                                    }
                                    else if (pixelVal === '-3501'){	 // developed
                                        var LDTemplate = new InfoTemplate("Landscape Diversity", "<tr><strong>Developed Lands</strong>: Low, Medium, High Density Developed Lands and Roads were not included in the analysis.");
                                    }
                                    else if (pixelVal === '-3503'){	 // developed
                                        var LDTemplate = new InfoTemplate("Landscape Diversity", "<tr><strong>Unassessed coastal area</strong>: Landscape diversity scores were not used in areas assessed in the coastal analysis.");
                                    }
                                    idLayer = "ID Landscape Diversity";
                                    feature.setInfoTemplate(LDTemplate);
                                }

                                if (document.getElementById('r1_LC').checked){
                                    var pixelVal = feature.attributes['LC_Value'];
                                    var idRegion = feature.attributes['Region'];
    //                                if (pixelVal >= -3500 && pixelVal <-2000){var pixelCat = "Far Below Average";}
    //                                else if (pixelVal >= -2000 && pixelVal <-1000)  {var pixelCat = "Below Average";}
    //                                else if (pixelVal >= -1000 && pixelVal <-500)  {var pixelCat = "Slightly Below Average";}
    //                                else if (pixelVal >= -500 && pixelVal <500)  {var pixelCat = "Average";}
    //                                else if (pixelVal >= 500 && pixelVal <1000)  {var pixelCat = "Slightly Above Average";}
    //                                else if (pixelVal >= 1000 && pixelVal <2000)  {var pixelCat = "Above Average";}
    //                                else if (pixelVal >= 2000)  {var pixelCat = "Far Above Average";}
    //                                else if (pixelVal === -3501) {var pixelCat ="Developed Lands";}
                                    var pixelCat = feature.attributes['LC_Pop_up'];
                                    var pixelLegend = feature.attributes['LC_Legend'].substring(2);

                                    if (pixelVal > -3501){	 //not developed
                                        if (["CA", "PNW"].includes(idRegion) === false){
                                            var pixelValLink = "(" + roundNumber(pixelVal/1000, 2)  + " <a href='sd.html' onClick='return windowPopup(this, \"SDnotes\")'>SD</a>)";
                                        }
                                        else{var pixelValLink = "";}
                                        var LCTemplate = new InfoTemplate("Local Connectedness", "<b>" + pixelLegend + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Local Connectedness</strong>:  estimates how connected a site is based on the number of barriers and the degree of fragmentation and human modification within and around a site. A highly connected landscape promotes resilience by allowing plants and animals to move through the landscape and find suitable microclimates where they can persist. This site has <strong>" + pixelCat + "</strong> relative to other sites in the ecoregion with the same geophysical setting.</tr>");                                }
                                    else if (pixelVal === '-3501'){	 // developed
                                        var LCTemplate = new InfoTemplate("Local Connectedness", "<tr><strong>Developed Lands</strong>: Low, Medium, High Density Developed Lands and Roads were not included in the analysis.");
                                    }
                                    else if (pixelVal === '-3503'){	 // developed
                                        var LCTemplate = new InfoTemplate("Local Connectedness", "<tr><strong>Unassessed coastal area</strong>: Local connectedness scores were not used in areas assessed in the coastal analysis.");
                                    }
                                    idLayer = "ID Local Connectedness";
                                    feature.setInfoTemplate(LCTemplate);
                                }

                                if (document.getElementById('r1_geo').checked){
                                    console.log("geo click")
                                    // var newName = feature.attributes['outputName'];
                                    // var photoName = app.geoDicts.photoNames[newName];
                                    if (typeof photoName === "undefined"){photoName = "noPhoto";}
                                    var pixelDesc =feature.attributes['C_pop_up_legend'];
                                    // var pixelJPEG = photoName;
                                    idLayer = "ID Geophysical - " + pixelDesc;
    //                                var geoPic = '<table align="center"><tr align="center"><td align="center"><img src="assets/' + pixelJPEG + '.JPG" alt="' + pixelDesc + '" width="300" height="200"></td></tr></table>';
                                    var geoPic = "";
                                    var RockiesPrefixes = ["Alpine", "Cold Desert Basin", "Lower Montane", "Mountain Lower Basin", "Subalpine", "Tropical Lowloand", "Upper Montane", "Warm Desert Basin"];

                                    for (var i = 0; i < RockiesPrefixes.length; i++) {
                                      if (pixelDesc.startsWith(RockiesPrefixes[i]) === false){
                                        console.log("not rocky")
                                          var geoTemplate = new InfoTemplate("Geophysical Setting", "<tr>Geophysical Setting: also known as Land Facets, refer to the soils, geology, and elevation zones that explain basic biodiversity patterns of a region. We used geophysical settings as a stratification template to ensure that resilient examples of all species-relevant physical habitats will be represented in our conservation portfolios. These sites provide the “stages” for current and future biodiversity.  Because biodiversity-geophysical relationships vary spatially, each study region developed its own set of appropriate geophysical settings/land facets through testing with known locations of biodiversity features.  Here, we integrate these into one map, but we encourage users to read the report for their study region to get details on the species-geophysical setting relationships. This location is in the <strong> " + pixelDesc + "</strong> geophysical setting." + geoPic);
                                      }
                                      else{
                                        console.log("Rocky")
                                          var rockyGeology = feature.attributes['CL_GEOSOIL'];
                                          var rockyElev = feature.attributes['CL_ELEV'];
                                          var geoTemplate = new InfoTemplate("Geophysical Setting", "<tr>Geophysical Setting: also known as Land Facets, refer to the soils, geology, and elevation zones that explain basic biodiversity patterns of a region. We used geophysical settings as a stratification template to ensure that resilient examples of all species-relevant physical habitats will be represented in our conservation portfolios. These sites provide the “stages” for current and future biodiversity.  Because biodiversity-geophysical relationships vary spatially, each study region developed its own set of appropriate geophysical settings/land facets through testing with known locations of biodiversity features.  Here, we integrate these into one map, but we encourage users to read the report for their study region to get details on the species-geophysical setting relationships. This location is in the <strong> " + rockyElev + "</strong> life zone: <strong>" + rockyGeology+ "</strong> geology." + geoPic);
                                          break;
                                      }
                                    }

                                    feature.setInfoTemplate(geoTemplate);

                                    // pixelDesc =feature.attributes['SET_NAME_L'];
                                    // pixelJPEG = feature.attributes['SET_NAME_L'].toUpperCase();
                                    // pixelJPEG = pixelJPEG.replace(/ /g, "_");
                                    // pixelJPEG = pixelJPEG.replace(/:/g, "_");
                                    // pixelJPEG = pixelJPEG.replace("/", "_");
                                    // pixelElev =feature.attributes['ELV_TXT'];
                                    // pixelGeo =feature.attributes['D_SOILGEO'];
                                    // var geoPic = '<table align="center"><tr align="center"><td align="center"><img src="assets/' + pixelJPEG + '.JPG" alt="' + pixelDesc + '" width="300" height="200"></td></tr></table>';
                                    // var geoTemplate = new InfoTemplate("Geophysical Setting", "<tr>This location is in the <b>" + pixelElev + "</b> elevation zone and the geology is <b>" + pixelGeo + "</b> (pictured).</tr>" + geoPic);
                                    // feature.setInfoTemplate(geoTemplate);
                                }
                                else if(document.getElementById('r1_landforms').checked){
                                    idLayer = "ID Landforms";
                                    var pixelDesc =feature.attributes['Landform'];
                                    var lfTemplate = new InfoTemplate("Landforms", "<tr><strong>Landforms:</strong> The 19-24 individual landform units reflect local variation in land position, slope, solar radiation, moisture availability, and susceptibility to wind and other disturbances. Landform-based climatic variation can be on par with, or greater than the climatic variation expected over the next century, and because species experience climate at a very local scale (inches to yards), high microclimate variation allows species to persist at sites even when the regional climate appears unsuitable. For more information on the landform model see the report for your study region. This location is on the <b>" + pixelDesc + "</b> landform.</tr>");
                                    feature.setInfoTemplate(lfTemplate);
                                }


                                else if(document.getElementById('r1_resConnSimp').checked){
                                    var idLayer = "ID Resilient & Connected (Simple)";
                                    var pixelDescSimp =feature.attributes['rcn_simp_legend'].substr(2);  // if field starts with a number for sorting, then need to omit the first 2 chars
                                    if (pixelDescSimp === undefined|| pixelDescSimp === ""){pixelDescSimp = "Outside prioritized network";}
                                    var idLayer = "ID Resilient & Connected (Detail)";
                                    var pixelDescDet =feature.attributes['Prioritized_Network'];  // if field starts with a number for sorting, then need to omit the first 2 chars
                                    if (pixelDescDet === "Resilient Coastal Migration Space"){pixelDescDet = "Migration Space for Tidal Habitat";}
                                    if (pixelDescDet === undefined || pixelDescDet === ""){pixelDescDet = "Outside prioritized network";}
                                    var resConnSimpTemplate = new InfoTemplate("Resilient and Connected Landscapes", "<tr><strong>Resilient and Connected Network</strong>: This map integrates 1) representative climate-resilient sites - places where high topoclimatic diversity and low levels of human modification provide species with connected, diverse climatic conditions they will need to persist and adapt to changing regional climates; 2) connectivity and climate flow areas - places important for sustaining regional connectivity to support dispersal, gene flow, and range shifts; and 3) recognized biodiversity areas - places recognized for their biodiversity value such as rare species, intact habitat, or exemplary natural communities.  The results naturally align these features into a connected network of resilient sites that, if conserved, could sustain the diversity of the conterminous US while ensuring species can move and adapt to climate change. Using the simple network classes, this location is characterized as  <b>" + pixelDescSimp+ "</b>.  Using the detailed classes it is characterized as <b>"+ pixelDescDet +"</b>.</tr>");
                                    feature.setInfoTemplate(resConnSimpTemplate);
                                }
                                else if(document.getElementById('r1_resConnDet').checked){
                                    var idLayer = "ID Resilient & Connected (Detail)";
                                    var pixelDescDet =feature.attributes['Prioritized_Network'];  // if field starts with a number for sorting, then need to omit the first 2 chars
                                    if (pixelDescDet === "Resilient Coastal Migration Space"){pixelDescDet = "Migration Space for Tidal Habitat"}
                                    if (pixelDescDet === undefined){pixelDescDet = "Outside prioritized network";}
                                    var resConnDetTemplate = new InfoTemplate("Resilient and Connected Landscapes (Detail)", "<tr><strong>Resilient and Connected Network</strong>: This map integrates 1) representative climate-resilient sites - places where high topoclimatic diversity and low levels of human modification provide species with connected, diverse climatic conditions they will need to persist and adapt to changing regional climates; 2) connectivity and climate flow areas - places important for sustaining regional connectivity to support dispersal, gene flow, and range shifts; and 3) recognized biodiversity areas - places recognized for their biodiversity value such as rare species, intact habitat, or exemplary natural communities.  The results naturally align these features into a connected network of resilient sites that, if conserved, could sustain the diversity of the conterminous US while ensuring species can move and adapt to climate change. This location is in the network based on  <b>" + pixelDescDet + "</b>.</tr>");
                                    feature.setInfoTemplate(resConnDetTemplate);
                                }
                                else if(document.getElementById('r1_cliFlow').checked){
                                    idLayer = "ID Climate Flow";
                                    var pixelVal = feature.attributes['Pixel Value'];
                                    if (pixelVal < -2000){var pixelCat = "Low Flow";}
                                    else if (pixelVal >= -2000 && pixelVal <-1000)  {var pixelCat = "Low-Average Flow";}
                                    else if (pixelVal >= -1000 && pixelVal <-500)  {var pixelCat = "Average-Low Flow";}
                                    else if (pixelVal >= -500 && pixelVal <500)  {var pixelCat = "Average Flow";}
                                    else if (pixelVal >= 500 && pixelVal <1000)  {var pixelCat = "Average-High Flow";}
                                    else if (pixelVal >= 1000 && pixelVal <2000)  {var pixelCat = "High-Average Flow";}
                                    else if (pixelVal >= 2000)  {var pixelCat = "High Flow";}


                                    var cliFlowTemplate = new InfoTemplate("Connectivity and Climate Flows", "<tr><strong>Connectivity and Climate Flows</strong>:  Climate flow refers to the gradual movement of populations in response to changes in the climate. This analysis highlight connections that are important for population movement because they are connected with natural cover and track climatic gradients to provide climate relief (uplsope, northward, riparian). High current flow indicates areas of concentrated flow where movements will accumulate or be channeled through a pinch point. Average current flow indicates areas of moderate flow; often highly natural settings were species movements are diffuse. Low current flow indicates areas with low permeability where movement may be blocked. This location has <b>" + pixelCat + "</b>.</tr>");
                                    feature.setInfoTemplate(cliFlowTemplate);
                                }
                                else if(document.getElementById('r1_cliFlowCat').checked){
                                    var idLayer = "ID Climate Flow Categories";

                                    if (app.regionState === "Region"){var pixelDesc =feature.attributes['Description'].substr(2);}
                                    else{var pixelDesc =feature.attributes['Description'];}
                                    if (pixelDesc === ""){pixelDesc = "Outside categorized climate flow area";}
                                    if (pixelDesc === "Priority Coastal Marsh Migration Space"){pixelDesc = "Migration Space for Tidal Habitat";}
                                    var cliFlowCatTemplate = new InfoTemplate("Connectivity and Climate Flows Categories", "<tr><strong>Connectivity and Climate Flow Categories</strong>:   Climate flow refers to the gradual movement of populations in response to changes in the climate. This analysis highlights connections that are important for population movement because they are connected with natural cover and track climatic gradients to provide climate relief (uplsope, northward, riparian). The results are continuous, but here we categorized them into: 1) Diffuse flow areas (flow zones) that are largely natural and have high climate flow; 2) Concentrated flow areas (corridors) that have high flow concentrated in a small area where many species movements will likely converge; 3) Constrained flow areas that have lower levels of flow because movement is constrained by human modification. This location is in a <b>" + pixelDesc + "</b> area.</tr>");
                                    feature.setInfoTemplate(cliFlowCatTemplate);
                                }

                                else if(document.getElementById('r1_elev').checked){
                                    var idLayer = "ID Elevation";

                                    var elevMeters = feature.attributes['Pixel Value'];
                                    var elevFeet = roundNumber((elevMeters * 3.28084), 1);

                                    var elevTemplate = new InfoTemplate("Elevation", "<tr><strong>Elevation</strong>:  This map uses a standard set of elevations zones for the conterminous US and the elevation at this location is <strong>" + elevMeters + " meters</strong> (<strong>" + elevFeet + " feet</strong>). This map provides national context but because species-elevation relationships vary spatially across the US, each study region developed its own set of elevation zones or life zones as appropriate for the study region.  To see the elevation zones used in the study, and for detail on the species-elevation relationships, we encourage users to read the report for their study region of interest. </tr>");
                                    feature.setInfoTemplate(elevTemplate);
                                }
                                else if(document.getElementById('r1_tidalHabMig').checked){
                                    var idLayer = "ID Tidal Habitat Migration Sapce";

                                    var idRegion = feature.attributes['ECS_region'];
                                    var pixelVal = feature.attributes['Resilience'];
                                    if (["CA", "PNW"].includes(idRegion) === false){
                                            var pixelValLink = "(" + roundNumber(pixelVal/1000, 2) + " <a href='sd.html' onClick='return windowPopup(this, \"SDnotes\")'>SD</a>)";
                                    }
                                    var pixelCat = feature.attributes['CONUS_popup2'];
                                    pixelCat = pixelCat.replace(" Marsh Migration Space", "");
                                    var pixelAnalysis = feature.attributes['type_des'];
                                    if (pixelAnalysis === "Marsh Migration Space"){
                                        pixelAnalysis = "Migration Space For Tidal Habitat";
                                    }
                                    if (pixelAnalysis === "Tidal Complex"){
                                        pixelAnalysis = "Tidal Habitat";
                                    }
                                    if (pixelAnalysis.indexOf("Migration") >-1){
                                        if (pixelAnalysis === "Additional Marsh Migration Space" && (["CA", "PNW"].includes(idRegion) === false)){
                                            var tidalHabMigTemplate = new InfoTemplate("Migration Space for Tidal Habitat", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Additional marsh migration space includes future marsh areas that were not spatially linked with current tidal marshes or with the migration space of current tidal marshes. The separation could be due to roads, waterbodies, waterways, oil and gas fields, etc. Depending on local factors and context, the degree to which these features will prevent marshes from accessing the additional migration space areas in the future is unknown and likely varies.</p><p>We assigned resilience scores to the additional migration space areas using several approaches. First, we spatially allocated resilience scores based on Euclidean distance from tidal marshes or migration space units. While this approach was a good starting point, there were migration space areas whose score assignments had to be done manually or by taking the highest of two equidistant nearby scores. The manual assignment included straightforward cases, but often it was unclear how marshes might move into a migration space area. As a result, please interpret the scores of the additional migration space with caution and use local expertise and knowledge as you see fit. Lastly, there were thousands of small and disconnected additional migration space areas, often individual pixels, typically found in urban settings, remote upstream riverine areas, or far from any migration space units or tidal marshes. We did not consider these isolated occurrences as additional migration space because they are unlikely to be important future marsh areas. For more information see the <a href='coreConcepts_coastalMig.html' onClick='return windowPopup(this, \"notes\")'>resilient coastal sites core concepts</a>.</p> </tr>");
                                        }
                                        else if(pixelAnalysis === "Additional Marsh Migration Space" && (["CA", "PNW"].includes(idRegion) === true)){
                                            var tidalHabMigTemplate = new InfoTemplate("Migration Space for Tidal Habitat", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, the tidal complex associated with this migration space has <strong>" + pixelCat + "</strong> resilience for the most extreme sea level rise scenario (e.g. 5-ft. or higher). </tr>");
                                        }
                                        else{
                                            var tidalHabMigTemplate = new InfoTemplate("Migration Space for Tidal Habitat", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, the tidal complex associated with this migration space has <strong>" + pixelCat + "</strong> resilience for the most extreme sea level rise scenario (e.g. 5-ft. or higher). </tr>");
                                        }
                                    }

                                    else if (pixelAnalysis.indexOf("Tidal") >-1){
                                        if (pixelVal <500){//Tidal only uses 2 classes
                                            pixelCat = "Below Average";
                                            var tidalHabMigTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, this tidal complex scores “Average” resilience or lower for the most extreme sea level rise scenario (5-ft. or higher). (i.e., scores either “Average,” “Slightly Below Average,” “Below Average,” or “Far Below Average”).</tr>");
                                        }
                                        if (pixelVal >=500) {
                                            pixelCat = "Above Average";
                                            var tidalHabMigTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat + " " +pixelValLink + "</b>" + "<br><br><tr><strong>Site Resilience (" + pixelAnalysis +")</strong>: Each site received a resilience score based on the likelihood that its coastal habitats can and will migrate to adjacent lowlands, referred to as “migration space.” Each site is scored relative to all other sites within discrete geographic stretches of shoreline that share similar processes and dominant estuary types, which we call Coastal Shoreline Regions (CSRs). Relative to all sites within the same CSR, this tidal complex scores greater than “Average” resilience for the most extreme sea level rise scenario (5-ft. or higher). (i.e., scores either “Slightly Above Average,” “Above Average,” or “Far Above Average”).</tr>");
                                        }
                                    }


                                    if (pixelVal === '-3502'){	 //sea levl rise area -- unassessed coastal area
                                        pixelCat = "Sea Level Rise Area";
                                        var tidalHabMigTemplate = new InfoTemplate("Resilience", "<b>" + pixelCat +  "</b>" + "<br><br><tr>This location is at risk of inundation under a 6-foot sea level rise scenario.</tr>");
                                    }
                                    feature.setInfoTemplate(tidalHabMigTemplate);
                                }

                                else if(document.getElementById('r1_forestCarbon2010').checked){
                                    var idLayer = "ID Forest Carbon 2010";
                                    var tonsacre = feature.attributes['Pixel Value'];
                                    if (tonsacre !== undefined){
                                        tonsacre = Math.max(roundNumber(tonsacre, 2));
                                        var forestCarbon2010Template = new InfoTemplate("Forest Ecosystem Carbon", "<tr><strong>Forest Ecosystem Carbon (2010)</strong>:  <strong>" + tonsacre + "</strong> mt/acre. <p>Estimates of Forest Carbon (Aboveground, Coarse Woody Debris and Total Ecosystem) are from <a href='https://daac.ornl.gov/CMS/guides/AGB_NEP_Disturbance_US_Forests.html' target='_blank'>Williams et al. (2021b)</a> following methods described in Gu et al. (2019) for the Southeast US.  To estimate carbon stock, attributes were determined for all forested 30-m pixels in the continental United States and a forest carbon cycle model trained to match Forest Inventory and Analysis (FIA) data was used to predict carbon stocks for 2010 based on site‐level attributes of forest type group, years since disturbance, and site productivity class. Results were iterated backward in time to provide continuous, annual reporting of forest carbon dynamics for each pixel.  Unlike in most prior studies that lack spatial detail on the stand age of forest stands that persisted in a forested condition during the satellite data era, this study used remotely sensed biomass to estimate the stand age condition of these persisting, intact forests, distinguishing relatively young stands (e.g., 30 to 50 year old) from older stands.</p> </tr>");
                                    }
                                    else{
                                        var forestCarbon2010Template = new InfoTemplate("Forest Ecosystem Carbon", "<tr><strong>Forest Ecosystem Carbon (2010)</strong>:  No forest carbon data is available for this location.  Forest carbon data is only available in forested areas.  Refer to the NLCD 2019 to locate forested areas.</tr>");
                                    }
                                    feature.setInfoTemplate(forestCarbon2010Template);
                                }
                                else if(document.getElementById('r1_forestCarbon2050').checked){
                                    var idLayer = "ID Forest Carbon 2050";
                                    var tonsacre = feature.attributes['Pixel Value'];
                                    if (tonsacre !== undefined){
                                        tonsacre = Math.max(roundNumber(tonsacre, 2));
                                        var forestCarbon2050Template = new InfoTemplate("Forest Ecosystem Carbon", "<tr><strong>Forest Ecosystem Carbon (2050)</strong>:  <strong>" + tonsacre + "</strong> metric tons / acre. <p>Estimates of Forest Carbon (Aboveground, Coarse Woody Debris and Total Ecosystem) are from <a href='https://daac.ornl.gov/CMS/guides/AGB_NEP_Disturbance_US_Forests.html' target='_blank'>Williams et al. (2021b)</a> following methods described in Gu et al. (2019) for the Southeast US.  To estimate carbon stock, attributes were determined for all forested 30-m pixels in the continental United States and a forest carbon cycle model trained to match Forest Inventory and Analysis (FIA) data was used to predict carbon stocks for 2010 based on site‐level attributes of forest type group, years since disturbance, and site productivity class. Results were iterated backward in time to provide continuous, annual reporting of forest carbon dynamics for each pixel.  Unlike in most prior studies that lack spatial detail on the stand age of forest stands that persisted in a forested condition during the satellite data era, this study used remotely sensed biomass to estimate the stand age condition of these persisting, intact forests, distinguishing relatively young stands (e.g., 30 to 50 year old) from older stands.</p> </tr>");
                                    }
                                    else{
                                        var forestCarbon2050Template = new InfoTemplate("Forest Ecosystem Carbon", "<tr><strong>Forest Ecosystem Carbon (2050)</strong>:  No forest carbon data is available for this location.  Forest carbon data is only available in forested areas.  Refer to the NLCD 2019 to locate forested areas.</tr>");
                                    }
                                    feature.setInfoTemplate(forestCarbon2050Template);
                                }

                                else if(document.getElementById('r1_forestCarbonSeq').checked){
                                    var idLayer = "ID Forest Carbon Sequestration";
                                    var tonsacre = feature.attributes['Pixel Value'];
                                    if (tonsacre !== undefined){
                                        tonsacre = Math.max(roundNumber(tonsacre, 2));
                                        var forestCarbonSeqTemplate = new InfoTemplate("Avg. Annual Sequestration", "<tr><strong>Potential Forest Ecosystem Carbon Sequestration</strong>:  <strong>" + tonsacre + "</strong> metric tons / acre. <p>Estimates of Forest Carbon (Aboveground, Coarse Woody Debris and Total Ecosystem) are from <a href='https://daac.ornl.gov/CMS/guides/AGB_NEP_Disturbance_US_Forests.html' target='_blank'>Williams et al. (2021b)</a> following methods described in Gu et al. (2019) for the Southeast US.  To estimate carbon stock, attributes were determined for all forested 30-m pixels in the continental United States and a forest carbon cycle model trained to match Forest Inventory and Analysis (FIA) data was used to predict carbon stocks for 2010 based on site‐level attributes of forest type group, years since disturbance, and site productivity class. Results were iterated backward in time to provide continuous, annual reporting of forest carbon dynamics for each pixel.  Unlike in most prior studies that lack spatial detail on the stand age of forest stands that persisted in a forested condition during the satellite data era, this study used remotely sensed biomass to estimate the stand age condition of these persisting, intact forests, distinguishing relatively young stands (e.g., 30 to 50 year old) from older stands.</p> </tr>");
                                    }
                                    else{
                                        var forestCarbonSeqTemplate = new InfoTemplate("Avg. Annual Sequestration", "<tr><strong>Potential Forest Ecosystem Carbon Sequestration</strong>:  No forest carbon data is available for this location.  Forest carbon data is only available in forested areas.  Refer to the NLCD 2019 to locate forested areas.</tr>");
                                    }
                                    feature.setInfoTemplate(forestCarbonSeqTemplate);

                                }

                                else if(document.getElementById('r1_forestType').checked){
                                    var idLayer = "ID Forest Types";
                                    var type = feature.attributes['Forest_Typ'];
                                    if (type !== undefined){

                                        var forestTypeTemplate = new InfoTemplate("Forest Types", "<tr><strong>Forest Type</strong>:  <strong>" + type + "</strong>. <p>Forest carbon was evaluated by Williams et al on forested lands.  Lands were defined as forested if they were available in the forest type data from: Ruefenacht, B., M.V. Finco, M.D. Nelson, R. Czaplewski, E.H. Helmer, J.A. Blackard, G.R. Holden, A.J. Lister, D. Salajanu, D. Weyermann, and K. Winterberger. 2008. Conterminous U.S. and Alaska Forest Type Mapping Using Forest Inventory and Analysis Data. Photogrammetric Engineering & Remote Sensing 74:1379–1388. <a href='https://doi.org/10.14358/PERS.74.11.1379' target='_blank'>https://doi.org/10.14358/PERS.74.11.1379</a></p> </tr>");
                                    }
                                    else{
                                        var forestCarbon2050Template = new InfoTemplate("Forest Types", "<tr><strong>Forest Ecosystem Carbon (2050)</strong>:  No forest type data is available for this location.</tr>");
                                    }
                                    feature.setInfoTemplate(forestCarbon2050Template);
                                }

                                else if(document.getElementById('r1_soilCarbon').checked){
                                    var idLayer = "ID Soil Carbon";
                                    var tonsacre = feature.attributes['Pixel Value'];
                                    tonsacre = Math.max(roundNumber(tonsacre, 2));
                                    var soilCarbonTemplate = new InfoTemplate("Soil Organic Carbon", "<tr><strong>Soil Organic Carbon</strong>: <strong>" + tonsacre + "</strong> metric tons / acre. <p>Estimates of soil organic carbon (SOC) for 0-30 cm topsoil layer at a at 250-m resolution for the conterminous USA (CONUS) are from Oak Ridge Lab (<a href='assets/nrs_2020_guevara.pdf' target='_blank'>Guevara et al 2020</a>). The estimates are for the for the period 1991-2010 and were derived using the USDR Rapid Carbon Assessment (RaCA) including 6418 field pedon samples and multiple environmental variables representative of the soil forming environment coupled with a machine learning approach (i.e., simulated annealing) and regression tree ensemble modeling for optimized SOC prediction. Across the continental US nearly 31% of SOC was found in forests, 28% in croplands and 35% in grasslands and shrublands respectively.</p> </tr>");
                                    feature.setInfoTemplate(soilCarbonTemplate);
                                }

                                else if(document.getElementById('r1_nlcd').checked){
                                    var idLayer = "ID NLCD";
                                    var lc = feature.attributes['NLCD_Land_Cover_Class'];
                                    var nlcdTemplate = new InfoTemplate("NLCD", "<tr><strong>National Landcover Database</strong>:  This location has <strong>" + lc + "</strong> landcover. </tr>");
                                    feature.setInfoTemplate(nlcdTemplate);
                                }

                                else if(document.getElementById('r1_region').checked){
                                    var idLayer = "ID Regions";
                                    var region = feature.attributes['Stateandregion'];
                                    if (region == undefined){region = feature.attributes['stateandregion'];}
                                    if (["Warm Deserts and Tamaulipan/CA", "Rocky Mountains/CA", "Pacific Northwest/California"].includes(region) === true){
                                        var coverImage0 = 'assets/' + app.reports.reportCovers[region][0] + '.jpg';
                                        var reportLink0 = app.reports.reportLinks[region][0];
                                        var coverImageHTML0 =   "<table><tr align='center'><td align='left'><a href='" + reportLink0 + "' target='_blank' ><img src='" + coverImage0 +  "' width='152' height='197'></td>";
                                        var coverImage1 = 'assets/' + app.reports.reportCovers[region][1] + '.jpg';
                                        var reportLink1 = app.reports.reportLinks[region][1];
                                        var coverImageHTML1 =   "<td align='right'><a href='" + reportLink1 + "' target='_blank' ><img src='" + coverImage1 +  "' width='152' height='197'></td></tr></table>";
                                        var regionTemplate = new InfoTemplate("Study Regions", "<tr>This location is part of the <b>" + region + "</b> study area. Click on one of the images to read the report or access the data for that study area.</tr><tr>" + coverImageHTML0 + coverImageHTML1+"</tr>");
                                    }
                                    else{
                                        var coverImage = 'assets/' + app.reports.reportCovers[region] + '.jpg';
                                        var reportLink = app.reports.reportLinks[region];
                                        var coverImageHTML =   "<table align='center'><tr align='center'><td align='center'><a href='" + reportLink + "' target='_blank' ><img src='" + coverImage +  "' width='152' height='197'></td></tr></table>";
                                        if (region === "Pacific Northwest Coast"){
                                            var regionTemplate = new InfoTemplate("Study Regions", "<tr>This location is part of the <b>" + region + "</b> study area. No report is available for the coastal analysis in this region.  Click on the image to view a conceptual infographic.</tr>" + coverImageHTML);
                                        }
                                        else{
                                            var regionTemplate = new InfoTemplate("Study Regions", "<tr>This location is part of the <b>" + region + "</b> study area. Click on the image to read the report or access the data.</tr>" + coverImageHTML);
                                        }
                                    }
                                    feature.setInfoTemplate(regionTemplate);
                                }
                                else if((document.getElementById('r1_rbvSingle').checked) || (document.getElementById('r1_rbvCat').checked)){
                                    var idLayer = "ID RBV";
                                    var pixelDesc =feature.attributes['d_RCRCNRBV'];
                                    if (pixelDesc === "Unincluded in Above Categories Additional Habitat and Species"){pixelDesc = "Additional Habitat and Species";}
                                    if (pixelDesc === "Unrecognized as Biodiversity Value Area"){
                                        var rbvSingleTemplate = new InfoTemplate("Recognized Biodiversity Value", "<tr>This map is based on the results of 67 ecoregion-based assessments completed by The Nature Conservancy, and 35 state-based assessments completed by states as part of their State Wildlife Action Plan (13 states did not produce spatial maps). These plans identify areas with intact habitat, exemplary natural communities, viable rare species populations or other important biodiversity features. Also included is recent information from the Natural Heritage Network and other sources of high quality species and community occurrences, and protected land managed for biodiversity and natural processes (GAP 1). This assessment ensures that the network encompasses the footprint of current biodiversity areas while integrating them with representative abiotic features which underpin that biodiversity, ensuring that networks of resilient sites are distributed across all abiotic ‘stages’ needed to conserve future biodiversity. This location is in an area that is unrecognized as a biodiversity value area.</tr>");
                                    }
                                    else{
                                        var rbvSingleTemplate = new InfoTemplate("Recognized Biodiversity Value", "<tr>This map is based on the results of 67 ecoregion-based assessments completed by The Nature Conservancy, and 35 state-based assessments completed by states as part of their State Wildlife Action Plan (13 states did not produce spatial maps). These plans identify areas with intact habitat, exemplary natural communities, viable rare species populations or other important biodiversity features. Also included is recent information from the Natural Heritage Network and other sources of high quality species and community occurrences, and protected land managed for biodiversity and natural processes (GAP 1). This assessment ensures that the network encompasses the footprint of current biodiversity areas while integrating them with representative abiotic features which underpin that biodiversity, ensuring that networks of resilient sites are distributed across all abiotic ‘stages’ needed to conserve future biodiversity. This location is in an  <b>" + pixelDesc + "</b> area of recognized biodiversity value.</tr>");
                                    }
                                    feature.setInfoTemplate(rbvSingleTemplate);
                                }

                                //analytics event tracking
                                ga('send', 'event', {
                                   eventCategory:"Resilient Land",
                                   eventAction: "Identify click",
                                   eventLabel: idLayer
                                });
                            return feature;
                            }
                        });
                    });

                    map.infoWindow.setFeatures([deferred]);
                    map.infoWindow.show(event.mapPoint);

                }
            }
//End Identify task functions*************************************


//Geolocation functions******************************

            if (app.useGeolocate === true){
                function orientationChanged() {
                    if(map){
                      map.reposition();
                      map.resize();
                    }
                }
                function locationError(error) {
                  //error occurred so stop watchPosition
                    if( navigator.geolocation ) {
                        navigator.geolocation.clearWatch(watchId);
                    }
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                        alert("Location not provided");
                        break;

                    case error.POSITION_UNAVAILABLE:
                       alert("Current location not available");
                        break;
                    case error.TIMEOUT:
                        alert("Timeout");
                        break;

                    default:
                      alert("unknown error");
                      break;
                  }
                }

                function zoomToLocation(location) {
                    var pt = new Point(location.coords.longitude, location.coords.latitude);
                    addGraphic(pt);
                    map.centerAndZoom(pt, 12);
                }

                function showLocation(location) {
                    //zoom to the users location and add a graphic
                    var pt = new Point(location.coords.longitude, location.coords.latitude);
                    if ( !graphic ) {
                        addGraphic(pt);
                    } else { // move the graphic if it already exists
                        graphic.setGeometry(pt);
                    }
                    map.centerAt(pt);
                }

                function addGraphic(pt){
                    var symbol = new SimpleMarkerSymbol(
                        SimpleMarkerSymbol.STYLE_CIRCLE,
                        12,
                        new SimpleLineSymbol(
                            SimpleLineSymbol.STYLE_SOLID,
                            new Color([210, 105, 30, 0.5]),
                            8
                        ),
                        new Color([210, 105, 30, 0.9])
                    );
                    graphic = new Graphic(pt, symbol);
                    map.graphics.add(graphic);
                }
            }
//End Geolocation functions**************************


//GP service functions*******************************
            function uploadFile() {
//                console.log("uploading file!");
                var requestHandle = esri.request({
                    url: app.gpUploadURL,
                    form: dojo.byId("uploadForm"),
                        content : {
                            f : "json"
                        },
                    load: uploadSucceeded
                });
            }

            function uploadSucceeded(response) {
                // console.log(response);
                var itemID = response.item.itemID;
                // console.log(itemID);
                app.useCarbon =$("#carbonCheck").is(":checked");
                app.showCarbonResults = app.useCarbon;
                //submit the GP Task by passing the itemID info the input parameter
                var params = {'Parcel_as_Zipped_Shapefile': "{'itemID':" + itemID + "}", 'Polygon_ID':"Name", 'loggedIn':app.loggedIn, 'useCarbon':app.useCarbon, 'nationalState':app.nationalState};
                // console.log(params);
                app.gp.submitJob(params, completeCallback, statusCallback, function(error){
                    alert(error);
                });
                if (app.resultDialog){
                    app.resultDialog.destroy()
                    app.resultDialog = new Dialog({
                    id: "resultDialog",
                        title: "Resilient Land Summary",
                        style: {
                            width : "750px",
                            height: "800px",
                            maxWidth: "750px",
                            overflow: "auto"
                        }
                    });
                }
            }

            function completeCallback(jobInfo){
                if(jobInfo.jobStatus !== "esriJobFailed"){
                    // console.log("getting data");
                    app.gp.getResultData(jobInfo.jobId, "Result", displayResult);
                    statusCallbackIterator = 0;
                }
            }


            function completeFSCallback(jobInfo){
                if(jobInfo.jobStatus !== "esriJobFailed"){
                    // console.log("getting data");
                    app.gpFS.getResultData(jobInfo.jobId, "zone", getZone);
                    app.gpFS.getResultData(jobInfo.jobId, "Result", displayResult);

                    statusCallbackIterator = 0;
                }
            }
            function getZone(zone, message){
              app.analysisZone = zone.value;
              if (app.analysisZone != "CONUS"){
                app.showCarbonResults = false;
              }
            }

            function displayResult(result, messages){
            	//show button that reopens results
            	var showResultButtonDiv = document.getElementById('reopenRes');
            	showResultButtonDiv.style.display='block';
		            document.getElementById('gpResults').style.display = "block";
                var gpResultDiv = dom.byId('gpResults');
                gpResultDiv.innerHTML = "";

                var feats = result.value.features;
                // console.log(feats);

                app.grResCat = undefined;
                app.grResVal = undefined;
                app.grLDCat = undefined;
                app.grLDVal = undefined;
                app.grLCCat = undefined;
                app.grLCVal = undefined;
                app.forestCarbon2010SumVal = undefined;
                app.forestCarbon2010MeanVal = undefined;
                app.forestCarbon2050SumVal =undefined;
                app.forestCarbon2050MeanVal =undefined;
                app.soilCarbonSumVal =undefined;
                app.soilCarbonMeanVal =undefined;
                app.soilCarbonNoForestSumVal =undefined;
                app.soilCarbonNoForestMeanVal =undefined;
                app.forestCarbonSeqSumVal =undefined;
                app.forestCarbonSeqMeanVal =undefined;
                app.forestSoilProperSum=undefined;
                app.grElevVal=undefined;
                app.grElevValFt =undefined;
                app.useCoastal = false;


                var resConnTextVals = {};
                var coastalTextVals = {};
                var resTabAreaTextVals = {};
                var lcTabAreaTextVals = {};
                var ldTabAreaTextVals = {};
                var nlcdTabAreaTextVals = {};
                var forCarbTabAreaTextVals = {};
                var securedTabAreaVals = {};
                var biodivVals = {};
                var flowVals = {}

                var aboveBelow;
                var geoDict = {};
                var i = 0;
                var landAcres = [];

                for (var feat in feats){

                    var metric = result.value.features[feat].attributes.Metric;
                    var unit = result.value.features[feat].attributes.Unit;

                    if ((metric) === "Regions"){
                        app.regions = unit;
                    }
                    if (metric === "Ecoregions"){
                        app.ecoregions = unit;
                    }
                }
                // console.log(app.regions)
                for (var feat in feats){
                    //get each of the results
                    var br = document.createElement("br");
                    var val = result.value.features[feat].attributes.ResultValue;
                    var metric = result.value.features[feat].attributes.Metric;
                    var unit = result.value.features[feat].attributes.Unit;

                    var acreVal = Math.max(roundNumber(val*0.000247105, 2));

                    //*********Text format for Dojo Dialog************************
                    //resilience, LC, & LD categorical values.  Calc total acres from resilience
                    //CA
                    if (metric.includes("Res_A_0___20")){resTabAreaTextVals["0 - 20 Percentile"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric.includes("Res_A_20___40")){resTabAreaTextVals["20 - 40 Percentile"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric.includes("Res_A_40___60")){resTabAreaTextVals["40 - 60 Percentile"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric.includes("Res_A_60___80")){resTabAreaTextVals["60 - 80 Percentile"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric.includes("Res_A_80___100")){resTabAreaTextVals["80 - 100 Percentile"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}

                    //normal
                    else if (metric === "Res_FAR_ABOVE_AVERAGE_RESILIENCE"){resTabAreaTextVals["Far Above Average"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_ABOVE_AVERAGE_RESILIENCE"){resTabAreaTextVals["Above Average"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_SLIGHTLY_ABOVE_AVERAGE_RESILIENCE"){resTabAreaTextVals["Slightly Above Average"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_AVERAGE_RESILIENCE"){resTabAreaTextVals["Average"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_SLIGHTLY_BELOW_AVERAGE"){resTabAreaTextVals["Slightly Below Average"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    //one version of the data "_RESILIENCE" was missing
                    else if (metric === "Res_SLIGHTLY_BELOW_AVERAGE_RESILIENCE"){resTabAreaTextVals["Slightly Below Average"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_BELOW_AVERAGE_RESILIENCE"){resTabAreaTextVals["Below Average"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_FAR_BELOW_AVERAGE_RESILIENCE"){resTabAreaTextVals["Far Below Average"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}

                    //coastal
                    else if (metric === "Res_ABOVE_AVERAGE_RESILIENCE_TIDAL_HABITAT"){resTabAreaTextVals["Above Average Resilience Tidal Habitat"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_FAR_ABOVE_AVERAGE_MARSH_MIGRATION_SPACE"){resTabAreaTextVals["Resilient Migration Space for Tidal Habitat"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_ABOVE_AVERAGE_MARSH_MIGRATION_SPACE"){resTabAreaTextVals["Resilient Migration Space for Tidal Habitat"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_SLIGHTLY_ABOVE_AVERAGE_MARSH_MIGRATION_SPACE"){resTabAreaTextVals["Resilient Migration Space for Tidal Habitat"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_RESILIENT_TIDAL_HABITAT"){resTabAreaTextVals["Resilient Tidal Habitat"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_VULNERABLE_TIDAL_HABITAT"){resTabAreaTextVals["Vulnerable Tidal Habitat"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_SEA_LEVEL_RISE_AREA"){resTabAreaTextVals["Sea Level Rise Area"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_MIGRATION_SPACE_FOR_TIDAL_HABITAT"){resTabAreaTextVals["Migration Space for Tidal Habitat"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}

                    //other
                    else if (metric === "Res_DEVELOPED"){resTabAreaTextVals["Developed"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_GLACIER"){resTabAreaTextVals["Glacier"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}
                    else if (metric === "Res_PIONEER_LAVA"){resTabAreaTextVals["Pioneer Lava"] = acreVal;
                        var acres = Math.max(roundNumber(val*0.000247105, 2)); landAcres.push(acres);}



                    else if (metric.includes("LC_A_0___20")){lcTabAreaTextVals["0 - 20 Percentile"] = acreVal; }
                    else if (metric.includes("LC_A_20___40")){lcTabAreaTextVals["20 - 40 Percentile"] = acreVal; }
                    else if (metric.includes("LC_A_40___60")){lcTabAreaTextVals["40 - 60 Percentile"] = acreVal; }
                    else if (metric.includes("LC_A_60___80")){lcTabAreaTextVals["60 - 80 Percentile"] = acreVal; }
                    else if (metric.includes("LC_A_80___100")){lcTabAreaTextVals["80 - 100 Percentile"] = acreVal; }
                    else if (metric.includes("LC_DEVELOPED")){lcTabAreaTextVals["Developed"] = acreVal; }
                    else if (metric === "LC_FAR_ABOVE_AVERAGE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Far Above Average"] = acreVal; }
                    else if (metric === "LC_ABOVE_AVERAGE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Above Average"] = acreVal; }
                    else if (metric === "LC_SLIGHTLY_ABOVE_AVERAGE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Slightly Above Average"] = acreVal; }
                    else if (metric === "LC_AVERAGE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Average"] = acreVal; }
                    else if (metric === "LC_SLIGHTLY_BELOW_AVERAGE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Slightly Below Average"] = acreVal; }
                    else if (metric === "LC_BELOW_AVERAGE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Below Average"] = acreVal; }
                    else if (metric === "LC_FAR_BELOW_AVERAGE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Far Below Average"] = acreVal; }
                    else if (metric === "LC_MOST_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Most local connectedness"] = acreVal; }
                    else if (metric === "LC_MORE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["More local connectedness"] = acreVal; }
                    else if (metric === "LC_SLIGHTLY_MORE_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Slightly more local connectedness"] = acreVal; }
                    else if (metric === "LC_AVERAGE_MEDIAN_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Average/Median local connectedness"] = acreVal; }
                    else if (metric === "LC_SLIGHTLY_LESS_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Slightly less local connectedness"] = acreVal; }
                    else if (metric === "LC_LESS_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Less local connectedness"] = acreVal; }
                    else if (metric === "LC_LEAST_LOCAL_CONNECTEDNESS"){lcTabAreaTextVals["Least local connectedness"] = acreVal; }
                    else if (metric === "LC_GLACIER"){lcTabAreaTextVals["Glacier"] = acreVal; }
                    else if (metric === "LC_PIONEER_LAVA"){lcTabAreaTextVals["Pioneer Lava"] = acreVal; }
                    else if (metric === "LC_DEVELOPED"){lcTabAreaTextVals["Developed"] = acreVal; }

                    else if (metric.includes("LD_A_0___20")){ldTabAreaTextVals["0 - 20 Percentile"] = acreVal; }
                    else if (metric.includes("LD_A_20___40")){ldTabAreaTextVals["20 - 40 Percentile"] = acreVal; }
                    else if (metric.includes("LD_A_40___60")){ldTabAreaTextVals["40 - 60 Percentile"] = acreVal; }
                    else if (metric.includes("LD_A_60___80")){ldTabAreaTextVals["60 - 80 Percentile"] = acreVal; }
                    else if (metric.includes("LD_A_80___100")){ldTabAreaTextVals["80 - 100 Percentile"] = acreVal; }
                    else if (metric.includes("LD_DEVELOPED")){ldTabAreaTextVals["Developed"] = acreVal; }
                    else if (metric === "LD_FAR_ABOVE_AVERAGE_LANDSCAPE_DIVERSITY"){ldTabAreaTextVals["Far Above Average"] = acreVal; }
                    else if (metric === "LD_ABOVE_AVERAGE_LANDSCAPE_DIVERSITY"){ldTabAreaTextVals["Above Average"] = acreVal; }
                    else if (metric === "LD_SLIGHTLY_ABOVE_AVERAGE_LANDSCAPE_DIVERSITY"){ldTabAreaTextVals["Slightly Above Average"] = acreVal; }
                    else if (metric === "LD_AVERAGE_LANDSCAPE_DIVERSITY"){ldTabAreaTextVals["Average"] = acreVal; }
                    else if (metric === "LD_SLIGHTLY_BELOW_AVERAGE_LANDSCAPE_DIVERSITY"){ldTabAreaTextVals["Slightly Below Average"] = acreVal; }
                    else if (metric === "LD_BELOW_AVERAGE_LANDSCAPE_DIVERSITY"){ldTabAreaTextVals["Below Average"] = acreVal; }
                    else if (metric === "LD_FAR_BELOW_AVERAGE_LANDSCAPE_DIVERSITY"){ldTabAreaTextVals["Far Below Average"] = acreVal; }
                    else if (metric === "LD_GLACIER"){ldTabAreaTextVals["Glacier"] = acreVal; }
                    else if (metric === "LD_PIONEER_LAVA"){ldTabAreaTextVals["Pioneer Lava"] = acreVal; }
                    else if (metric === "LD_DEVELOPED"){ldTabAreaTextVals["Developed"] = acreVal; }
                    // }

                    if (metric === "Landscape Diversity"){
                        app.grLDVal = roundNumber(val+0.00001, 2);
                        app.grLDCat = binScores(app.grLDVal);
                    }
                    else if (metric === "Local Connectedness"){
                        app.grLCVal = roundNumber(val+0.00001, 2);
                        app.grLCCat = binScores(app.grLCVal);
                    }
                    else if (metric === "Terrestrial Resilience"){
                        app.grResVal = roundNumber(val+0.00001, 2);
                        app.grResCat = binScores(app.grResVal);
                    }

                    else if (metric === "Sum Forest Carbon 2010"){
                        app.forestCarbon2010SumVal = roundNumber(val, 0);
                    }
                    else if (metric === "Mean Forest Carbon 2010"){
                        app.forestCarbon2010MeanVal = roundNumber(val * 4.49651111111, 1);
                    }
                    else if (metric === "Sum Forest Carbon 2050"){
                        app.forestCarbon2050SumVal = roundNumber(val, 0);
                    }
                    else if (metric === "Mean Forest Carbon 2050"){
                        app.forestCarbon2050MeanVal = roundNumber(val * 4.49651111111, 1);
                    }
                    else if (metric === "Soil Carbon Sum"){
                        app.soilCarbonSumVal = roundNumber(val, 0);
                    }
                    else if (metric === "Soil Carbon Mean"){
                        app.soilCarbonMeanVal = roundNumber(val * 4.49651111111, 1);
                    }
                    else if (metric === "Soil Carbon Sum (No Forest)"){
                        app.soilCarbonNoForestSumVal = roundNumber(val, 0);
                    }
                    else if (metric === "Soil Carbon Mean (No Forest)"){
                        app.soilCarbonNoForestMeanVal = roundNumber(val * 4.49651111111, 1);
                    }

                    else if (metric === "Sum Forest Carbon ABG 2010"){forCarbTabAreaTextVals["Aboveground Wood 2010"] = val;}
                    else if (metric === "Sum Forest Carbon CWD 2010"){forCarbTabAreaTextVals["Coarse Woody Debris 2010"] = val;}
                    else if (metric === "Sum Forest Carbon ABG 2050"){forCarbTabAreaTextVals["Aboveground Wood 2050"] = val;}
                    else if (metric === "Sum Forest Carbon CWD 2050"){forCarbTabAreaTextVals["Coarse Woody Debris 2050"] = val;}

                    //NLCD
                    else if (metric === "NLCD_OPEN_WATER"){nlcdTabAreaTextVals["Open Water"] = acreVal; }
                    else if (metric === "NLCD_PERRENIAL_SNOW_ICE"){nlcdTabAreaTextVals["Perrenial Snow/Ice"] = acreVal; }
                    else if (metric === "NLCD_DEVELOPED__OPEN_SPACE"){nlcdTabAreaTextVals["Developed, Open Space"] = acreVal; }
                    else if (metric === "NLCD_DEVELOPED__LOW_INTENSITY"){nlcdTabAreaTextVals["Developed, Low Intensity"] = acreVal; }
                    else if (metric === "NLCD_DEVELOPED__MEDIUM_INTENSITY"){nlcdTabAreaTextVals["Developed, Medium Intensity"] = acreVal; }
                    else if (metric === "NLCD_DEVELOPED__HIGH_INTENSITY"){nlcdTabAreaTextVals["Developed, High Intensity"] = acreVal; }
                    else if (metric === "NLCD_BARREN_LAND"){nlcdTabAreaTextVals["Barren Land"] = acreVal; }
                    else if (metric === "NLCD_DECIDUOUS_FOREST"){nlcdTabAreaTextVals["Deciduous Forest"] = acreVal; }
                    else if (metric === "NLCD_EVERGREEN_FOREST"){nlcdTabAreaTextVals["Evergreen Forest"] = acreVal; }
                    else if (metric === "NLCD_MIXED_FOREST"){nlcdTabAreaTextVals["Mixed Forest"] = acreVal; }
                    else if (metric === "NLCD_SHRUB_SCRUB"){nlcdTabAreaTextVals["Shrub/Scrub"] = acreVal; }
                    else if (metric === "NLCD_HERBACEUOUS"){nlcdTabAreaTextVals["Herbaceous"] = acreVal; }
                    else if (metric === "NLCD_HAY_PASTURE"){nlcdTabAreaTextVals["Hay/Pasture"] = acreVal; }
                    else if (metric === "NLCD_CULTIVATED_CROPS"){nlcdTabAreaTextVals["Cultivated Crops"] = acreVal; }
                    else if (metric === "NLCD_WOODY_WETLANDS"){nlcdTabAreaTextVals["Woody Wetlands"] = acreVal; }
                    else if (metric === "NLCD_EMERGENT_HERBACEOUS_WETLANDS"){nlcdTabAreaTextVals["Emergent Herbaceous Wetlands"] = acreVal; }

                    else if (metric === "Elevation"){
                            app.grElevVal = roundNumber(val, 2);
                            app.grElevValFt = roundNumber(val*3.28084, 2);;
                    }

                    //new RCN
                    else if (metric === "MOSTLY_RESILIENT__CONCENTRATED_FLOW"){resConnTextVals["Mostly Resilient, Concentrated Flow"] = acreVal; }
                    else if (metric === "RESILIENT__RECOGNIZED_BIODIVERSITY"){resConnTextVals["Resilient, Recognized Biodiversity"] = acreVal; }
                    else if (metric === "RESILIENT__DIFFUSE_FLOW__CLIMATE_INFORMED_"){resConnTextVals["Resilient, Diffuse Flow (Climate Informed)"] = acreVal; }
                    else if (metric === "RESILIENT__DIFFUSE_FLOW"){resConnTextVals["Resilient, Diffuse Flow"] = acreVal; }
                    else if (metric === "OUTSIDE_PRIORITIZED_NETWORK"){resConnTextVals["Outside Prioritized Network"] = acreVal; }
                    else if (metric === "MOSTLY_RESILIENT__CONCENTRATED_FLOW__RECOGNIZED_BIODIVERSITY"){resConnTextVals["Mostly Resilient, Concentrated Flow, Recognized Biodiversity"] = acreVal; }
                    else if (metric === "RESILIENT_COASTAL_MIGRATION_SPACE"){resConnTextVals["Resilient Coastal Migration Space"] = acreVal; }
                    else if (metric === "RESILIENT__DIFFUSE_FLOW__CLIMATE_INFORMED___RECOGNIZED_BIODIVERS"){resConnTextVals["Resilient, Diffuse Flow (Climate Informed), Recognized Biodiversity Value"] = acreVal; }
                    else if (metric === "RESILIENT__CONCENTRATED_FLOW__CLIMATE_INFORMED___RECOGNIZED_BIOD"){resConnTextVals["Resilient, Concentrated Flow (Climate Informed), Recognized Biodiversity"] = acreVal; }
                    else if (metric === "RESILIENT__DIFFUSE_FLOW__RECOGNIZED_BIODIVERSITY"){resConnTextVals["Resilient, Diffuse Flow, Recognized Biodiversity"] = acreVal; }
                    else if (metric === "ADDITIONAL_RESILIENT_SECURED__GAP_3_"){resConnTextVals["Additional Resilient Secured (GAP 3)"] = acreVal; }
                    else if (metric === "RESILIENT__CONCENTRATED_FLOW__CLIMATE_INFORMED_"){resConnTextVals["Resilient, Concentrated Flow (Climate Informed)"] = acreVal; }
                    else if (metric === "DIFFUSE_FLOW__RECOGNIZED_BIODIVERSITY_VALUE"){resConnTextVals["Diffuse Flow, Recognized Biodiversity Value"] = acreVal; }
                    else if (metric === "FLOW_AND_RECOGNIZED_BIODIVERSITY"){resConnTextVals["Flow and Recognized Biodiversity"] = acreVal; }
                    else if (metric === "RESTORATION_SITES"){resConnTextVals["Restoration Sites"] = acreVal; }

                    else if (metric === "GAP_S_3"){securedTabAreaVals["GAP 3"] = acreVal;}
                    else if (metric === "GAP_S_2"){securedTabAreaVals["GAP 2"] = acreVal;}
                    else if (metric === "GAP_S_1"){securedTabAreaVals["GAP 1"] = acreVal;}

                    // else if (metric === "Bio_NO_RECOGNIZED_BIODIVERSITY"){biodivVals["No Recognized Biodiversity"] = acreVal;} //don't show no recognized biodiversity
                    else if (metric === "Bio_STATE_BASED"){biodivVals["State-based"] = acreVal;}
                    else if (metric === "Bio_ECOREGION_BASED"){biodivVals["Ecoregion-based"] = acreVal;}
                    else if (metric === "Bio_ECOREGION_AND_STATE_BASED"){biodivVals["Ecoregion and State-based"] = acreVal;}
                    else if (metric === "Bio_ADDITIONAL_HABITAT_AND_SPECIES__NOT_STATE_OR_ECOREGION_BASED_"){biodivVals["Additional Habitat and Species"] = acreVal;}
                    else if (metric === "Bio_UNRECOGNIZED_BIODIVERSITY_VALUE"){biodivVals["Unrecognized Biodiversity Value"] = acreVal;}

                    else if (metric === "Flow_FAR_ABOVE_AVERAGE_FLOW"){flowVals["Far Above Average Flow"] = acreVal;}
                    else if (metric === "Flow_ABOVE_AVERAGE_FLOW"){flowVals["Above Average Flow"] = acreVal;}
                    else if (metric === "Flow_SLIGHTLY_ABOVE_AVERAGE_FLOW"){flowVals["Slightly Above Average Flow"] = acreVal;}
                    else if (metric === "Flow_AVERAGE_FLOW"){flowVals["Average Flow"] = acreVal;}
                    else if (metric === "Flow_SLIGHTLY_BELOW_AVERAGE_FLOW"){flowVals["Slightly Below Average Flow"] = acreVal;}
                    else if (metric === "Flow_BELOW_AVERAGE_FLOW"){flowVals["Below Average Flow"] = acreVal;}
                    else if (metric === "Flow_FAR_BELOW_AVERAGE_FLOW"){flowVals["Far Below Average Flow"] = acreVal;}

                    else if (metric === "Total Acres"){app.sumTotalAcres = val; console.log(app.sumTotalAcres)}

                    else if (app.geoDicts.newNamePrettyName.hasOwnProperty(metric) === true){
                      geoDict[metric] = val;
                    }

                    // console.log(app.geoDicts.newNamePrettyName)
                    //if there's no portion outside the RCN, set this to zero, otherwise NaN causes errors later
                    if(isNaN(resConnTextVals["Outside Prioritized Network"])){
                      resConnTextVals["Outside Prioritized Network"] = 0
                    }
                }

                const arrSum = arr => arr.reduce((a,b) => a + b, 0);
                app.sumLandAcres = arrSum(landAcres);

                //if biodiversity values don't == the sum total, make the difference unreognized biodiversity.  AK & HI don't include and "Unrecognized" class in teh data
                var bioAreas = []
                for (const [key, value] of Object.entries(biodivVals)) {
                  bioAreas.push(value)
                }
                const bioAreaSum = bioAreas.reduce((partialSum, a) => partialSum + a, 0);
                console.log(bioAreas)
                console.log(app.sumTotalAcres)
                console.log(bioAreaSum)
                if (biodivVals["Unrecognized Biodiversity Value"] == undefined){
                  biodivVals["Unrecognized Biodiversity Value"] = app.sumTotalAcres - bioAreaSum
                }

                //calc other carbon values
                if (app.useCarbon && Object.keys(forCarbTabAreaTextVals).length > 0){
                    forCarbTabAreaTextVals["Belowground/Other 2010"] = app.forestCarbon2010SumVal - forCarbTabAreaTextVals["Aboveground Wood 2010"] - forCarbTabAreaTextVals["Coarse Woody Debris 2010"];
                    forCarbTabAreaTextVals["Belowground/Other 2050"] = app.forestCarbon2050SumVal - forCarbTabAreaTextVals["Aboveground Wood 2050"] - forCarbTabAreaTextVals["Coarse Woody Debris 2050"];
                    app.forestCarbonSeqSumVal = app.forestCarbon2050SumVal - app.forestCarbon2010SumVal;
                    app.forestCarbonSeqMeanVal = roundNumber(app.forestCarbon2050MeanVal - app.forestCarbon2010MeanVal, 1);
                    app.forestCarbonAnnualSeqRate = roundNumber(app.forestCarbonSeqSumVal/40, 1);
                    app.forestCarbonAvgAnnualSeqRate = roundNumber(((app.forestCarbon2050SumVal-app.forestCarbon2010SumVal)/app.sumTotalAcres / 40), 1);
                    if (app.forestCarbon2010SumVal === undefined){app.forestCarbon2010SumVal = 0;}
                    if (app.soilCarbonNoForestSumVal === undefined){app.soilCarbonNoForestSumVal = 0;}
                    app.forestSoilProperSum = app.forestCarbon2010SumVal + app.soilCarbonNoForestSumVal;
                }

                //get the sum of the resConn area values.  If these don't match the totalSumAcres, add the different to Vulnerable Lands Otside network
                var resConnAcreVals = [];
                for (var key in resConnTextVals){

                    resConnAcreVals.push(Number(resConnTextVals[key]));
                }

                var sumResConAcres = arrSum(resConnAcreVals);
                var extraOutsideNetwork = app.sumTotalAcres - sumResConAcres;
                if (extraOutsideNetwork <0){extraOutsideNetwork = 0;}

                if (isNaN(extraOutsideNetwork) === false && extraOutsideNetwork >0){
                    resConnTextVals["Outside Prioritized Network"] = resConnTextVals["Outside Prioritized Network"] + Math.max(roundNumber(extraOutsideNetwork, 1));
                }


                //get the geology area for each type and calulate the total area
                var geoArea = 0;
                for (var key in resConnTextVals) {
                    geoArea += Number(resConnTextVals[key]);
                }
                //if polygon is located outside the extent of the resilient & connected data use Geology to get total area
                if (geoArea ===0){
                  for (var key in geoDict) {
                      geoArea += Math.max(roundNumber(geoDict[key]*0.000247105), 1);
                  }
                }


                var geoPieText = "";
                var geoText = "";
                var geoValList = [];
                var resConnValList = [];
                var coastalValList = [];
                var geoSummData = [];
                var geoRawValList = [];
                var resConnRawValList = [];
                var coastalRawValList = [];
                var resTabAreaRawValList = [];
                var flowTabAreaRawValList = [];
                var biodivTabAreaRawValList = [];
                var lcTabAreaRawValList = [];
                var ldTabAreaRawValList = [];
                var nlcdTabAreaRawValList = [];
                var forCarbTabAreaRawValList = [];
                var resTabAreaValList = [];
                var flowTabAreaValList = [];
                var biodivTabAreaValList = [];
                var lcTabAreaValList = [];
                var ldTabAreaValList = [];
                var nlcdTabAreaValList = [];

                //calculate the % area and add it to the geology dictionary, if there is geology data
                if (Object.keys(geoDict).length >0){
                  for (var key in geoDict) {
                  	var rawVal = roundNumber(geoDict[key]* 0.000247105, 0); // convert sq meters to acres
                  	var tmp = {};
                  	var keyText = app.geoDicts.newNamePrettyName[key];
                    var photoName = app.geoDicts.photoNames[key];
                          if (typeof photoName === "undefined"){photoName = "noPhoto";}
                  	var geoPhoto = '<table align="center"><tr align="center"><td align="center"><img src="assets/' + photoName + '.JPG" alt="' + keyText + '" width="300" height="200"></td></tr></table>';
                    var percent = Number(geoDict[key]) / geoArea * 100; //use area based on sum of geophyiscal settings
                    geoRawValList.push(rawVal);
                    percent = roundNumber(percent+0.00001, 2);
                    geoDict[key] = percent;
                    geoValList.push(percent);
                    var text = keyText + " : <strong>" + geoDict[key] + "%</strong><br />";
                    geoPieText += text;
                    tmp.y = rawVal;
                    tmp.key = key;
                  	//tmp.text below creates labels with geo type and % -- looks horrible
                  	tmp.text = '<div align="center">' + keyText + '<br>' + percent +'%</div>';
                  	tmp.tooltip = geoPhoto + "\n" + keyText+ "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres";
                  	geoSummData.push(tmp);
                  }
                  console.log(geoSummData)
                }
                else{
                    var geoPieText = "The user supplied polygon is outside the extent of the geophysical settings data.";
                }

                //get pie chart data for resilient and connected landscape
                var resConnPieData = [];
                if (Object.keys(resConnTextVals).length >0){
                    for (var key in resConnTextVals) {
                        var rawVal = resConnTextVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (app.sumTotalAcres) * 100;  //use area based on total (sum of terrestrial & coastal)
                        resConnRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001,1);
                        resConnValList.push(percent);
                        tmp.y = rawVal;
                        tmp.key = key;
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres (" + percent + "%)";
                        resConnPieData.push(tmp);
                    }
                }



                //get pie chart data for coastal resilience sites
                var coastalPieData = [];
                if (Object.keys(coastalTextVals).length >0){
                    app.useCoastal = true;
                    for (var key in coastalTextVals) {
                        var rawVal = coastalTextVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (coastalAcres) * 100;  //use area based on total coastal area
                        coastalRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001, 1);
                        coastalValList.push(percent);
                        tmp.y = rawVal;
                        tmp.key = key;
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres (" + percent + "%)";
                        coastalPieData.push(tmp);
                    }
                    // console.log(coastalPieData);
                }

                //get pie chart data for flow tab area
                flowPieData =[];
                if (Object.keys(flowVals).length >0){
                    app.useFlowTabArea = true;
                    for (var key in flowVals) {
                        var rawVal = flowVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (app.sumTotalAcres) * 100;  //use area based on total coastal area
                        flowTabAreaRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001, 1);
                        flowTabAreaValList.push(percent);
                        tmp.y = rawVal;
                        tmp.key = key;
                        var sortNum = addSort(key);
                        tmp.sortNum = sortNum;
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres (" + percent + "%)";
                        flowPieData.push(tmp);
                    }
                    flowPieData = flowPieData.sort(compareValues('sortNum', 'desc'));

                }


                //get pie chart data for biodiversity tab area
                biodivPieData =[];
                console.log(biodivVals)
                if (Object.keys(biodivVals).length >0){
                    app.useBiodivTabArea = true;
                    for (var key in biodivVals) {
                        var rawVal = biodivVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (app.sumTotalAcres) * 100;  //use area based on total coastal area
                        biodivTabAreaRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001, 1);
                        biodivTabAreaValList.push(percent);
                        tmp.y = rawVal;
                        tmp.key = key;
                        var sortNum = addSort(key);
                        tmp.sortNum = sortNum;
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres (" + percent + "%)";
                        biodivPieData.push(tmp);
                    }
                    biodivPieData = biodivPieData.sort(compareValues('sortNum', 'desc'));

                }


                //get pie chart data for resilience tab area
                var resPieData = [];
                // console.log(resTabAreaTextVals)
                if (Object.keys(resTabAreaTextVals).length >0){
                    app.useResTabArea = true;
                    for (var key in resTabAreaTextVals) {
                        var rawVal = resTabAreaTextVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (app.sumTotalAcres) * 100;  //use area based on total coastal area
                        resTabAreaRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001, 1);
                        resTabAreaValList.push(percent);
                        tmp.y = rawVal;
                        tmp.key = key;
                        var sortNum = addSort(key);
                        tmp.sortNum = sortNum;
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres (" + percent + "%)";
                        resPieData.push(tmp);
                    }
                    resPieData = resPieData.sort(compareValues('sortNum', 'desc'));
                    // console.log(resPieData);
                }


                //get pie chart data for resilience tab area
                var lcPieData = [];
                if (Object.keys(lcTabAreaTextVals).length >0){
                    app.useLCTabArea = true;
                    for (var key in lcTabAreaTextVals) {
                        var rawVal = lcTabAreaTextVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (app.sumTotalAcres) * 100;  //use area based on total coastal area
                        lcTabAreaRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001, 1);
                        lcTabAreaValList.push(percent);
                        tmp.y = rawVal;
                        tmp.key = key;
                        var sortNum = addSort(key);
                        tmp.sortNum = sortNum;
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres (" + percent + "%)";
                        lcPieData.push(tmp);
                    }
                    lcPieData = lcPieData.sort(compareValues('sortNum', 'desc'));
                    // console.log(lcPieData);
                }


                //get pie chart data for resilience tab area
                var ldPieData = [];
                if (Object.keys(ldTabAreaTextVals).length >0){
                    app.useLDTabArea = true;
                    for (var key in ldTabAreaTextVals) {
                        var rawVal = ldTabAreaTextVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (app.sumTotalAcres) * 100;  //use area based on total coastal area
                        ldTabAreaRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001, 1);
                        ldTabAreaValList.push(percent);
                        tmp.y = rawVal;
                        tmp.key = key;
                        var sortNum = addSort(key);
                        tmp.sortNum = sortNum;
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres (" + percent + "%)";
                        ldPieData.push(tmp);
                    }
                    ldPieData = ldPieData.sort(compareValues('sortNum', 'desc'));
                    // console.log(ldPieData);
                }

                //get pie chart data for NLCD tab area
                //get the sum of the nlcd area values.  If these don't match the totalSumAcres, add the different to Vulnerable Lands Otside network
                var nlcdAcreVals = [];
                for (var key in nlcdTabAreaTextVals){
                    nlcdAcreVals.push(Number(nlcdTabAreaTextVals[key]));
                }
                var totalNLCDAcres = arrSum(nlcdAcreVals);
                var nlcdPieData = [];
                if (Object.keys(nlcdTabAreaTextVals).length >0){
                    app.useNLCDTabArea = true;
                    for (var key in nlcdTabAreaTextVals) {
                        var rawVal = nlcdTabAreaTextVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (totalNLCDAcres) * 100;  //use area based on total coastal area
                        nlcdTabAreaRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001, 1);
                        nlcdTabAreaValList.push(percent);
                        tmp.y = rawVal;
                        tmp.key = key;
                        var sortNum = addSort(rawVal);
                        tmp.sortNum = sortNum;
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " acres (" + percent + "%)";
                        nlcdPieData.push(tmp);
                    }
                    nlcdPieData = nlcdPieData.sort(compareValues('sortNum', 'desc'));
                     // console.log(nlcdPieData);
                }

                //get pie chart data for forest carbon components
                //get the sum of the forest carbon area values.  If these don't match the totalSumAcres, add the different to Vulnerable Lands Otside network
                var forCarb2010TonsVals = [];
                var forCarb2050TonsVals = [];
                for (var key in forCarbTabAreaTextVals){
                    if (key.includes("2010")){
                        forCarb2010TonsVals.push(Number(forCarbTabAreaTextVals[key]));
                    }
                    if (key.includes("2050")){
                        forCarb2050TonsVals.push(Number(forCarbTabAreaTextVals[key]));
                    }
                }
               console.log(forCarbTabAreaTextVals)
                var totalForCarbTons = arrSum(forCarb2010TonsVals);
                var forCarbPieData2010 = [];
                var forCarbPieData2050 = [];
                if (Object.keys(forCarbTabAreaTextVals).length >0 && app.showCarbonResults){
                    app.useForCarbTabArea = true;
                    for (var key in forCarbTabAreaTextVals) {

                        var rawVal = forCarbTabAreaTextVals[key];
                        var tmp = {};
                        var percent = Number(rawVal) / (totalForCarbTons) * 100;  //use area based on total coastal area
                        forCarbTabAreaRawValList.push(rawVal);
                        percent = roundNumber(percent+0.00001, 1);
//                        forCarbTabAreaValList.push(percent);
//                        console.log(rawVal)
//                        console.log(percent)
                        tmp.y = rawVal;
                        tmp.key = key;
                        var sortNum = addSort(rawVal);
                        tmp.sortNum = sortNum;
                        if (key === "Belowground/Other 2010"){var k = "BG";}
                        if (key === "Aboveground Wood 2010" ){var k = "AG";}
                        if (key === "Coarse Woody Debris 2010"){var k = "CW";}
                        if (key === "Belowground/Other 2050"){var k = "BG";}
                        if (key === "Aboveground Wood 2050" ){var k = "AG";}
                        if (key === "Coarse Woody Debris 2050"){var k = "CW";}
                        //tmp.text below creates labels with category and % -- looks horrible
                        tmp.text = '<div class="forCarbPieLabel">' + k + '<br>' + numberWithCommas(roundNumber(rawVal, 0)) +' mt</div>';
                        tmp.tooltip = key + "</strong><br>" + numberWithCommas(roundNumber(rawVal, 0)) + " mt (" + percent + "%)";
                        if(key.includes("2010")){
                            forCarbPieData2010.push(tmp);
                        }
                        if(key.includes("2050")){
                            forCarbPieData2050.push(tmp);
                        }
                    }
                    forCarbPieData2010 = forCarbPieData2010.sort(compareValues('sortNum', 'desc'));
                    forCarbPieData2050 = forCarbPieData2050.sort(compareValues('sortNum', 'desc'));
                }



                //get 3 largest geophysical setting values.  convert to array and sort : https://stackoverflow.com/questions/1069666/sorting-javascript-object-by-property-value
                var topSettings = [];
                for (var setting in geoSummData) {
                    topSettings.push([geoSummData[setting].key, geoSummData[setting].y]);
                }
                topSettings.sort(function(a, b) {
                    return b[1] - a[1];
                });
                // console.log(topSettings);
                topSettings = topSettings.slice(0,3);
                for (var i = 0; i < topSettings.length; i++) {
                    if (topSettings[i][1]>0){
                        var hoverPhoto = "assets/" + app.geoDicts.photoNames[topSettings[i][0]] + ".JPG";
                        if (typeof photoName === "undefined"){hoverPhoto = "assets/noPhoto.JPG";}
    //                    geoText = geoText + "<p style='margin-bottom:5px; display:inline'>" + app.geoDicts.newNamePrettyName[topSettings[i][0]] + " <p style='display:inline;'><a class='hoverImage' href='#' data-image='" + hoverPhoto + "'><img src='assets/Camera.jpg' hspace='10'></a></p>: " + numberWithCommas(topSettings[i][1]) + " acres</p>";
                        geoText = geoText + "<p style='margin-bottom:5px; display:inline'>" + app.geoDicts.newNamePrettyName[topSettings[i][0]] + " <p style='display:inline;'></p>: " + numberWithCommas(roundNumber(topSettings[i][1], 0)) + " acres</p>";
                    }
                }


                //Format text for Dialog
                var geoTextIntro = string.substitute("<p>The mean elevation in the polygon is " + app.grElevVal + " m (" + app.grElevValFt + " ft) and the three most common geophysical settings are:<p>");
                if (app.sumLandAcres>0){
                    var resText = string.substitute('<div class="column-left"><p style="display:inline-block" align="center"><a href=\'coreConcepts_resScore.html\' onClick=\'return windowPopup(this, \"notes\")\'>Resilience</a><br> ${resultCat} (${resultVal} <a href=\'sd.html\' onClick=\'return windowPopup(this, \"SDnotes\")\'>SD</a>)</p><div id="resGaugeChart" class="power-gauge" style="display:inline-block; "></div></div>',{resultCat:app.grResCat, resultVal:app.grResVal});
                    var LCText = string.substitute('<div class="column-center"><p style="display:inline-block" align="center"><a href=\'coreConcepts_LC.html\' onClick=\'return windowPopup(this, \"notes\")\'>Local Connectedness</a><br> ${resultCat} (${resultVal} <a href=\'sd.html\' onClick=\'return windowPopup(this, \"SDnotes\")\'>SD</a>)</p><div id="lcGaugeChart" class="power-gauge" style="display:inline-block; "></div></div>',{resultCat:app.grLCCat, resultVal:app.grLCVal});
                    var LDText = string.substitute('<div class="column-right"><p style="display:inline-block" align="center"><a href=\'coreConcepts_LD.html\' onClick=\'return windowPopup(this, \"notes\")\'>Landscape Diversity</a><br> ${resultCat} (${resultVal} <a href=\'sd.html\' onClick=\'return windowPopup(this, \"SDnotes\")\'>SD</a>)</p><div id="ldGaugeChart" class="power-gauge" style="display:inline-block;  "></div></div>',{resultCat:app.grLDCat, resultVal:app.grLDVal});
                }
                else{
                    var resText = "<p>There are no terrestrial resilience data within the polygon.</p>";
                    var LCText = "";
                    var LDText = "";
                }


                //loop through resilient & connected landscape results and only include text if there's a result value
                var resConnGroup1 =["Resilient, Diffuse Flow (Climate Informed), Recognized Biodiversity Value","Resilient, Concentrated Flow (Climate Informed), Recognized Biodiversity", "Resilient, Diffuse Flow, Recognized Biodiversity", "Mostly Resilient, Concentrated Flow, Recognized Biodiversity" ];
                var resConnGroup2 = ["Resilient, Diffuse Flow", "Resilient, Diffuse Flow (Climate Informed)", "Mostly Resilient, Concentrated Flow", "Resilient, Concentrated Flow (Climate Informed)"];
                var resConnGroup3 = ["Diffuse Flow, Recognized Biodiversity Value", "Resilient, Recognized Biodiversity"];
                var group1Text = "";
                var group2Text = "";
                var group3Text = "";
                var otherText = "";
                var group1Vals = [];
                var group2Vals = [];
                var group3Vals = [];

                var resConnChartDiv = '<div align="center" style="float:right; margin-top: -17px; margin-left:20px"  class="printOverflow"><div id="resConnChartNode" align="left" style="width: 200px; height: 200px;"></div></div>';
                // console.log(resConnTextVals);
                var resConnText = "<div style='float:center'  class='printOverflow'>";
                if ($.isEmptyObject(resConnTextVals)){resConnText = "<p>The polygon is outside the extent of the Resilient and Connected Network data.</p>";}
                else{
                    for (var key in resConnTextVals){
                        if (resConnTextVals[key] !== "" && resConnTextVals[key] >0){
                            // console.log(key)
                            var txt =  string.substitute('<p><a href=\'coreConcepts_resConnDet.html\' onClick=\'return windowPopup(this, \"notes\")\'>${resultMetric}</a>: ${resultVal} ac.</p>',{resultMetric: key, resultVal:numberWithCommas(roundNumber(resConnTextVals[key], 1))});
                            if (resConnGroup1.includes(key)){
                                // console.log("in group 1")
                                group1Text += txt;
                                group1Vals.push(resConnTextVals[key])
                            }
                            else if (resConnGroup2.includes(key)){
                                // console.log("in group 2")
                                group2Text += txt;
                                group2Vals.push(resConnTextVals[key])
                            }
                            else if (resConnGroup3.includes(key)){
                                // console.log("in group 3")
                                group3Text += txt;
                                group3Vals.push(resConnTextVals[key])
                            }
                            else{
                                otherText += txt;
                            }
                        }
                    }
                    var resConnResults = "<h3>Resilience, Flow and Recognized Biodiversity: " + numberWithCommas(roundNumber(arrSum(group1Vals), 1)) + " ac.</h3>" + group1Text + "<hr class='lightGray'><h3>Resilience and Flow: " + numberWithCommas(roundNumber(arrSum(group2Vals), 1)) + " ac.</h3>" + group2Text + "<hr class='lightGray'><h3>Resilience and Recognized Biodiversity: " + numberWithCommas(roundNumber(arrSum(group3Vals), 1)) + " ac.</h3>" + group3Text +"<hr class='lightGray'>" + otherText;
                    resConnText = "<table><tr><td>" + resConnResults + "</td><td>" + resConnChartDiv +"</td></tr></table></div>";

                }

                //loop through coastal results and only include text if there's a result value
                if (app.useCoastal === true){
                    var coastalChartDiv = '<div align="center" style="float:right; margin-top: -17px; margin-left:20px"><div id="coastalChartNode" align="left" style="width: 200px; height: 200px;"></div></div>';
                    // console.log(coastalTextVals);
                    var coastalText = "<div style='float:left'>";
                    for (var key in coastalTextVals){
                        if (coastalTextVals[key] !== ""){
                            coastalText += string.substitute('<p><a href=\'coreConcepts_coastalMig.html\' onClick=\'return windowPopup(this, \"notes\")\'>${resultMetric}</a>: ${resultVal} Acres</p>',{resultMetric: key, resultVal:numberWithCommas(roundNumber(coastalTextVals[key], 0))});
                        }
                    }
                    coastalText += "</div>";
                    coastalText += coastalChartDiv;
                }

                //loop through resilience tab area results and only include text if there's a result value
                if (app.useResTabArea === true){
                    var resTabAreaChartDiv = '<div class="column-left"><p style="display:inline-block" align="center"><a href=\'coreConcepts_resScore.html\' onClick=\'return windowPopup(this, \"notes\")\'>Resilience</a><br></p><div id="resTabAreaChartNode"  style="width: 200px; height: 200px; display:inline-block"></div></div>';
                    var resTabAreaText = resTabAreaChartDiv;
                }


                //loop through biodiversity tab area results and only include text if there's a result value
                if (app.useBiodivTabArea === true){
                    var biodivTabAreaChartDiv = '<div class="column-left" style="padding-left: 75px;"><h3 style="display:inline-block" align="center"><a href=\'coreConcepts_rbv.html\' onClick=\'return windowPopup(this, \"notes\")\'>Biodiversity</a><br></h3><div id="biodivTabAreaChartNode"  style="width: 200px; height: 200px; display:inline-block"></div></div>';
                    var biodivText = biodivTabAreaChartDiv;
                }


                //loop through flow tab area results and only include text if there's a result value
                if (app.useFlowTabArea === true){
                    var flowTabAreaChartDiv = '<div class="column-right" style="padding-right: 75px;"><h3 style="display:inline-block" align="center"><a href=\'coreConcepts_cliFlow.html\' onClick=\'return windowPopup(this, \"notes\")\'>Connectivity and Climate Flow (Continuous)</a><br></h3><div id="flowTabAreaChartNode"  style="width: 200px; height: 200px; display:inline-block"></div></div>';
                    var flowText = flowTabAreaChartDiv;
                }

                //loop through LC tab area results and only include text if there's a result value
                if (app.useLCTabArea === true){
                    var lcTabAreaChartDiv = '<div class="column-center" ><p style="display:inline-block" align="center"><a href=\'coreConcepts_LC.html\' onClick=\'return windowPopup(this, \"notes\")\'>Local Connectedness</a><br></p><div id="lcTabAreaChartNode"  style="width: 200px; height: 200px; display:inline-block"></div></div>';
                    // console.log(lcTabAreaTextVals);
                    var lcTabAreaText =lcTabAreaChartDiv;
                }
                //loop through LD tab area results and only include text if there's a result value
                if (app.useLDTabArea === true){
                    var ldTabAreaChartDiv = '<div class="column-right"><p style="display:inline-block" align="center"><a href=\'coreConcepts_LD.html\' onClick=\'return windowPopup(this, \"notes\")\'>Landscape Diversity</a><br></p><div id="ldTabAreaChartNode"  style="width: 200px; height: 200px; display:inline-block"></div></div>';
                    var ldTabAreaText = ldTabAreaChartDiv;
                }

                var image = '<table align="center"><tr align="center"><td align="center"><img src="assets/logo.jpg" alt="TheNatureConservancy" height="50"></td></tr></table>';
                var okPrintButtons = "<table class=\"noPrint\" align=\"center\">" +"<tr align=\"center\">" +"<td align=\"center\" colspan=\"2\">" +"<button data-dojo-type=\"dijit.form.Button\" type=\"button\"" +"data-dojo-props=\"onClick:function(){dijit.byId('resultDialog').hide();}\">OK</button><button data-dojo-type=\"dijit.form.Button\" type=\"button\" title=\"Print the contents of the results window.  Formatting may be altered.\" " +"data-dojo-props=\"onClick:function(){console.log(\'print click\'); printResultsPane();}\">Print</button></td></tr><tr><td>(Formatting may be altered when printed)</td><tr></table>" ;

                geoPieText = geoPieText.replace(/_/g, " ");





                  if (app.nationalState){
                    console.log(app.regions)
                    if (app.regions.includes("California") || app.regions.includes("California Coast") || app.regions.includes("Pacific Northwest/California")){
                      //don't show dials if in CA except Tamaulipan / Rocky mountains
                      var resilienceText = "<div  class='printOverflow' style='display: inline-block'><hr><h4 style='margin:0px;'>Terrestrial Resilience Categories</h4>" + resTabAreaText + ldTabAreaText + lcTabAreaText;
                      var stateText = 'These results are based on the <b>state-specific</b> analysis.  You can view the input layers by toggling the "Customized - National" to "Customized".';
                    }
                    else{
                      //if in CA in those regions or anywhere else, show the dials
                      var resilienceText = "<div style='display: inline-block'  class='printOverflow'><hr><h4 style='margin:0px;'>Average Terrestrial Resilience with Polygon</h4><p style='margin-top:0px !important; margin-left: 9px;'>(all scores relative to ecoregion)</p><div style='display:inline-block;'>" + resText + LDText + LCText +  "</div></div><div><hr><h4 style='margin:0px;'>Terrestrial Resilience Categories</h4>" + resTabAreaText + ldTabAreaText + lcTabAreaText;
                      var stateText = 'These results are based on the <b>state-specific</b> analysis.  You can view the input layers by toggling the "Customized - National" to "Customized".';
                    }
                  }
                  else{

                    console.log(app.regions)
                    if (app.regions.includes("California") || app.regions.includes("California Coast") || app.regions.includes("Pacific Northwest/California")){
                      //don't show dials if in CA and not in one of these regions
                      var resilienceText = "<div  class='printOverflow' style='display: inline-block'><hr><h4 style='margin:0px;'>Terrestrial Resilience Categories</h4>" + resTabAreaText + ldTabAreaText + lcTabAreaText;
                      var stateText = 'These results are based on the <b>nationally-consistent</b> ecoregional data.';
                    }
                    else{
                      //if in CA in those regions or anywhere else, show the dials
                      var resilienceText = "<div style='display: inline-block'  class='printOverflow'><hr><h4 style='margin:0px;'>Average Terrestrial Resilience with Polygon</h4><p style='margin-top:0px !important; margin-left: 9px;'>(all scores relative to ecoregion)</p><div style='display:inline-block;'>" + resText + LDText + LCText +  "</div></div><div><hr><h4 style='margin:0px;'>Terrestrial Resilience Categories</h4>" + resTabAreaText + ldTabAreaText + lcTabAreaText;
                      var stateText = 'These results are based on the <b>nationally-consistent</b> ecoregional data.';
                    }
                  }



                // secured areas text
                var gapText = "";
                var gapSum = [];
                if (Object.keys(securedTabAreaVals).length > 0){
                    if (securedTabAreaVals["GAP 1"]){
                        var gap1 = securedTabAreaVals["GAP 1"];
                        gapSum.push(gap1);
                    }
                    else{gap1 = 0;}
                    if (securedTabAreaVals["GAP 2"]){
                        var gap2 = securedTabAreaVals["GAP 2"];
                        gapSum.push(gap2);
                    }
                    else{gap2 = 0;}
                    if (securedTabAreaVals["GAP 3"]){
                        var gap3 = securedTabAreaVals["GAP 3"];
                        gapSum.push(gap3)            ;
                    }
                    else{gap3 = 0;}

                    var gapTotal = parseInt((gapSum.reduce((a, b) => a + b, 0)*10)/10);
                    gapText = "<p style='padding:8px'>The area of interest includes <strong>" + numberWithCommas(roundNumber(gapTotal, 0)) + "</strong> acres of exisiting conservation land. <br>(GAP 1=" + numberWithCommas(roundNumber(gap1, 0)) + " ac, GAP 2="  + numberWithCommas(roundNumber(gap2, 0)) + " ac, GAP 3="  + numberWithCommas(roundNumber(gap3, 0)) + " ac)</p>" ;
                }

                if (app.useCoastal === false){
                    var resContent =  "<div id='resultsPane' class='printOverflow'><h4> Total land area: <strong>" + numberWithCommas(Math.max(roundNumber(app.sumTotalAcres, 1)))  + " acres</strong> (" + numberWithCommas(Math.max(roundNumber(app.sumLandAcres, 1))) +" land, " + numberWithCommas(Math.max(roundNumber((app.sumTotalAcres -app.sumLandAcres ), 1)))+" open water) in the " + app.regions + " study area(s) in the " + app.ecoregions + " ecoregion(s).</h4>" + gapText +  "<hr><h4 >Resilient and Connected Network Results</h4><p>Note: " +stateText + " They are derived from the detailed representations of the <a href=\'coreConcepts_resConnDet.html\' onClick=\'return windowPopup(this, \"notes\")\'>Resilient and Connected Networks</a> which can be visualized under the Resilient & Connected Network Components section at right.</p><div style='display:inline-block'  class='printOverflow'>" + resConnText  + "</div >" + "<hr>" + biodivText +  flowText + resilienceText + "<hr><h4 style='margin:0px;'>Geophysical Setting Results</h4>" + geoTextIntro  +  geoText  + "</div>" + okPrintButtons + "</div>";
                }
                if (app.useCoastal === true){
                   var resContent =  "<div id='resultsPane'><h4> Total land area (excl. open water): <strong>" + numberWithCommas(Math.max(roundNumber(app.sumTotalAcres, 1))) + " acres (" + numberWithCommas(Math.max(roundNumber(terrestrialAcres, 1))) + " terrestrial + " + numberWithCommas(Math.max(roundNumber(coastalAcres, 1))) + " coastal) </strong> in the " + app.regions + " study area(s) in the " + app.ecoregions + " ecoregion(s).</h4>" + gapText + "<hr>" +  biodivText + "<hr>" + flowText + "<hr><h4 style='display:inline'>Resilient and Connected Network Results</h4>"+ stateText + " <div style='display:inline-block'>" + resConnText  + "</div >" + resilienceText + "<hr><div style='display: inline-block'><h4 style='margin:0px;'>Resilient Coastal Sites</h4><div style='display:inline-block;'>" + coastalText +  "</div></div>      <div><hr><h4 style='margin:0px;'>Geophysical Setting Results</h4>" + geoTextIntro  +  geoText  + "</div>" + okPrintButtons + "</div>";
                }

                function openTab(evt, tabName) {

                    var i, tabcontent, tablinks;
                    tabcontent = document.getElementsByClassName("tabcontent");
                    for (i = 0; i < tabcontent.length; i++) {
                      tabcontent[i].style.display = "none";
                    }
                    tablinks = document.getElementsByClassName("tablinks");
                    for (i = 0; i < tablinks.length; i++) {
                      tablinks[i].className = tablinks[i].className.replace(" active", "");
                    }
                    document.getElementById(tabName).style.display = "block";
                    evt.currentTarget.className += " active";
                    if (tabName === "Carbon"){
                        if (app.useCarbon === true && app.analysisZone == "CONUS" && Object.keys(forCarbTabAreaTextVals).length > 0){
                            app.forCarb2010MeanGauge.update(app.forCarb2010DispVal);
                            app.forCarb2050MeanGauge.update(app.forCarb2050DispVal);
                            app.forCarbSeqRateGauge.update(app.forCarbSeqDispVal);
                            app.soilCarbMeanGauge.update(app.soilCarbDispVal);
                            if (app.forestCarbon2010MeanVal !== undefined){
                                app.forCarb2010TabAreaPieChart.resize();
                                app.forCarb2050TabAreaPieChart.resize();
                            }
                            app.nlcdTabAreaPieChart.resize();
                        }
                    }
                }

                if (app.showCarbonResults === true && app.analysisZone == "CONUS" && Object.keys(forCarbTabAreaTextVals).length > 0){
                    var tabs = '<div class="tab"><button class="tablinks" id="resTab">Resilience Results</button><button id="carbTab" class="tablinks">Carbon Results</button></div>';
                    var nlcdTabAreaChartDiv = '<h3>Landcover 2019</h3><div id="nlcdTabAreaChartNode"  style="width: 200px; height: 200px; display:inline-block;"></div>';
                    var forCarbPieText = '<p style="font-size: 7px;">AG: Aboveground Wood, CW: Coarse Woody Debris, BG: Belowground/Other</p>'


                    if (app.soilCarbonSumVal !== undefined){
                        var soilCarbonMeanDial = string.substitute('<div><p style="display:inline-block;  margin-bottom:0px" align="center"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Avg. Soil Organic Carbon</a>: <strong>${resultVal}</strong> mt/ac</p><div id="soilCarbonMeanGaugeChart" class="power-gauge" style="display:inline-block; "></div></div>',{resultVal:app.soilCarbonMeanVal});
                        // var soilCarbonMeanVal = app.soilCarbonSumVal;
                        var soilNoForestSum = app.soilCarbonNoForestSumVal;
                        var soilNoForestSumNum = app.soilCarbonNoForestSumVal;
                    }
                    else{
                        var soilCarbonMeanVal = 0;
                        var soilNoForestSum = " zero ";
                        var soilNoForestSumNum = 0;
                    }
                    if (app.soilCarbonSumVal !== undefined){
                        var soilCarbonContent = '<div class="grid-item">' + '<h3>Soil Carbon 2010 (upper 30 cm)</h3><p style="margin:0px"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Total Soil Organic Carbon</a>: <strong>' +  numberWithCommas(roundNumber(app.soilCarbonSumVal, 0)) + '</strong> mt</p>' + soilCarbonMeanDial + '</div>';
                    }
                    else{
                        var soilCarbonContent = '<div class="grid-item">' + '<h3>Soil Carbon 2010</h3><p style="margin:0px">Soil carbon data is not available in the area of interest.</p></div>';
                    }

                    if (app.forestCarbon2010MeanVal !== undefined){
                        var forCarb2010TabAreaChartDiv = '<h3>Forest Carbon 2010</h3><p style="display:inline-block" align="center"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Forest Carbon Components</a><br></p><div id="forCarb2010TabAreaChartNode"  style="width: 200px; height: 200px; display:inline-block"></div>';
                        var forCarb2050TabAreaChartDiv = '<h3>Forest Carbon 2050</h3><p style="display:inline-block" align="center"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Forest Carbon Components</a><br></p><div id="forCarb2050TabAreaChartNode"  style="width: 200px; height: 200px; display:inline-block"></div>';
                        var forestCarbon2010MeanDial = string.substitute('<div ><p style="display:inline-block; margin-bottom:0px" align="center"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Avg. Forest Ecosystem Carbon</a>: <strong>${resultVal}</strong> mt/ac</p><div id="forestCarbon2010MeanGaugeChart" class="power-gauge" style="display:inline-block; "></div></div>',{resultVal:app.forestCarbon2010MeanVal});
                        var forestCarbon2050MeanDial = string.substitute('<div ><p style="display:inline-block; margin-bottom:0px" align="center"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Avg. Forest Ecosystem Carbon</a>: <strong>${resultVal}</strong> mt/ac</p><div id="forestCarbon2050MeanGaugeChart" class="power-gauge" style="display:inline-block; "></div></div>',{resultVal:app.forestCarbon2050MeanVal});
                        var forestCarbonSeqAvgRateDial = string.substitute('<div ><p style="display:inline-block; margin-bottom:0px" align="center"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Annual Rate per Acre</a>: <strong>${resultVal}</strong> mt/ac/yr</p><div id="forestCarbonSeqRateGaugeChart" class="power-gauge" style="display:inline-block; "></div></div>',{resultVal:app.forestCarbonAvgAnnualSeqRate});
                        var forCarb2010Val = '<strong>' +  numberWithCommas(roundNumber(app.forestCarbon2010SumVal, 0)) + '</strong> mt';
                        var forCarb2050Val = '<strong>' +  numberWithCommas(roundNumber(app.forestCarbon2050SumVal, 0)) + '</strong> mt';
                        var forCarbSeqVal = '<strong>' +  numberWithCommas(roundNumber(app.forestCarbonSeqSumVal, 0)) + '</strong> mt';
                        var forCarb2010ValForSoilTotal =numberWithCommas(roundNumber(app.forestCarbon2010SumVal, 0));
                        var forestCarbonContent =
                        '<div style="border: 1px solid #ccc;">' +
                            '<div class="grid-double-container">' +
                                '<h2 style="align: left">Forest Carbon</h2><p style="margin-top: 0px">mt = metric tonnes</p>' +
                            '</div>' +
                            '<div class="grid-container">' +
                                '<div class="grid-item" style="border: 1px solid #f2f2f2; padding-top: 30px;"><h3>Forest Carbon 2010</h3><p style="margin:0px"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Total Forest Ecosystem Carbon:</a> ' + forCarb2010Val + ' </p>'+forestCarbon2010MeanDial + '</div>' +
                                '<div class="grid-item" style="border: 1px solid #f2f2f2;">' + forCarb2010TabAreaChartDiv + forCarbPieText + '</div>' +
                                '<div class="grid-item forCarb2050" style="border: 1px solid #f2f2f2;  padding-top: 30px;">' + '<h3>Forest Carbon 2050</h3><p style="margin:0px"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Total Forest Ecosystem Carbon:</a> ' + forCarb2050Val + ' </p>'+ forestCarbon2050MeanDial + '</div>' +
                                '<div class="grid-item forCarb2050" style="border: 1px solid #f2f2f2;">' + forCarb2050TabAreaChartDiv + forCarbPieText + '</div>' +
                                '<div class="grid-item" style="border: 1px solid #f2f2f2;">' + '<h3>Potential Forest Carbon Sequestration 2010-2050</h3><p style="margin:0px"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>40-yr Total for Site</a>: ' +  forCarbSeqVal + '</p>' + forestCarbonSeqAvgRateDial  + '<p style="margin-top:20px"><a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>Annual Rate for Site</a>: ' +  app.forestCarbonAnnualSeqRate + ' mt/yr</p>' + '</div>' +

                            '</div>' +
                        '</div>';
                    }
                    else{
                        var forestCarbonContent =
                            '<div style="border: 1px solid #ccc;">' +
                                '<div class="grid-double-container">' +
                                    '<h2 style="align: left">Forest Carbon</h2>' +
                                '</div>' +
                                '<div class="grid-container">' +
                                    '<p>The forest carbon data is only available on forested lands.</p>' +
                                '</div>' +
                            '</div>';
                        var forCarb2010ValForSoilTotal = " zero ";

                        if (app.soilCarbonSumVal !== undefined){
                            var soilNoForestSum = app.soilCarbonNoForestSumVal;
                            var soilNoForestSumNum = app.soilCarbonNoForestSumVal;
                        }
                        else{
                            var soilNoForestSum = " zero ";
                            var soilNoForestSumNum = 0;
                        }
                    }


                    var carbonContent =
                    '<div id="Carbon" class="tabcontent printOverflow">' +
                        '<div style="border: 1px solid #ccc;">' +
                            '<div class="grid-double-container">' +
                                '<div class="grid-item-double" style="text-align: left">' +
                                    '<p>These national datasets can be used to get a <strong>estimate</strong> of a site’s carbon stock. The datasets are at different scales, are derived from different methods, and overlap so the results cannot be simply added together. Taken separately, each dataset reveals information about potential carbon at the site.</p>' +
                                    '<p><strong>Forest Carbon 2010</strong> dataset (<a href="https://daac.ornl.gov/CMS/guides/AGB_NEP_Disturbance_US_Forests.html" target="_blank">Williams et al. (2021b)</a>) applies only to forested pixels only and uses a sophisticated model to estimate Total Forest Carbon for 2010, which includes above-ground biomass, coarse woody debris, soil carbon and other pools. <a href=\'coreConcepts_carbon.html\' onClick=\'return windowPopup(this, \"notes\")\'>More detail</a></p>' +
                                    '<p>The <strong>Forest Carbon 2050</strong> (<a href="https://daac.ornl.gov/CMS/guides/AGB_NEP_Disturbance_US_Forests.html" target="_blank">Williams et al. (2021b)</a>) applies only to forested pixels only and uses the same model as the Total Forest Carbon 2010 but runs the model to 2050, assuming no disturbance (conversion, harvest, fire). Actual sequestration may be lower if the forest is disturbed. <strong>Annual sequestration rate</strong> is estimated as: <em>(Carbon 2050 – Carbon 2010)/40 years</em>.</p>' +
                                    '<p><strong>Soil Carbon 2010</strong> (<a href="assets/nrs_2020_guevara.pdf" target="_blank">Guevara et al 2020</a>) is at a coarser scale and only calculated for the upper 30 cm of soil. Soil carbon values were predicted using soil samples and multiple environmental variables coupled with a machine learning approach and regression tree ensemble modeling. In forested areas, this carbon overlaps with carbon in the forest belowground/other category of Forest Carbon 2010.</p>' +
                                    '<p>The <strong>Land Cover 2019</strong> uses the <a href="https://www.mrlc.gov/data?f%5B0%5D=category%3Aland%20cover&f%5B1%5D=year%3A2019" target="_blank">National Land Cover Dataset (NLCD)</a> to show land cover and human use at 30-m resolution. It can be used to determine if, or where, the land cover has changed since 2010.</p>' +
                                    '<p><strong>Total Carbon 2010</strong> for a site is estimated as metric tons of <strong>forest carbon in forested areas</strong> plus metric tons of <strong>soil carbon in non-forested areas</strong>. </p>' +
                                '</<div>' +
                            '</div>' +
                        '</div>' +
                        forestCarbonContent +

                        '<div style="border: 1px solid #ccc;">' +
                            '<div class="grid-double-container">' +
                                '<h2 style="align: left">Soil Carbon & Land Cover</h2><p style="margin-top: 0px">mt = metric tonnes</p>' +
                            '</div>' +
                            '<div class="grid-container">' +
                                soilCarbonContent +
                                '<div class="grid-item">' + nlcdTabAreaChartDiv +'</div>' +
                            '</div>' +
                        '</div>' +
                        '<div style="border: 1px solid #ccc;">' +
                            '<div class="grid-double-container">' +
                                 '<h2 style="align: left">Total Carbon (2010)</h2>' +
                            '</div>' +
                            '<div class="grid-double-container">' +
                                '<p>This site has ' + forCarb2010ValForSoilTotal + ' metric tonnes of forest carbon in <stong>forested areas</strong> plus ' + numberWithCommas(roundNumber(soilNoForestSumNum, 0)) + ' metric tonnes of soil carbon in <stong>non-forested areas</strong>. Total Stock 2010 = <strong>' + numberWithCommas(roundNumber(app.forestSoilProperSum, 0)) + '</strong>.</p>' +
                            '</div>' +
                        '</div>' +
                        '<div>' + okPrintButtons+'</div>' +
                    '</div>';


                    var resilContent = '<div id="Resilience" class="tabcontent printOverflow">' + resContent + '</div>';
                    var content = tabs + resilContent + carbonContent;
                }
                else if (app.useCarbon === true && (app.analysisZone != "CONUS" || Object.keys(forCarbTabAreaTextVals).length === 0)){
                    // var content = resContent;

                  var tabs = '<div class="tab"><button class="tablinks" id="resTab">Resilience Results</button><button id="carbTab" class="tablinks">Carbon Results</button></div>';
                  var carbonContent =
                  '<div id="Carbon" class="tabcontent printOverflow">' +
                        '<p>Carbon data is not available outside the 48 contiguous states.</p>' +

                  '</div>'
                  var resilContent = '<div id="Resilience" class="tabcontent printOverflow">' + resContent + '</div>';
                  var content = tabs + resilContent + carbonContent;
                }
                else{
                  var content = resContent;
                }


                app.resultDialog.set("content", content);
                app.resultDialog.style.top;
                gpStartDialog.hide();
                app.resultDialog.show();
                app.resultDialog._setStyleAttr('top:' + 5 + 'px !important;');
                if (app.showCarbonResults === true || (app.useCarbon === true && ((app.analysisZone != "CONUS") || Object.keys(forCarbTabAreaTextVals).length === 0))){
                    document.getElementById("resTab").addEventListener("click", function(e) {
                        openTab(e, "Resilience");
                    });
                    document.getElementById("carbTab").addEventListener("click", function(e) {
                        openTab(e, "Carbon");

                    });
                    $("#resTab").trigger("click");
                }
                //pass data to Gauge Chart
                app.resilienceVals = {
                    "#resGaugeChart":app.grResVal,
                    "#lcGaugeChart": app.grLCVal,
                    "#ldGaugeChart":app.grLDVal,
                    "#forestCarbon2010MeanGaugeChart":app.forestCarbon2010MeanVal,
                    "#forestCarbon2050MeanGaugeChart":app.forestCarbon2050MeanVal,
                    "#forestCarbonSeqRateGaugeChart":app.forestCarbonAvgAnnualSeqRate,
                    "#soilCarbonMeanGaugeChart":app.soilCarbonMeanVal
                };

//                reset values at in third SD to a smaller value to stretch out the chart
                var graphMaxVal = 2.25;
                var resGauge = gauge('#resGaugeChart', { });
                resGauge.render();
                if (app.grResVal > graphMaxVal){var resDispVal = graphMaxVal;}
                else if (app.grResVal < -graphMaxVal){var resDispVal = -graphMaxVal;}
                else {var resDispVal = app.grResVal;}
                resGauge.update(resDispVal);


                var lcGauge = gauge('#lcGaugeChart', { });
                lcGauge.render();
                if (app.grLCVal > graphMaxVal){var lcDispVal = graphMaxVal;}
                else if (app.grLCVal < -graphMaxVal){var lcDispVal = -graphMaxVal;}
                else {var lcDispVal = app.grLCVal;}
                lcGauge.update(lcDispVal);


                var ldGauge = gauge('#ldGaugeChart', { });
                ldGauge.render();
                if (app.grLDVal > graphMaxVal){var ldDispVal = graphMaxVal;}
                else if (app.grLDVal < -graphMaxVal){var ldDispVal = -graphMaxVal;}
                else {var ldDispVal = app.grLDVal;}
                ldGauge.update(ldDispVal);

                if (app.showCarbonResults === true){
                    app.forCarb2010MeanGauge = gauge('#forestCarbon2010MeanGaugeChart', {
                        ticks : [25,  275],
                        majorTicks : 15,
                        tickData: d3.range(15).map(function() {return 1/15;}),
                        arcColorFn : d3.interpolateHsl(d3.rgb('#e9ffbe'), d3.rgb('#267300')), //d3.interpolateHsl(d3.rgb('#e8e2ca'), d3.rgb('#3e6c0a')),
                        minValue: 0,
                        maxValue: 300
                    });
                    app.forCarb2010MeanGauge.render();
                    if (app.forestCarbon2010MeanVal > 300){app.forCarb2010DispVal = 300;}
                    else if (app.forestCarbon2010MeanVal < 0){app.forCarb2010DispVal = 0;}
                    else {app.forCarb2010DispVal = app.forestCarbon2010MeanVal;}
                    app.forCarb2010MeanGauge.update(app.forCarb2010DispVal);


                    app.forCarb2050MeanGauge = gauge('#forestCarbon2050MeanGaugeChart', {
                        ticks : [25,  275],
                        majorTicks : 15,
                        tickData: d3.range(15).map(function() {return 1/15;}),
                        arcColorFn : d3.interpolateHsl(d3.rgb('#e9ffbe'), d3.rgb('#267300')), //d3.interpolateHsl(d3.rgb('#e8e2ca'), d3.rgb('#3e6c0a')),
                        minValue: 0,
                        maxValue: 300
                    });
                    app.forCarb2050MeanGauge.render();
                    if (app.forestCarbon2050MeanVal > 300){app.forCarb2050DispVal = 300;}
                    else if (app.forestCarbon2050MeanVal < 0){app.forCarb2050DispVal = 0;}
                    else {app.forCarb2050DispVal = app.forestCarbon2050MeanVal;}
                    app.forCarb2050MeanGauge.update(app.forCarb2050DispVal);


                    app.forCarbSeqRateGauge = gauge('#forestCarbonSeqRateGaugeChart', {
                        ticks : [0.25,  1.75],
                        majorTicks : 15,
                        tickData: d3.range(15).map(function() {return 1/15;}),
                        arcColorFn : d3.interpolateHsl(d3.rgb('#9dd6f2'), d3.rgb('#0531f5')), //d3.interpolateHsl(d3.rgb('#e8e2ca'), d3.rgb('#3e6c0a')),
                        minValue: 0,
                        maxValue: 2
                    });
                    app.forCarbSeqRateGauge.render();
                    if (app.forestCarbonAvgAnnualSeqRate > 2){app.forCarbSeqDispVal = 2;}
                    else if (app.forestCarbonAvgAnnualSeqRate < 0){app.forCarbSeqDispVal = 0;}
                    else {app.forCarbSeqDispVal = app.forestCarbonAvgAnnualSeqRate;}
                    app.forCarbSeqRateGauge.update(app.forCarbSeqDispVal);

                    app.soilCarbMeanGauge = gauge('#soilCarbonMeanGaugeChart', {
                        ticks : [5, 60],
                        majorTicks: 15,
                        tickData: d3.range(15).map(function() {return 1/15;}),
                        arcColorFn : d3.interpolateHsl(d3.rgb('#f0ecaa'), d3.rgb('#664830')), //d3.scale.ordinal().range(['#f0ecaa', '#d6cc92', '#bdad7b','#a69165','#8f7651','#7a5e40', '#664830']), //d3.interpolateHsl(d3.rgb('#e8e2ca'), d3.rgb('#3e6c0a')),
                        minValue: 0,
                        maxValue: 65
                    });
                    app.soilCarbMeanGauge.render();
                    if (app.soilCarbonMeanVal > 80){app.soilCarbDispVal = 80;}
                    else if (app.soilCarbonMeanVal < 0){app.soilCarbDispVal = 0;}
                    else {app.soilCarbDispVal = app.soilCarbonMeanVal;}
                    app.soilCarbMeanGauge.update(app.soilCarbDispVal);
                }


                //Set up function to show geophysical settings on camera icon hover
                $(".hoverImage").mouseenter(function(){
                    var image_name=$(this).data('image');
                    var imageTag='<div style="position:absolute; left:37px; margin-top: -223px; z-index:50; border: 2px solid black; border-radius: 5px">'+'<img src="'+image_name+'" alt="image" width="300" height="200" />'+'</div>';
                    $(this).parent('p').append(imageTag);
                    $(this).parent('p').children('div').hide();
                    $(this).parent('p').children('div').fadeIn();

                    //analytics event tracking
                    ga('send', 'event', {
                            eventCategory:"Resilient Land",
                            eventAction: "Result photo hover",
                            eventLabel: image_name
                    });
                });
                $(".hoverImage").mouseleave(function(){
                    $(this).parent('p').children('div').fadeOut();
                });


                //set up the resilient & connected pie chart *****Set label offset to 0 if incluing geo text in label

                theme.plotarea.fill ="white";
                theme.chart.fill="white";
                if (Object.keys(resConnTextVals).length >0){
                    // console.log("making res conn pie")
                    var resConnPieChart = new Chart("resConnChartNode");
                    resConnPieChart.setTheme(theme);
                    resConnPieChart.addPlot("default", {
                        type: "Pie",
                        fontColor: "black",
                        labelOffset: 0,

                        styleFunc: function(item){
                          if (item.key === "Outside Prioritized Network"){return{fill:"#D3CEC6"};}
                          else if (item.key === "Mostly Resilient, Concentrated Flow"){return{fill:"#d39314"};}
                          else if (item.key === "Resilient, Recognized Biodiversity"){return{fill:"#267300"};}
                          else if (item.key === "Resilient, Diffuse Flow (Climate Informed)"){return{fill:"#6a99d3"};}
                          else if (item.key === "Resilient, Diffuse Flow"){return{fill:"#a2b1d3"};}
                          else if (item.key === "Mostly Resilient, Concentrated Flow, Recognized Biodiversity"){return{fill:"#ffaa00"};}
                          else if (item.key === "Resilient Coastal Migration Space"){return{fill:"#ffd27f"};}
                          else if (item.key === "Resilient, Diffuse Flow (Climate Informed), Recognized Biodiversity Value"){return{fill:"#73b2ff"};}
                          else if (item.key === "Resilient, Concentrated Flow (Climate Informed), Recognized Biodiversity"){return{fill:"#a87000"};}
                          else if (item.key === "Resilient, Diffuse Flow, Recognized Biodiversity"){return{fill:"#bed2ff"};}
                          else if (item.key === "Additional Resilient Secured (GAP 3)"){return{fill:"#88cd66"};}
                          else if (item.key === "Resilient, Concentrated Flow (Climate Informed)"){return{fill:"#807100"};}
                          else if (item.key === "Diffuse Flow, Recognized Biodiversity Value"){return{fill:"#c29ed7"};}
                          else if (item.key === "Flow and Recognized Biodiversity"){return{fill:"#d7effc"};}
                          else if (item.key === "Restoration Sites"){return{fill:"#f5f57a"};}

                          else{return{fill:"black"};}
                          return {};
                        }
                    });
                    // console.log(resConnPieData);
                    resConnPieChart.addSeries("Resilient and Connected Network",resConnPieData);

                    new Tooltip(resConnPieChart, "default", {
                          position : "before"
                    });
                    new MoveSlice(resConnPieChart,"default");
                    resConnPieChart.render();
                }

//                //set up the resilient & connected pie chart *****Set label offset to 0 if incluing geo text in label
//                // console.log(coastalPieData);
//                if (app.useCoastal === true){
//                    var coastalPieChart = new Chart("coastalChartNode");
//                    coastalPieChart.setTheme(theme);
//                    coastalPieChart.addPlot("default", {
//                        type: "Pie",
//                        fontColor: "black",
//                        labelOffset: 0,
//
//                        styleFunc: function(item){
//                          if (item.key === "Above Average Resilience Tidal Complex"){return{fill:"#deddc5"};}
//                          else if (item.key === "Below Average Resilience Tidal Complex"){return{fill:"#c8dbe6"};}
//                          else if (item.key === "Above Average Coastal Migration Space"){return{fill:"#2b8cbe"};}
//                          else if (item.key === "Below Average Coastal Migration Space"){return{fill:"#bf874b"};}
//                          else{return{fill:"black"};}
//                          return {};
//                        }
//                    });
//                    coastalPieChart.addSeries("Resilient Coastal Sites",coastalPieData);
//
//                    new Tooltip(coastalPieChart, "default", {
//                          position : "before"
//                    });
//                    new MoveSlice(coastalPieChart,"default");
//                    coastalPieChart.render();
//                }


               //set up the continuous flow summary
               if (Object.keys(flowVals).length >0){
                   var flowPieChart = new Chart("flowTabAreaChartNode");
                   flowPieChart.setTheme(theme);
                   flowPieChart.addPlot("default", {
                       type: "Pie",
                       fontColor: "black",
                       labelOffset: 0,

                       styleFunc: function(item){
                         if (item.key === "Far Above Average Flow"){return{fill:"#043859"};}
                         else if (item.key === "Above Average Flow"){return{fill:"#045a72"};}
                         else if (item.key === "Slightly Above Average Flow"){return{fill:"#74a9cf"};}
                         else if (item.key === "Average Flow"){return{fill:"#ffffbf"};}
                         else if (item.key === "Slightly Below Average Flow"){return{fill:"#e0c080"};}
                         else if (item.key === "Below Average Flow"){return{fill:"#bf874b"};}
                         else if (item.key === "Far Below Average Flow"){return{fill:"#9c551f"};}
                         else{return{fill:"black"};}
                         return {};
                       }
                   });
                   flowPieChart.addSeries("Flow",flowPieData);

                   new Tooltip(flowPieChart, "default", {
                         position : "before"
                   });
                   new MoveSlice(flowPieChart,"default");
                   flowPieChart.render();
               }

               //set up the biodiversity summary
               if (Object.keys(biodivVals).length >0){
                   var biodivPieChart = new Chart("biodivTabAreaChartNode");
                   biodivPieChart.setTheme(theme);
                   biodivPieChart.addPlot("default", {
                       type: "Pie",
                       fontColor: "black",
                       labelOffset: 0,

                       styleFunc: function(item){

                         if (item.key === "State-based"){return{fill:"#9e9e00"};}
                         else if (item.key === "Ecoregion-based"){return{fill:"#38a800"};}
                         else if (item.key === "Ecoregion and State-based"){return{fill:"#4b7300"};}
                         else if (item.key === "Additional Habitat and Species"){return{fill:"#abcc95"};}
                         else if (item.key === "Unrecognized Biodiversity Value"){return{fill:"#c7c7c7"};}

                         else{return{fill:"black"};}
                         return {};
                       }
                   });
                   biodivPieChart.addSeries("Biodiversity",biodivPieData);

                   new Tooltip(biodivPieChart, "default", {
                         position : "before"
                   });
                   new MoveSlice(biodivPieChart,"default");
                   biodivPieChart.render();
               }

                 //set up the resilient tab area pie chart *****Set label offset to 0 if incluing geo text in label
                // console.log(coastalPieData);
                if (app.useResTabArea === true){
                    var resTabAreaPieChart = new Chart("resTabAreaChartNode");
                    resTabAreaPieChart.setTheme(theme);
                    resTabAreaPieChart.addPlot("default", {
                        type: "Pie",
                        fontColor: "black",
                        labelOffset: 0,
                        styleFunc: function(item){
                          if (item.key === "Far Above Average"){return{fill:"#177A0D"};}
                          else if ((item.key === "Above Average") ||(item.key === "80 - 100 Percentile")){return{fill:"#60A642"};}
                          else if ((item.key === "Slightly Above Average")  ||(item.key === "60 - 80 Percentile")){return{fill:"#ABD17D"};}
                          else if ((item.key === "Average")  ||(item.key === "40 - 60 Percentile")){return{fill:"#FFFFBF"};}
                          else if ((item.key === "Slightly Below Average") ||(item.key === "20 - 40 Percentile")){return{fill:"#CFBA76"};}
                          else if ((item.key === "Below Average") ||  (item.key === "0 - 20 Percentile")){return{fill:"#A17E3A"};}
                          else if (item.key === "Far Below Average"){return{fill:"#734D00"};}
                          else if (item.key === "Migration Space for Tidal Habitat"){return{fill:"#2b8dbe"};}
                          else if (item.key === "Resilient Migration Space for Tidal Habitat"){return{fill:"#2b8dbe"};}
                          else if (item.key === "Sea Level Rise Area"){return{fill:"#9c9c9c"};}
                          else if (item.key === "Vulnerable Tidal Habitat"){return{fill:"#deddc5"};}
                          else if (item.key === "Resilient Tidal Habitat"){return{fill:"#c8c9e6"};}
                          else if (item.key === "Above Average Resilience Tidal Habitat"){return{fill:"#c8c9e6"};}
                          else if (item.key === "Developed"){return{fill:"#686968"};}
                          else if (item.key === "Glacier"){return{fill:"#f5f5f5"};}
                          else if (item.key === "Pioneer Lava"){return{fill:"#c8c8c8"};}
                          else{return{fill:"black"};}
                          return {};
                        }
                    });
                    resTabAreaPieChart.addSeries("Resilience Categories ",resPieData);

                    new Tooltip(resTabAreaPieChart, "default", {
                          position : "before"
                    });
                    new MoveSlice(resTabAreaPieChart,"default");
                    resTabAreaPieChart.render();
                }

                  //set up the LC tab area pie chart *****Set label offset to 0 if incluing geo text in label
                // console.log(coastalPieData);
                if (app.useLCTabArea === true){
                    var lcTabAreaPieChart = new Chart("lcTabAreaChartNode");
                    lcTabAreaPieChart.setTheme(theme);
                    lcTabAreaPieChart.addPlot("default", {
                        type: "Pie",
                        fontColor: "black",
                        labelOffset: 0,
                        styleFunc: function(item){
                          if ((item.key === "Far Above Average") ||(item.key === "Most local connectedness")){return{fill:"#177A0D"};}
                          else if ((item.key === "Above Average") ||(item.key === "80 - 100 Percentile") ||(item.key === "More local connectedness")){return{fill:"#60A642"};}
                          else if ((item.key === "Slightly Above Average")  ||(item.key === "60 - 80 Percentile") ||(item.key === "Slightly more local connectedness")){return{fill:"#ABD17D"};}
                          else if ((item.key === "Average")  ||(item.key === "40 - 60 Percentile") ||(item.key === "Average/Median local connectedness")){return{fill:"#FFFFBF"};}
                          else if ((item.key === "Slightly Below Average") ||(item.key === "20 - 40 Percentile") ||(item.key === "Slightly less local connectedness")){return{fill:"#CFBA76"};}
                          else if ((item.key === "Below Average") ||  (item.key === "0 - 20 Percentile") ||(item.key === "Less local connectedness")){return{fill:"#A17E3A"};}
                          else if ((item.key === "Far Below Average")||(item.key === "Least local connectedness")){return{fill:"#734D00"};}
                          else if (item.key === "Developed"){return{fill:"#686968"};}
                          else if (item.key === "Glacier"){return{fill:"#f5f5f5"};}
                          else if (item.key === "Pioneer Lava"){return{fill:"#c8c8c8"};}
                          else{return{fill:"black"};}
                          return {};
                        }

                    });
                    lcTabAreaPieChart.addSeries("Local Connectedness Categories ",lcPieData);

                    new Tooltip(lcTabAreaPieChart, "default", {
                          position : "before"
                    });
                    new MoveSlice(lcTabAreaPieChart,"default");
                    lcTabAreaPieChart.render();
                }

                 //set up the LC tab area pie chart *****Set label offset to 0 if incluing geo text in label
                // console.log(coastalPieData);
                if (app.useLDTabArea === true){
                    var ldTabAreaPieChart = new Chart("ldTabAreaChartNode");
                    ldTabAreaPieChart.setTheme(theme);
                    ldTabAreaPieChart.addPlot("default", {
                        type: "Pie",
                        fontColor: "black",
                        labelOffset: 0,
                        styleFunc: function(item){
                          if (item.key === "Far Above Average"){return{fill:"#177A0D"};}
                          else if ((item.key === "Above Average") ||(item.key === "80 - 100 Percentile")){return{fill:"#60A642"};}
                          else if ((item.key === "Slightly Above Average")  ||(item.key === "60 - 80 Percentile")){return{fill:"#ABD17D"};}
                          else if ((item.key === "Average")  ||(item.key === "40 - 60 Percentile")){return{fill:"#FFFFBF"};}
                          else if ((item.key === "Slightly Below Average") ||(item.key === "20 - 40 Percentile")){return{fill:"#CFBA76"};}
                          else if ((item.key === "Below Average") ||  (item.key === "0 - 20 Percentile")){return{fill:"#A17E3A"};}
                          else if (item.key === "Far Below Average"){return{fill:"#734D00"};}
                          else if (item.key === "Developed"){return{fill:"#686968"};}
                          else if (item.key === "Glacier"){return{fill:"#f5f5f5"};}
                          else if (item.key === "Pioneer Lava"){return{fill:"#c8c8c8"};}
                          else{return{fill:"black"};}
                          return {};
                        }
                    });
                    ldTabAreaPieChart.addSeries("Landscape Diversity Categories ", ldPieData);

                    new Tooltip(ldTabAreaPieChart, "default", {
                          position : "before"
                    });
                    new MoveSlice(ldTabAreaPieChart,"default");
                    ldTabAreaPieChart.render();
                }

                if (app.useNLCDTabArea === true){
                    app.nlcdTabAreaPieChart = new Chart("nlcdTabAreaChartNode");
                    app.nlcdTabAreaPieChart.setTheme(theme);
                    app.nlcdTabAreaPieChart.addPlot("default", {
                        type: "Pie",
                        fontColor: "black",
                        labelOffset: 0,
                        styleFunc: function(item){
                          if (item.key === "Open Water"){return{fill:"#476ba1"};}
                          else if (item.key === "Perrenial Snow/Ice") {return{fill:"#d1defa"};}
                          else if (item.key === "Developed, Open Space"){return{fill:"#decaca"};}
                          else if (item.key === "Developed, Low Intensity"){return{fill:"#d99482"};}
                          else if (item.key === "Developed, Medium Intensity"){return{fill:"#ee0000"};}
                          else if (item.key === "Developed, High Intensity"){return{fill:"#ab0000"};}
                          else if (item.key === "Barren Land"){return{fill:"#b3aea3"};}
                          else if (item.key === "Deciduous Forest") {return{fill:"#68ab63"};}
                          else if (item.key === "Evergreen Forest"){return{fill:"#1c6330"};}
                          else if (item.key === "Mixed Forest"){return{fill:"#b5ca8f"};}
                          else if (item.key === "Shrub/Scrub"){return{fill:"#ccba7d"};}
                          else if (item.key === "Herbaceous"){return{fill:"#e3e3c2"};}
                          else if (item.key === "Hay/Pasture"){return{fill:"#dcd93d"};}
                          else if (item.key === "Cultivated Crops") {return{fill:"#ab7028"};}
                          else if (item.key === "Woody Wetlands"){return{fill:"#bad9eb"};}
                          else if (item.key === "Emergent Herbaceous Wetlands"){return{fill:"#70a3ba"};}
                          else{return{fill:"black"};}
                          return {};
                        }
                    });
                    app.nlcdTabAreaPieChart.addSeries("National Landcover Database Categories ", nlcdPieData);

                    new Tooltip(app.nlcdTabAreaPieChart, "default", {
                          position : "before"
                    });
                    new MoveSlice(app.nlcdTabAreaPieChart,"default");
                    app.nlcdTabAreaPieChart.render();
                }
                if (app.useForCarbTabArea === true && app.forestCarbon2010MeanVal !== undefined){
                    // console.log("rendering for carb pie")
                    app.forCarb2010TabAreaPieChart = new Chart("forCarb2010TabAreaChartNode");
                    app.forCarb2010TabAreaPieChart.setTheme(theme);
                    app.forCarb2010TabAreaPieChart.addPlot("default", {
                        type: "Pie",
                        fontColor: "black",
                        labelOffset: 0,
                        styleFunc: function(item){
                          if (item.key === "Aboveground Wood 2010"){return{fill:"#177A0D"};}
                          else if (item.key === "Coarse Woody Debris 2010") {return{fill:"#A4A083"};}
                          else if (item.key === "Belowground/Other 2010"){return{fill:"#A9BA9D"};}
                          else{return{fill:"black"};}
                          return {};
                        }
                    });
                    app.forCarb2010TabAreaPieChart.addSeries("Forest Carbon Components ", forCarbPieData2010);

                    new Tooltip(app.forCarb2010TabAreaPieChart, "default", {
                          position : "before"
                    });
                    new MoveSlice(app.forCarb2010TabAreaPieChart,"default");
                    app.forCarb2010TabAreaPieChart.render();

                    app.forCarb2050TabAreaPieChart = new Chart("forCarb2050TabAreaChartNode");
                    app.forCarb2050TabAreaPieChart.setTheme(theme);
                    app.forCarb2050TabAreaPieChart.addPlot("default", {
                        type: "Pie",
                        fontColor: "black",
                        labelOffset: 0,
                        styleFunc: function(item){
                          if (item.key === "Aboveground Wood 2050"){return{fill:"#177A0D"};}
                          else if (item.key === "Coarse Woody Debris 2050") {return{fill:"#A4A083"};}
                          else if (item.key === "Belowground/Other 2050"){return{fill:"#A9BA9D"};}
                          else{return{fill:"black"};}
                          return {};
                        }
                    });
                    app.forCarb2050TabAreaPieChart.addSeries("Forest Carbon Components ", forCarbPieData2050);

                    new Tooltip(app.forCarb2050TabAreaPieChart, "default", {
                          position : "before"
                    });
                    new MoveSlice(app.forCarb2050TabAreaPieChart,"default");
                    app.forCarb2050TabAreaPieChart.render();

                }

            }

            function statusCallback(jobInfo) {
            	// console.log("Status Callback!");
            	statusCallbackIterator += 1;
                var gpResultDiv = dom.byId('gpResults');
                gpResultDiv.innerHTML = "";
                var status = jobInfo.jobStatus;
                if(status === "esriJobFailed"){
                    console.log("There was a problem running the analysis.  Please try again. " + status);
                    //message 9 is the indigenous lands error with sketch 11 is with SHP upload
                    if(jobInfo.messages[8].description === "Tribal" || jobInfo.messages[11].description === "Tribal"  || jobInfo.messages[10].description === "Tribal" ){
                        gpIndigenousErrorDialog.show();
                        var gpUpdateDiv = dom.byId('gpUpdateStatus');
                        gpUpdateDiv.style.display = "block";
                        gpUpdateDiv.innerHTML = "Indigenous lands overlap. Please try again.";
                    }
                    else if(jobInfo.messages[8].description === "Size" || jobInfo.messages[11].description === "Size"  || jobInfo.messages[10].description === "Tribal" ){
                        gpSizeErrorDialog.show();
                        var gpUpdateDiv = dom.byId('gpUpdateStatus');
                        gpUpdateDiv.style.display = "block";
                        gpUpdateDiv.innerHTML = "The polygon entered is too large. Please limit your analysis to an area <10,000 sq miles, or 1,000 sq miles if also assessing carbon data.";
                    }
                    else{
                        alert("There was a problem running the analysis.  Please try again. " + status);
                    }
                }
                else {
                    //if(statusCallbackIterator === 1){alert("Your analysis has begun.  It will take approximately 30 seconds to run.  You may continue to use the map in the meantime. Thanks for your patience.");}
                    if(statusCallbackIterator === 1){gpStartDialog.show();}
                    var messages = jobInfo.messages;
                    var count = messages.length;
                    var index = count-1;
                    if (count>0) {
                        var message = messages[index].description;
                    }
                    if ((message !== updateMessage) && (typeof message !== 'undefined'))
                    {
                        var gpUpdateDiv = dom.byId('gpUpdateStatus');
                        gpUpdateDiv.style.display = "block";
                        gpUpdateDiv.innerHTML = message;
                        var updateMessage = message;

                    }
                }
            }

            function gpJobFailed(error){
                console.log(error);

            	console.log("Error!!");
            	statusCallbackIterator = 0;
                dom.byId('status').innerHTML = error;
                domUtils.hide(dom.byId('status'));
            }
//End GP service functions*******************************


//Shapefile display / Portal functions********************

            on(dom.byId("uploadForm"), "change", function (event) {
                var fileName = event.target.value.toLowerCase();
                if (sniff("ie")) { //filename is full path in IE so extract the file name
                    var arr = fileName.split("\\");
                    fileName = arr[arr.length - 1];
                }
                if (fileName.indexOf(".zip") !== -1) {//is file a zip - if not notify user
                    generateFeatureCollection(fileName);
                }
                else {
                    alert("Add shapefile as a .zip file");
                    //dom.byId('upload-status').innerHTML = '<p style="color:red">Add shapefile as .zip file</p>';
                }
            });


            function generateFeatureCollection (fileName) {
                //delete any old versions
                map.graphics.clear();

                uploadFile();
                var name = fileName.split(".");
                //Chrome and IE add c:\fakepath to the value - we need to remove it
                //See this link for more info: http://davidwalsh.name/fakepath
                name = name[0].replace("c:\\fakepath\\", "");

                //Define the input params for generate see the rest doc for details
                //http://www.arcgis.com/apidocs/rest/index.html?generate.html
                var params = {
                    'name': name,
                    'targetSR': map.spatialReference,
                    'maxRecordCount': 1000,
                    'enforceInputFileSizeLimit': true,
                    'enforceOutputJsonSizeLimit': true
                };

                //generalize features for display Here we generalize at 1:40,000 which is approx 10 meters
                //This should work well when using web mercator.
                var extent = scaleUtils.getExtentForScale(map, 40000);
                var resolution = extent.getWidth() / map.width;
                params.generalize = true;
                params.maxAllowableOffset = resolution;
                params.reducePrecision = true;
                params.numberOfDigitsAfterDecimal = 0;

                var myContent = {
                    'filetype': 'shapefile',
                    'publishParameters': JSON.stringify(params),
                    'f': 'json',
                    'callback.html': 'textarea'
                };

                //use the rest generate operation to generate a feature collection from the zipped shapefile
                request({
                    url: portalUrl + '/sharing/rest/content/features/generate',
                    content: myContent,
                    form: dom.byId('uploadForm'),
                    handleAs: 'json',
                    load: lang.hitch(this, function (response) {
                        if (response.error) {
                            errorHandler(response.error);
                            return;
                        }
                        var layerName = response.featureCollection.layers[0].layerDefinition.name;
                        //dom.byId('upload-status').innerHTML = '<b>Loaded: </b>' + layerName;
                        addShapefileToMap(response.featureCollection);
                    }),
                    error: lang.hitch(this, errorHandler)
                });
            }

            function errorHandler (error) {
                dom.byId('gpInfo').innerHTML =
                "<p style='color:red'>" + error.message + "</p>";
            }

            function addShapefileToMap (featureCollection) {
                if (shape){map.removeLayer(shape);}
          	//analytics event tracking
                ga('send', 'event', {
                   eventCategory:"Resilient Land",
                   eventAction: "Uploaded shapefile",
                   eventLabel: "Uploaded shapefile"
                });


                //add the shapefile to the map and zoom to the feature collection extent
                //If you want to persist the feature collection when you reload browser you could store the collection in
                //local storage by serializing the layer using featureLayer.toJson()  see the 'Feature Collection in Local Storage' sample
                //for an example of how to work with local storage.
                var fullExtent;
                var layers = [];

                arrayUtils.forEach(featureCollection.layers, function (layer) {
                    var infoTemplate = new InfoTemplate("Details", "${*}");
                    var featureLayer = new FeatureLayer(layer, {
                        infoTemplate: infoTemplate
                    });
                    //associate the feature with the popup on click to enable highlight and zoom to
                    featureLayer.on('click', function (event) {
                        map.infoWindow.setFeatures([event.graphic]);
                    });
                    //change default symbol if desired. Comment this out and the layer will draw with the default symbology
                    changeRenderer(featureLayer);
                    fullExtent = fullExtent ?
                    fullExtent.union(featureLayer.fullExtent) : featureLayer.fullExtent;
                    layers.push(featureLayer);
                    shape= featureLayer;
                });

                map.addLayer(shape);
                //map.addLayers(layers);
                map.setExtent(fullExtent.expand(1.25), true);
                dom.byId('gpInfo').innerHTML = "";


            }

            function changeRenderer (layer) {
                //change the default symbol for the feature collection for polygons and points
                var symbol = null;
                switch (layer.geometryType) {
                    case 'esriGeometryPoint':
                    symbol = new PictureMarkerSymbol({
                        'angle': 0,
                        'xoffset': 0,
                        'yoffset': 0,
                        'type': 'esriPMS',
                        'url': 'http://static.arcgis.com/images/Symbols/Shapes/BluePin1LargeB.png',
                        'contentType': 'image/png',
                        'width': 20,
                        'height': 20
                    });
                    break;
                    case 'esriGeometryPolygon':
                    symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                      new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                        new Color([240,59,32]), 2), new Color([240,59,32, 0.05]));
                    break;
                }
                if (symbol) {
                    layer.setRenderer(new SimpleRenderer(symbol));
                }
            }
//End shapefile display / Portal functions********************

            });

        });

   function print_html_ele(element) {

        console.log(element)
        window.print();

//        w=window.open();
////        document.getElementById("element").style.overflow = "visible";
//        w.document.write($('#' + element).html());
//        $('#' + element).css({'overflow':'visible !important'});
//        $('#' + element).css({'height':'2000px !important'});
//        $('#' + element).css({'left':'20px !important'});
//        $('.dijitDialogUnderlay _underlay #resultDialog_underlay').css({'overflow':'visible !important'});
//        $('.dijitDialogUnderlay _underlay #resultDialog_underlay').css({'height':'2000px !important'});
//        $('.dijitDialogUnderlay _underlay #resultDialog_underlay').css({'left':'20px !important'});
//        $('.dijitDialogPaneContent.dijitAlignCenter').css({'overflow':'visible !important'});
//        w.print();
//        w.close();

//        var printContents = document.getElementById(element).innerHTML;
//        var originalContents = document.body.innerHTML;
//        document.body.innerHTML = printContents;
//        window.print();
//        document.body.innerHTML = originalContents;

//        var contents = $(element).html();
//        var frame1 = $('<iframe />');
//
////        var css_link1 = 'https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css';
//        var css_link2 = '/css/print.css';
//
//        frame1[0].name = "frame1";
//        frame1.css({ "position": "absolute", "top": "-1000000px" });
//        $("body").append(frame1);
//        var frameDoc = frame1[0].contentWindow ? frame1[0].contentWindow : frame1[0].contentDocument.document ? frame1[0].contentDocument.document : frame1[0].contentDocument;
//        frameDoc.document.open();
//        //Create a new HTML document.
//        frameDoc.document.write('<html><head>');
//                //Append the external CSS file.
////        frameDoc.document.write('<link href="'+css_link1+'" rel="stylesheet" type="text/css" />');
//        frameDoc.document.write('<link href="'+css_link2+'" rel="stylesheet" type="text/css" />');
//        frameDoc.document.write('</head><body>');
//
//        //Append the DIV contents.
//        frameDoc.document.write(contents);
//        frameDoc.document.write('</body></html>');
//        frameDoc.document.close();
//        setTimeout(function () {
//            window.frames["frame1"].focus();
//            window.frames["frame1"].print();
//            frame1.remove();
//        }, 500);
        }
        function printResultsPane(){
//            print_html_ele(document.getElementById("resultDialog"));
            print_html_ele("resultDialog");
        }


    </script>

  </head>

  <body class="tundra">
<!--    <audio id="myAudioElement">
           <source src="assets/cover.mp3" >
   </audio> -->

    <div id="mainWindow" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline',gutters:false" style="width:100%; height:100%;">
      <div data-dojo-type="dijit/layout/ContentPane" id="headerPane" data-dojo-props="region:'top'">
      <a href="http://www.nature.org" target="_blank"><img src="assets/logo.jpg" alt="The Nature Conservancy" height="40" style="padding-left:5px; padding-top:5px" title="Visit The Nature Conservancy's website."></a>
      	<h1 class="header-title">Resilient Land Mapping Tool</h1>
        <h2 class="infoLink"><a href="http://www.conservationgateway.org/ConservationPractices/ClimateChange/Pages/Climate-Resilience.aspx" target="blank">Download data</a> or <a href="mailto:crcs@tnc.org">email</a> for more information</h2>

      	<h2 class="infoLink">Get a quick primer on the  <a href="coreConcepts.html" target="blank">Core Concepts</a></h2>
      </div>



      <div data-dojo-type="dijit/layout/ContentPane" id="rightPane" data-dojo-props="region:'right'">
 		<div id="printDiv">
	      	<div id = "printTitleInputHolder"><input id="myPrintTitle" placeholder="Enter a printout title" type="text" /></div>
	      	<div id="printButton"></div>

      </div>


      	<div class="upload-area" >
      	  <h2>Analyze</h2>
          <p>Get resilience statistics for a parcel or other polygon.</p>
              <form enctype="multipart/form-data" method="post" id="uploadForm" >
              <div class="field" title="Click to upload a zipped shapefile.  Be sure to include all parts of he shapefile">
                  <label class="file-upload" >
                      <span >Upload <b>Zipped</b> SHP</span>
                      <input type="file" name="file" id="inFile" />
                  </label>
              </div>
              </form>
              <p>OR</p>
              <div id="info" title="Click to draw a polygon on the map.">
              	<button class = "file-upload" id="Polygon">Sketch a Polygon</button>
             </div>
             <div id="reopenRes" title="Reopen the most recent results" style="display: none;">
              	<button id="reopenResButton" class="file-upload" onClick="showResultDialog()">Open Last Results</button>
                <button id="clearUserPoly" class="file-upload" onClick="clearUserPolygons()">Clear Old Polygon</button>
             </div>
          <span class="gp-update-status" style="opacity:1; display:none" id="gpUpdateStatus" ></span>
          <div id="gpInfo" >&nbsp;</div>
          <span class="gp-results" style="opacity:1; display:none" id="gpResults" title="Results from the previous analysis run are displayed here."></span>
          <div id="gpResInfo" >&nbsp;</div>
          <div style="display: table;">
            <input id="carbonCheck"  type="checkbox" title="Select to assess forest and soil carbon within your area of interest"><label title="Select to assess forest and soil carbon within your area of interest" id="carbonCheckLabel">Assess <a id="carbonCheckLink" href='coreConcepts_carbon.html' onClick='return windowPopup(this, "notes")'>Carbon Data</a>?</label>
          </div>
          <div style="display: table;">
            <input id="nationalStateCheck"  type="checkbox" title="Select to evaluate your AOI against the TNC Customized RCN data"><label title="Select to evaluate your AOI against the TNC Customized RCN data" id="nationalStateCheckLabel">Assess <a id="nationalStateCheckLink" href='coreConcepts_nationalState.html' onClick='return windowPopup(this, "notes")'>TNC Customized RCN</a>?</label>
          </div>
        </div>
        <div class="map-service-options">
            <form name="resDataForm" class = "resDataForm" >

                    <h2 style="text-align: center">Visualize</h2>
                    <div class="centerDiv">
                        <div class="onoffswitch">
                            <input type="checkbox" name="onoffswitch"  class="onoffswitch-checkbox" id="regionSwitch" tabindex="0" >
                            <label class="onoffswitch-label" for="regionSwitch" title="Toggle between the nationally-consistent data or the TNC Customized RCN">
                                <span class="onoffswitch-inner"></span>
                                <span class="onoffswitch-switch"></span>
                            </label>
                        </div>
                    </div>

                    <Input type="radio" Name="r1" Value="resil" id = "r1_resil" ><a href='coreConcepts_resScore.html' onClick='return windowPopup(this, "notes")'>Resilient Sites</a><br>
                    <Input type="radio" Name="r1" Value="cliFlow" id = "r1_cliFlow" ><a href='coreConcepts_cliFlow.html' onClick='return windowPopup(this, "notes")'>Connectivity and Climate Flow (Continuous)</a><br>
                    <Input type="radio" Name="r1" Value="cliFlowCat" id = "r1_cliFlowCat" style="display: hidden"><a href='coreConcepts_cliFlowCat.html' onClick='return windowPopup(this, "notes")'>Connectivity and Climate Flow (Categorical)</a><br>
                    <Input type="radio" Name="r1" Value="rbvSingle" id = "r1_rbvSingle" style="display: hidden"><a href='coreConcepts_rbv.html' onClick='return windowPopup(this, "notes")'>Recognized Biodiversity Value</a><br>
                    <Input type="radio" Name="r1" Value="resConnSimp" id = "r1_resConnSimp" ><a href='coreConcepts_resConnSimp.html' onClick='return windowPopup(this, "notes")'>Resilient and Connected Network (Simple)</a><br>
                    <hr>
                    <h3 style="text-align: center">Explore Component Data</h3>
                    <p class="collapsible" title="Expand to see the component data that went into the resilience scores.">Resilient & Connected Network</p>
                    <div class="collapseContent">
                         <Input type="radio" Name="r1" Value="resConnDet" id = "r1_resConnDet" ><a href='coreConcepts_resConnDet.html' onClick='return windowPopup(this, "notes")'>Resilient and Connected Network (Detail)</a>
                        <br>
                    </div>
                    <p class="collapsible" title="Expand to see the component data that went into the resilience scores.">Resilient Sites</p>

                    <div class="collapseContent">
                        <Input type="radio" Name="r1" Value="landDiv" id = "r1_LD" ><a href='coreConcepts_LD.html' onClick='return windowPopup(this, "notes")'>Landscape Diversity</a>
                        <br>
                        <Input type="radio" Name="r1" Value="localConn" id = "r1_LC" ><a href='coreConcepts_LC.html' onClick='return windowPopup(this, "notes")'>Local Connectedness</a>
                        <br>
                        <Input type="radio" Name="r1" Value="geo" id = "r1_geo" ><a href='coreConcepts_geoSoils.html' onClick='return windowPopup(this, "notes")'>Geology and Soils</a>
                        <br>
                        <Input type="radio" Name="r1" Value="elev" id = "r1_elev" ><a href='coreConcepts_elev.html' onClick='return windowPopup(this, "notes")'>Elevation</a>
                        <br>
                        <Input type="radio" Name="r1" Value="landform" id = "r1_landforms" ><a href='coreConcepts_landforms.html' onClick='return windowPopup(this, "notes")'>Landforms</a>
                        <br>
                        <Input type="radio" Name="r1" Value="tidalMig" id = "r1_tidalHabMig" ><a href='coreConcepts_coastalMig.html' onClick='return windowPopup(this, "notes")'>Migration Space for Tidal Habitat</a>
                        <br>

                        <br>
                    </div>

<!--                    <p class="collapsible" title="Expand to see the component data that went into the climate flow.">Connectivity and Climate Flow</p>
                    <div class="collapseContent">
                        <Input type="radio" Name="r1" Value="cliFlow" id = "r1_cliFlow" ><a href='coreConcepts_cliFlow.html' onClick='return windowPopup(this, "notes")'>Connectivity and Climate Flow (Continuous)</a>
                        <br>
                        <br>
                    </div>-->

                    <p class="collapsible" title="Expand to see the recognized biodiversity layers that went into the RCN.">Recognized Biodiversity Value</p>
                    <div class="collapseContent">
                        <Input type="radio" Name="r1" Value="rbvCat" id = "r1_rbvCat" style="display: hidden"><a href='coreConcepts_rbv.html' onClick='return windowPopup(this, "notes")'>Recognized Biodiversity Value (Categories)</a><br>
                        <br>
                        <br>
                    </div>
                    <p class="collapsible" title="Expand to see the carbon data layers.">Carbon Estimates</p>
                    <div class="collapseContent">
                        <Input type="radio" Name="r1" Value="forestCarbon2010" id = "r1_forestCarbon2010" style="display: hidden"><a href='coreConcepts_carbon.html' onClick='return windowPopup(this, "notes")'>Forest Ecosystem Carbon (2010)</a><br>
                        <Input type="radio" Name="r1" Value="forestCarbon2050" id = "r1_forestCarbon2050" style="display: hidden"><a href='coreConcepts_carbon.html' onClick='return windowPopup(this, "notes")'>Forest Ecosystem Carbon (2050)</a><br>
                        <Input type="radio" Name="r1" Value="forestCarbonSeq" id = "r1_forestCarbonSeq" style="display: hidden"><a href='coreConcepts_carbon.html' onClick='return windowPopup(this, "notes")'>Potential Forest Ecosystem Carbon Sequestration (2010-2050)</a><br>
                        <Input type="radio" Name="r1" Value="forestType" id = "r1_forestType" style="display: hidden"><a href='coreConcepts_carbon.html' onClick='return windowPopup(this, "notes")'>Forest Types (2008)</a><br>
                        <Input type="radio" Name="r1" Value="soilCarbon" id = "r1_soilCarbon" style="display: hidden"><a href='coreConcepts_carbon.html' onClick='return windowPopup(this, "notes")'>Soil Organic Carbon</a><br>
                        <Input type="radio" Name="r1" Value="nlcd" id = "r1_nlcd" style="display: hidden"><a href='coreConcepts_carbon.html' onClick='return windowPopup(this, "notes")'>National Landcover Dataset (2019)</a><br>
                        <br>
                    </div>
<!--                     <p class="collapsible" title="Expand to see the intermediate combinations of data that went into the RCN.">Resilient and Connected Network </p>
                    <div class="collapseContent">
                        <p>Components</p>
                        <Input type="radio" Name="r1" Value="resSitesFlow" id = "r1_resSitesFlow" ><a href='coreConcepts_resSitesFlow.html' onClick='return windowPopup(this, "notes")'>Resilient Sites and Climate Flow</a>
                        <br>
                        <Input type="radio" Name="r1" Value="resSitesBiodiv" id = "r1_resSitesBiodiv" ><a href='coreConcepts_resSitesBiodiv.html' onClick='return windowPopup(this, "notes")'>Resilient Sites and Recognized Biodiversity </a>
                        <br>
                        <Input type="radio" Name="r1" Value="resConnNoCat" id = "r1_resConnNoCat" ><a href='coreConcepts_resConnNoCat.html' onClick='return windowPopup(this, "notes")'>Resilient and Connected Network (no categories)</a>

                        <p>Add-Ins</p>
                        <Input type="radio" Name="r1" Value="highResFlow" id = "r1_highResFlow" ><a href='coreConcepts_highResFlow.html' onClick='return windowPopup(this, "notes")'>High combined resilience and flow</a>
                        <br>
                        <Input type="radio" Name="r1" Value="vHighResFlow" id = "r1_vHighResFlow" ><a href='coreConcepts_vHighResFlow.html' onClick='return windowPopup(this, "notes")'>Very high resilience </a>
                        <br>
                        <Input type="radio" Name="r1" Value="avResHighFlow" id = "r1_avResHighFlow" ><a href='coreConcepts_avResHighFlow.html' onClick='return windowPopup(this, "notes")'>High flow, Avg. resilience</a>
                        <br>
                        <br>
                    </div>-->

                    <p style="margin-bottom:2px">Reference Layers </p>
                    <div >
                        <Input type="radio" Name="r1" Value="region" id = "r1_region" style="display: hidden"><a href='coreConcepts_regions.html' onClick='return windowPopup(this, "notes")'>Study Regions</a><br>

                        <Input type="radio" Name="r1" Value="base" id = "r1_base" >Basemap
                        <br>
                        <input id="ecoregionsCheck" type="checkbox" title="Overlay the ecoregional boundaries used in the stratification" checked><a href='coreConcepts_ecoregions.html' onClick='return windowPopup(this, "notes")'>Ecoregions</a>
                        <br>
                        <input id="statesCheck" type="checkbox" title="Overlay state boundaries"><a href='coreConcepts_states.html' onClick='return windowPopup(this, "notes")'>States  </a>
                        <br>
                        <input id="securedCheck" type="checkbox" title="Zoom in to overlay secured areas"><label title="Zoom in to overlay secured areas" id="securedCheckLabel"><a id="securedCheckLink" href='coreConcepts_securedAreas.html' onClick='return windowPopup(this, "notes")'>Secured Areas</a> </label> <input type="range" id ="secTransp" name="secTransp" class="smallSlider" min="0" max="100" value = "75" title="Slide to set the transparency of conserved lands." />

                    </div>

            </form >
            <br><br>
            <label>Set Transparency</label>
            <input type="range" id ="transp" name="transp" class="slider" min="0" max="100" value = "100" title="Slide to set the transparency of all layers." />
            <br><br>
            <button style="margin-bottom:5px" id="dataDownload" onclick="window.open('http://www.conservationgateway.org/ConservationPractices/ClimateChange/Pages/Climate-Resilience.aspx', '_blank')">Download Data</button>


        </div>
        <div id="legendDiv" class="legend-div"></div>
        <div id="legendJPEG" style="display: none">
        	<img id="legendImg" alt="Geophysical settings legend" src="assets/Settings_legend.jpg" style="height: auto; width:80%;" class="imgCenter"/>
        </div>
		<hr>
    	<div id="userMapServDiv">
        	<div id = "userMapServiceHolder"><input id="userMapServ" style="width:260px; margin-bottom: 3px; text-align: right;" placeholder="Enter a URL for an ArcGIS Map Service" type="text" /></div>
        	<button id="addMapServButton" >Add Map Service</button>
        	<button id="removeMapServButton" >Remove Map Service</button>
          <input type="range" id ="userLayerTransp" name="userLayerTransp" class="slider" min="0" max="100" value = "100" title="Slide to set the transparency of user-added layer." />
        </div>
    </div>

    <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'" >
    	<div id="search"></div>
    	<!-- <div id="BasemapToggle"></div> -->

    	<div data-dojo-type="dijit/TitlePane"  id="basemapGalleryDiv"
             data-dojo-props="title:'Select Basemap', closable:false, open:false">
          <div data-dojo-type="dijit/layout/ContentPane" style="width:380px; height:280px; overflow:auto;">
            <div id="basemapGallery"></div>
          </div>
        </div>

        <div id="LocateButton"></div>


        <div id="disclosures">
            <a id="indigLink" href="coreConcepts_indigenous.html" target="_blank">Indigenous Lands</a>
            <br>
            <a href="http://www.nature.org/about-us/governance/terms-of-use/index.htm?src=f9" target="_blank">Legal Disclosure</a>
            <a href="http://www.nature.org/about-us/governance/privacy-policy.xml?src=f6" target="_blank">Privacy Statement</a>
        </div>
    </div>
    </div>
</body>
</html>
